{% extends "base.html" %}

{% block title %}{{ topic.name }} - Teacher Platform{% endblock %}

{% block extra_css %}
<style>
  .topic-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 1.25rem;
  }

  .topic-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .topic-nav {
    display: flex;
    gap: 1rem;
    margin-top: 1.25rem;
    flex-wrap: wrap;
  }

  .topic-nav a {
    padding: 0.75rem 1.5rem;
    background: white;
    color: #667eea;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s;
  }

  .topic-nav a:hover:not(.disabled) {
    background: #f0f4ff;
    transform: translateY(-1px);
  }

  .topic-nav a.disabled {
    background: #e2e8f0;
    color: #94a3b8;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Dropdown Menu */
  .dropdown {
    position: relative;
    display: inline-block;
  }
  .dropdown-btn {
    padding: 0.75rem 1.5rem;
    background: white;
    color: #667eea;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 700;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
  }
  .dropdown-btn:hover {
    background: #f0f4ff;
  }
  .dropdown-btn.slides { background: #667eea; color: white; }
  .dropdown-btn.games { background: #ec4899; color: white; }
  .dropdown-btn.activities { background: #06b6d4; color: white; }
  .dropdown-btn.disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    min-width: 200px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border-radius: 8px;
    z-index: 100;
    margin-top: 4px;
    overflow: hidden;
  }
  .dropdown:hover .dropdown-content,
  .dropdown-content:hover {
    display: block;
  }
  .dropdown-content a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: #334155;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.15s;
    border-radius: 0;
    background: white;
  }
  .dropdown-content a:hover {
    background: #f1f5f9;
  }
  .dropdown-content a.disabled {
    color: #94a3b8;
    pointer-events: none;
  }
  .dropdown-divider {
    height: 1px;
    background: #e2e8f0;
    margin: 0.25rem 0;
  }

  .panel {
    background: white;
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .muted {
    color: #718096;
    font-size: 0.9rem;
  }

  .btnrow {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }

  .btn2 {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.08);
    background: #667eea;
    color: white;
    cursor:pointer;
    font-weight: 800;
    text-decoration:none;
  }
  .btn2:hover { filter: brightness(0.98); }
  .btn2.secondary { background:#0ea5e9; }
  .btn2.green { background:#10b981; }
  .btn2.orange { background:#f59e0b; }
  .btn2.gray { background:#64748b; }
  .btn2.danger { background:#ef4444; }

  .btn2:disabled {
    opacity: 0.55;
    cursor:not-allowed;
  }

  .statusbar{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    background:#f8fafc;
    border:1px solid #e2e8f0;
    font-size: 0.95rem;
    display:none;
  }
  .statusbar.show{ display:block; }

  /* Modal Overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.show {
    display: flex;
  }

  /* Modal Box */
  .modal-box {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  .modal-box h3 {
    margin: 0 0 1rem;
    font-size: 1.25rem;
    color: #1e293b;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  /* Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .modal-box p {
    margin: 0.5rem 0;
    color: #475569;
    font-size: 0.95rem;
  }

  .modal-box .hint {
    color: #94a3b8;
    font-size: 0.85rem;
    margin-top: 1rem;
  }

  /* Badge for disabled buttons */
  .nav-badge {
    font-size: 0.7rem;
    background: #fbbf24;
    color: #1e293b;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 6px;
  }
</style>
{% endblock %}

{% block content %}
<div class="topic-header">
  <h1>{{ topic.name }}</h1>
  <p>{{ topic.description or 'No description' }}</p>

  <div class="topic-nav">
    <!-- Slides Dropdown -->
    <div class="dropdown">
      <button class="dropdown-btn slides">üé¨ Slides ‚ñº</button>
      <div class="dropdown-content">
        <a href="{{ url_for('view_slides', topic_id=topic.id) }}">üëÅÔ∏è View Slides</a>
        {% if is_owner or is_admin %}
        <a href="{{ url_for('edit_slides', topic_id=topic.id) }}">‚úèÔ∏è Edit Slides</a>
        {% endif %}
        {% if has_slides %}
        <div class="dropdown-divider"></div>
        <a href="{{ url_for('download_slides_pdf', topic_id=topic.id) }}">üì• Download PDF</a>
        {% endif %}
        {% if topic.pdf_file %}
        <a href="{{ url_for('uploaded_file', filename=topic.pdf_file) }}" target="_blank">üìÑ View Original PDF</a>
        {% endif %}
      </div>
    </div>
    
    <!-- Games Dropdown -->
    <div class="dropdown">
      <button class="dropdown-btn games {% if not has_game %}disabled{% endif %}">üéÆ Games ‚ñº</button>
      <div class="dropdown-content">
        {% if has_game %}
        <a href="{{ url_for('game', topic_id=topic.id) }}">üéØ Bamboozle</a>
        <a href="{{ url_for('game_memory', topic_id=topic.id) }}">üÉè Memory Match</a>
        <a href="{{ url_for('game_sentence_builder', topic_id=topic.id) }}">üèóÔ∏è Sentence Builder</a>
        {% if has_practice %}
        <a href="{{ url_for('game_millionaire', topic_id=topic.id) }}">üèÜ Millionaire</a>
        {% endif %}
        {% else %}
        <a class="disabled">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Generate Game ‡∏Å‡πà‡∏≠‡∏ô</a>
        {% endif %}
      </div>
    </div>
    
    <!-- Activities Dropdown -->
    <div class="dropdown">
      <button class="dropdown-btn activities {% if not has_practice %}disabled{% endif %}">üìù Activities ‚ñº</button>
      <div class="dropdown-content">
        {% if has_practice %}
        <a href="{{ url_for('practice', topic_id=topic.id) }}">üìù Multiple Choice (MCQ)</a>
        <a href="{{ url_for('practice_fill_blanks', topic_id=topic.id) }}">‚úçÔ∏è Fill in the Blanks</a>
        <a href="{{ url_for('practice_unscramble', topic_id=topic.id) }}">üîÄ Sentence Unscramble</a>
        <div class="dropdown-divider"></div>
        <a href="{{ url_for('practice_all_scores', topic_id=topic.id) }}">üìä View All Scores</a>
        {% else %}
        <a class="disabled">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Generate Practice ‡∏Å‡πà‡∏≠‡∏ô</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="panel">
  <h3 style="margin:0 0 6px;">About this topic</h3>
  <div class="muted">
    Type: {{ topic.topic_type }} |
    Created: {{ (topic.created_at or '')[:19].replace('T',' ') }}
  </div>

  <div style="margin-top:10px;">
    <strong>PDF:</strong>
    {% if topic.pdf_file %}
      <span class="muted">{{ topic.pdf_file }}</span>
      <a class="btn2 gray" style="margin-left:10px;" href="{{ url_for('uploaded_file', filename=topic.pdf_file) }}" target="_blank">üìÑ Open PDF</a>
    {% else %}
      <span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ PDF (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ Generate ‡∏à‡∏≤‡∏Å PDF ‡πÑ‡∏î‡πâ)</span>
    {% endif %}
  </div>
</div>

{% if is_owner or is_admin %}
<div class="panel">
  <h3 style="margin:0 0 8px;">‚öôÔ∏è Manage</h3>

  <div class="btnrow">
    <a class="btn2 gray" href="{{ url_for('my_edit_topic', topic_id=topic.id) }}">‚úèÔ∏è Edit Topic</a>

    <form method="POST" action="{{ url_for('my_delete_topic', topic_id=topic.id) }}"
          onsubmit="return confirm('Delete this topic? (will remove slides/game/practice)');" style="margin:0;">
      <button class="btn2 danger" type="submit">üóë Delete</button>
    </form>
  </div>

  <hr style="margin:14px 0; border:none; border-top:1px solid #e2e8f0;">

  <div class="muted" style="margin-bottom:8px;">
    Generate Game/Practice from PDF (‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
  </div>

  <div class="btnrow">
    <button class="btn2 green" id="btnGenAll" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      ‚ú® Generate All
    </button>
    <button class="btn2 secondary" id="btnGenGame" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      üéÆ Generate Game
    </button>
    <button class="btn2 orange" id="btnGenPractice" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      üìù Generate Practice
    </button>
  </div>

  <div id="statusbar" class="statusbar"></div>
</div>
{% endif %}

<!-- Modal Popup -->
<div class="modal-overlay" id="generatingModal">
  <div class="modal-box">
    <h3>‚è≥ Generating Lesson</h3>
    <div class="spinner"></div>
    <p id="modalMessage">Generating Game + Practice from PDF...</p>
    <p class="hint">‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
  </div>
</div>

<script>
  const topicId = {{ topic.id }};
  const hasPdf = {{ 1 if topic.pdf_file else 0 }};
  const statusbar = document.getElementById('statusbar');
  const modal = document.getElementById('generatingModal');
  const modalMessage = document.getElementById('modalMessage');

  function setStatus(msg){
    statusbar.textContent = msg;
    statusbar.classList.add('show');
  }

  function showModal(mode) {
    let message = 'Generating Game + Practice from PDF...';
    if (mode === 'game') {
      message = 'Generating Game from PDF...';
    } else if (mode === 'practice') {
      message = 'Generating Practice from PDF...';
    }
    modalMessage.textContent = message;
    modal.classList.add('show');
  }

  function hideModal() {
    modal.classList.remove('show');
  }

  async function readJsonSafely(res){
    const ct = (res.headers.get('content-type') || '').toLowerCase();

    if(!ct.includes('application/json')){
      const text = await res.text();
      const preview = (text || '').slice(0, 200);
      throw new Error(`Server returned non-JSON (status ${res.status}). Preview: ${preview}`);
    }

    const data = await res.json();
    return data;
  }

  async function callGenerate(mode){
    if(!hasPdf){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ PDF ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }

    const ok = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Generate (${mode}) ‡∏à‡∏≤‡∏Å PDF?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°`);
    if(!ok) return;

    const buttons = [
      document.getElementById('btnGenAll'),
      document.getElementById('btnGenGame'),
      document.getElementById('btnGenPractice')
    ];
    buttons.forEach(b => { if(b) b.disabled = true; });

    // Show modal popup
    showModal(mode);

    try{
      setStatus('‚è≥ Generating... (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF)');

      const res = await fetch(`/api/topic/${topicId}/generate`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ mode })
      });

      const data = await readJsonSafely(res);

      if(!res.ok || data.ok === false){
        const msg = (data && (data.error || data.message)) || 'Generate failed';
        hideModal();
        alert(msg);
        setStatus('‚ùå Generate failed: ' + msg);
        return;
      }

      setStatus('‚úÖ Generated successfully!');
      hideModal();

      if(mode === 'game'){
        window.location.href = `/topic/${topicId}/game`;
      }else if(mode === 'practice'){
        window.location.href = `/topic/${topicId}/practice`;
      }else{
        // Reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
        window.location.reload();
      }

    }catch(err){
      hideModal();
      alert('Error: ' + (err && err.message ? err.message : err));
      setStatus('‚ùå Error: ' + (err && err.message ? err.message : err));
      console.error(err);
    }finally{
      buttons.forEach(b => { if(b) b.disabled = false; });
    }
  }

  const btnAll = document.getElementById('btnGenAll');
  const btnGame = document.getElementById('btnGenGame');
  const btnPractice = document.getElementById('btnGenPractice');

  if(btnAll) btnAll.addEventListener('click', () => callGenerate('all'));
  if(btnGame) btnGame.addEventListener('click', () => callGenerate('game'));
  if(btnPractice) btnPractice.addEventListener('click', () => callGenerate('practice'));
</script>
{% endblock %}
