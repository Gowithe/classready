{% extends "base.html" %}

{% block title %}{{ topic.name }} - Teacher Platform{% endblock %}

{% block extra_css %}
<style>
  .topic-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 1.25rem;
  }

  .topic-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .topic-nav {
    display: flex;
    gap: 1rem;
    margin-top: 1.25rem;
    flex-wrap: wrap;
  }

  .topic-nav a {
    padding: 0.75rem 1.5rem;
    background: white;
    color: #667eea;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s;
  }

  .topic-nav a:hover:not(.disabled) {
    background: #f0f4ff;
    transform: translateY(-1px);
  }

  .topic-nav a.disabled {
    background: #e2e8f0;
    color: #94a3b8;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Dropdown Menu */
  .dropdown {
    position: relative;
    display: inline-block;
  }
  .dropdown-btn {
    padding: 0.75rem 1.5rem;
    background: white;
    color: #667eea;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 700;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
  }
  .dropdown-btn:hover {
    background: #f0f4ff;
  }
  .dropdown-btn.slides { background: #667eea; color: white; }
  .dropdown-btn.games { background: #ec4899; color: white; }
  .dropdown-btn.activities { background: #06b6d4; color: white; }
  .dropdown-btn.disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
  
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    min-width: 260px; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border-radius: 8px;
    z-index: 100;
    margin-top: 4px;
    overflow: hidden;
  }
  .dropdown.open .dropdown-content{
    display:block;
  }
  /* Optional: allow keyboard focus to keep menu open */
  .dropdown:focus-within .dropdown-content{
    display:block;
  }
  
  .dropdown-content a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: #334155;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.15s;
    border-radius: 0;
    background: white;
    white-space: nowrap; /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  }
  
  .dropdown-content a:hover {
    background: #f1f5f9;
  }
  .dropdown-content a.disabled {
    color: #94a3b8;
    pointer-events: none;
  }
  .dropdown-divider {
    height: 1px;
    background: #e2e8f0;
    margin: 0.25rem 0;
  }

  .panel {
    background: white;
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .muted {
    color: #718096;
    font-size: 0.9rem;
  }

  .btnrow {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }

  .btn2 {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.08);
    background: #667eea;
    color: white;
    cursor:pointer;
    font-weight: 800;
    text-decoration:none;
  }
  .btn2:hover { filter: brightness(0.98); }
  .btn2.primary { background:#667eea; }
  .btn2.secondary { background:#0ea5e9; }
  .btn2.green { background:#10b981; }
  .btn2.orange { background:#f59e0b; }
  .btn2.gray { background:#64748b; }
  .btn2.danger { background:#ef4444; }

  .btn2:disabled {
    opacity: 0.55;
    cursor:not-allowed;
  }

  .statusbar{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    background:#f8fafc;
    border:1px solid #e2e8f0;
    font-size: 0.95rem;
    display:none;
  }
  .statusbar.show{ display:block; }

  /* Modal Overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.show {
    display: flex;
  }

  /* Modal Box */
  .modal-box {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  .modal-box h3 {
    margin: 0 0 1rem;
    font-size: 1.25rem;
    color: #1e293b;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  /* Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .modal-box p {
    margin: 0.5rem 0;
    color: #475569;
    font-size: 0.95rem;
  }

  .modal-box .hint {
    color: #94a3b8;
    font-size: 0.85rem;
    margin-top: 1rem;
  }

  /* QR Code Modal */
  .qr-modal-box {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    max-width: 700px;
    width: 95%;
    max-height: 90vh;
    overflow: hidden;
  }
  .qr-modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .qr-modal-header h3 { margin: 0; font-size: 1.2rem; }
  .qr-modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
  }
  .qr-modal-body {
    padding: 1.5rem;
    max-height: calc(90vh - 80px);
    overflow-y: auto;
  }
  .qr-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
  }
  .qr-tab {
    padding: 0.6rem 1.2rem;
    border: none;
    background: #f1f5f9;
    border-radius: 8px 8px 0 0;
    font-weight: 700;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s;
  }
  .qr-tab:hover { background: #e2e8f0; }
  .qr-tab.active {
    background: #667eea;
    color: white;
  }
  .qr-content {
    display: none;
    text-align: center;
  }
  .qr-content.active { display: block; }
  .qr-image {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    display: inline-block;
    margin-bottom: 1rem;
  }
  .qr-image img {
    width: 200px;
    height: 200px;
  }
  .qr-url {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-family: monospace;
    font-size: 0.85rem;
    word-break: break-all;
    margin-bottom: 1rem;
    color: #475569;
  }
  .qr-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .qr-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
  }
  .qr-btn-copy { background: #667eea; color: white; }
  .qr-btn-copy:hover { background: #5a67d8; }
  .qr-btn-download { background: #10b981; color: white; }
  .qr-btn-download:hover { background: #059669; }
  .qr-btn-open { background: #f59e0b; color: white; }
  .qr-btn-open:hover { background: #d97706; }
  .qr-tip {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #fef3c7;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #92400e;
  }
  .copy-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #1e293b;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    z-index: 2000;
    display: none;
  }
  .copy-toast.show { display: block; animation: fadeInUp 0.3s ease; }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateX(-50%) translateY(10px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }
</style>
{% endblock %}

{% block content %}
<div class="topic-header">
  <h1>{{ topic.name }}</h1>
  <p>{{ topic.description or 'No description' }}</p>

  <div class="topic-nav">
    <div class="dropdown">
      <button class="dropdown-btn slides">üé¨ Slides ‚ñº</button>
      <div class="dropdown-content">
        <a href="{{ url_for('view_slides', topic_id=topic.id) }}">üëÅÔ∏è View Slides</a>
        {% if is_owner or is_admin %}
        <a href="{{ url_for('edit_slides', topic_id=topic.id) }}">‚úèÔ∏è Edit Slides</a>
        {% endif %}
        {% if has_slides %}
        <div class="dropdown-divider"></div>
        <a href="{{ url_for('download_slides_pdf', topic_id=topic.id) }}">üì• Download PDF</a>
        {% endif %}
        {% if topic.pdf_file %}
        <a href="{{ url_for('uploaded_file', filename=topic.pdf_file) }}" target="_blank">üìÑ View Original PDF</a>
        {% endif %}
      </div>
    </div>
    
    <div class="dropdown">
      <button class="dropdown-btn games {% if not has_game %}disabled{% endif %}">üéÆ Games ‚ñº</button>
      <div class="dropdown-content">
        {% if has_game %}
        <a href="{{ url_for('game', topic_id=topic.id) }}">üéØ Bamboozle</a>
        <a href="{{ url_for('game_memory', topic_id=topic.id) }}">üÉè Memory Match</a>
        <a href="{{ url_for('game_sentence_builder', topic_id=topic.id) }}">üèóÔ∏è Sentence Builder</a>
        {% if has_practice %}
        <a href="{{ url_for('game_millionaire', topic_id=topic.id) }}">üèÜ Millionaire</a>
        {% endif %}
        {% else %}
        <a class="disabled">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Generate Game ‡∏Å‡πà‡∏≠‡∏ô</a>
        {% endif %}
      </div>
    </div>
    
    <div class="dropdown">
      <button class="dropdown-btn activities {% if not has_practice %}disabled{% endif %}">üìù Activities ‚ñº</button>
      <div class="dropdown-content">
        {% if has_practice %}
        <a href="{{ url_for('practice', topic_id=topic.id) }}">üìù Multiple Choice (MCQ)</a>
        <a href="{{ url_for('practice_fill_blanks', topic_id=topic.id) }}">‚úçÔ∏è Fill in the Blanks</a>
        <a href="{{ url_for('practice_unscramble', topic_id=topic.id) }}">üîÄ Sentence Unscramble</a>
        <div class="dropdown-divider"></div>
        <a href="javascript:void(0)" onclick="openQRModal()">üì± QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
        <a href="{{ url_for('practice_all_scores', topic_id=topic.id) }}">üìä View All Scores</a>
        {% else %}
        <a class="disabled">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Generate Practice ‡∏Å‡πà‡∏≠‡∏ô</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="panel">
  <h3 style="margin:0 0 6px;">About this topic</h3>
  <div class="muted">
    Type: {{ topic.topic_type }} |
    Created: {{ (topic.created_at or '')[:19].replace('T',' ') }}
  </div>

  <div style="margin-top:10px;">
    <strong>PDF:</strong>
    {% if topic.pdf_file %}
      <span class="muted">{{ topic.pdf_file }}</span>
      <a class="btn2 gray" style="margin-left:10px;" href="{{ url_for('uploaded_file', filename=topic.pdf_file) }}" target="_blank">üìÑ Open PDF</a>
    {% else %}
      <span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ PDF (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ Generate ‡∏à‡∏≤‡∏Å PDF ‡πÑ‡∏î‡πâ)</span>
    {% endif %}
  </div>
</div>

{% if is_owner or is_admin %}
<div class="panel">
  <h3 style="margin:0 0 8px;">‚öôÔ∏è Manage</h3>

  <div class="btnrow">
    <a class="btn2 gray" href="{{ url_for('my_edit_topic', topic_id=topic.id) }}">‚úèÔ∏è Edit Topic</a>

    <form method="POST" action="{{ url_for('my_delete_topic', topic_id=topic.id) }}"
          onsubmit="return confirm('Delete this topic? (will remove slides/game/practice)');" style="margin:0;">
      <button class="btn2 danger" type="submit">üóë Delete</button>
    </form>
  </div>

  <hr style="margin:14px 0; border:none; border-top:1px solid #e2e8f0;">

  <div class="muted" style="margin-bottom:8px;">
    Generate Content from PDF (‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
  </div>

  <div class="btnrow">
    <button class="btn2 green" id="btnGenAll" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      ‚ú® Generate All
    </button>
    
    <button class="btn2 primary" id="btnGenSlides" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      üìΩÔ∏è Generate Slides
    </button>

    <button class="btn2 secondary" id="btnGenGame" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      üéÆ Generate Game
    </button>
    
    <button class="btn2 orange" id="btnGenPractice" type="button" {% if not topic.pdf_file %}disabled{% endif %}>
      üìù Generate Practice
    </button>
  </div>

  <div id="statusbar" class="statusbar"></div>
</div>
{% endif %}

<div class="modal-overlay" id="generatingModal">
  <div class="modal-box">
    <h3>‚è≥ Generating Lesson</h3>
    <div class="spinner"></div>
    <p id="modalMessage">Generating content from PDF...</p>
    <p class="hint">‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal-overlay" id="qrModal">
  <div class="qr-modal-box">
    <div class="qr-modal-header">
      <h3>üì± QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
      <button class="qr-modal-close" onclick="closeQRModal()">‚úï</button>
    </div>
    <div class="qr-modal-body">
      <div class="qr-tabs">
        <button class="qr-tab active" onclick="switchQRTab('mcq')">üìù MCQ</button>
        <button class="qr-tab" onclick="switchQRTab('fill')">‚úçÔ∏è Fill Blanks</button>
        <button class="qr-tab" onclick="switchQRTab('unscramble')">üîÄ Unscramble</button>
      </div>
      
      <div class="qr-content active" id="qr-mcq">
        <div class="qr-image">
          <img id="qr-img-mcq" src="" alt="QR Code MCQ">
        </div>
        <div class="qr-url" id="qr-url-mcq"></div>
        <div class="qr-actions">
          <button class="qr-btn qr-btn-copy" onclick="copyURL('mcq')">üìã Copy Link</button>
          <button class="qr-btn qr-btn-download" onclick="downloadQR('mcq')">üíæ Download QR</button>
          <button class="qr-btn qr-btn-open" onclick="openURL('mcq')">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
        </div>
      </div>
      
      <div class="qr-content" id="qr-fill">
        <div class="qr-image">
          <img id="qr-img-fill" src="" alt="QR Code Fill Blanks">
        </div>
        <div class="qr-url" id="qr-url-fill"></div>
        <div class="qr-actions">
          <button class="qr-btn qr-btn-copy" onclick="copyURL('fill')">üìã Copy Link</button>
          <button class="qr-btn qr-btn-download" onclick="downloadQR('fill')">üíæ Download QR</button>
          <button class="qr-btn qr-btn-open" onclick="openURL('fill')">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
        </div>
      </div>
      
      <div class="qr-content" id="qr-unscramble">
        <div class="qr-image">
          <img id="qr-img-unscramble" src="" alt="QR Code Unscramble">
        </div>
        <div class="qr-url" id="qr-url-unscramble"></div>
        <div class="qr-actions">
          <button class="qr-btn qr-btn-copy" onclick="copyURL('unscramble')">üìã Copy Link</button>
          <button class="qr-btn qr-btn-download" onclick="downloadQR('unscramble')">üíæ Download QR</button>
          <button class="qr-btn qr-btn-open" onclick="openURL('unscramble')">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
        </div>
      </div>
      
      <div class="qr-tip">
        üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong> ‡∏â‡∏≤‡∏¢ QR Code ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î
      </div>
    </div>
  </div>
</div>

<div class="copy-toast" id="copyToast">‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!</div>

<script>
  // ---------------- Dropdown (click-to-toggle) ----------------
  (function(){
    const dropdowns = Array.from(document.querySelectorAll('.dropdown'));

    function syncAria(){
      dropdowns.forEach(d => {
        const btn = d.querySelector('.dropdown-btn');
        if(btn) btn.setAttribute('aria-expanded', d.classList.contains('open') ? 'true' : 'false');
      });
    }

    function closeAll(except){
      dropdowns.forEach(d => { if(d !== except) d.classList.remove('open'); });
      syncAria();
    }

    dropdowns.forEach((d, i) => {
      const btn = d.querySelector('.dropdown-btn');
      const menu = d.querySelector('.dropdown-content');
      if(!btn || !menu) return;

      const menuId = `dd_menu_${i}`;
      if(!menu.id) menu.id = menuId;
      btn.setAttribute('aria-haspopup', 'true');
      btn.setAttribute('aria-controls', menu.id);
      btn.setAttribute('aria-expanded', 'false');

      if(btn.classList.contains('disabled') || btn.disabled){
        return;
      }

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const willOpen = !d.classList.contains('open');
        closeAll(d);
        if(willOpen) d.classList.add('open');
        else d.classList.remove('open');
        syncAria();
      });

      menu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    document.addEventListener('click', () => closeAll(null));
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') closeAll(null);
    });

    syncAria();
  })();
  // ------------------------------------------------------------

  const topicId = {{ topic.id }};
  const hasPdf = {{ 1 if topic.pdf_file else 0 }};
  const statusbar = document.getElementById('statusbar');
  const modal = document.getElementById('generatingModal');
  const modalMessage = document.getElementById('modalMessage');

  function setStatus(msg){
    statusbar.textContent = msg;
    statusbar.classList.add('show');
  }

  function showModal(mode) {
    let message = 'Generating All Content from PDF...';
    if (mode === 'slides') message = 'Generating Slides from PDF...';
    else if (mode === 'game') message = 'Generating Game from PDF...';
    else if (mode === 'practice') message = 'Generating Practice from PDF...';
    
    modalMessage.textContent = message;
    modal.classList.add('show');
  }

  function hideModal() {
    modal.classList.remove('show');
  }

  async function readJsonSafely(res){
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    if(!ct.includes('application/json')){
      const text = await res.text();
      throw new Error(`Server returned non-JSON (status ${res.status}).`);
    }
    return await res.json();
  }

  async function callGenerate(mode){
    if(!hasPdf){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ PDF ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }

    const ok = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Generate (${mode}) ‡∏à‡∏≤‡∏Å PDF?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°`);
    if(!ok) return;

    const buttons = [
      document.getElementById('btnGenAll'),
      document.getElementById('btnGenSlides'),
      document.getElementById('btnGenGame'),
      document.getElementById('btnGenPractice')
    ];
    buttons.forEach(b => { if(b) b.disabled = true; });

    showModal(mode);

    try{
      setStatus('‚è≥ Generating... Please wait.');

      const res = await fetch(`/api/topic/${topicId}/generate`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ mode })
      });

      const data = await readJsonSafely(res);

      if(!res.ok || data.ok === false){
        const msg = (data && (data.error || data.message)) || 'Generate failed';
        hideModal();
        alert(msg);
        setStatus('‚ùå Generate failed: ' + msg);
        return;
      }

      setStatus('‚úÖ Generated successfully!');
      hideModal();

      if(mode === 'game'){
        window.location.href = `/topic/${topicId}/game`;
      }else if(mode === 'practice'){
        window.location.href = `/topic/${topicId}/practice`;
      }else if(mode === 'slides'){
        window.location.href = `/topic/${topicId}/slides`;
      }else{
        window.location.reload();
      }

    }catch(err){
      hideModal();
      alert('Error: ' + (err.message || err));
      setStatus('‚ùå Error: ' + (err.message || err));
      console.error(err);
    }finally{
      buttons.forEach(b => { if(b) b.disabled = false; });
    }
  }

  const btnAll = document.getElementById('btnGenAll');
  const btnSlides = document.getElementById('btnGenSlides');
  const btnGame = document.getElementById('btnGenGame');
  const btnPractice = document.getElementById('btnGenPractice');

  if(btnAll) btnAll.addEventListener('click', () => callGenerate('all'));
  if(btnSlides) btnSlides.addEventListener('click', () => callGenerate('slides'));
  if(btnGame) btnGame.addEventListener('click', () => callGenerate('game'));
  if(btnPractice) btnPractice.addEventListener('click', () => callGenerate('practice'));

  // ==================== QR Code Modal ====================
  const qrModal = document.getElementById('qrModal');
  const baseUrl = window.location.origin;
  
  // URLs for each exercise type
  const qrUrls = {
    mcq: `${baseUrl}/p/{{ topic.id }}/mcq`,
    fill: `${baseUrl}/p/{{ topic.id }}/fill`,
    unscramble: `${baseUrl}/p/{{ topic.id }}/unscramble`
  };
  
  function generateQRUrl(url) {
    return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
  }
  
  function openQRModal() {
    // Set QR images and URLs
    document.getElementById('qr-img-mcq').src = generateQRUrl(qrUrls.mcq);
    document.getElementById('qr-url-mcq').textContent = qrUrls.mcq;
    
    document.getElementById('qr-img-fill').src = generateQRUrl(qrUrls.fill);
    document.getElementById('qr-url-fill').textContent = qrUrls.fill;
    
    document.getElementById('qr-img-unscramble').src = generateQRUrl(qrUrls.unscramble);
    document.getElementById('qr-url-unscramble').textContent = qrUrls.unscramble;
    
    qrModal.classList.add('show');
  }
  
  function closeQRModal() {
    qrModal.classList.remove('show');
  }
  
  function switchQRTab(type) {
    // Update tabs
    document.querySelectorAll('.qr-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.qr-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`qr-${type}`).classList.add('active');
  }
  
  function copyURL(type) {
    const url = qrUrls[type];
    navigator.clipboard.writeText(url).then(() => {
      showToast();
    }).catch(() => {
      // Fallback
      const input = document.createElement('input');
      input.value = url;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      showToast();
    });
  }
  
  function showToast() {
    const toast = document.getElementById('copyToast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  }
  
  function downloadQR(type) {
    const url = generateQRUrl(qrUrls[type]);
    const link = document.createElement('a');
    link.href = url;
    link.download = `qr-${type}-topic-{{ topic.id }}.png`;
    link.click();
  }
  
  function openURL(type) {
    window.open(qrUrls[type], '_blank');
  }
  
  // Close modal on backdrop click
  qrModal.addEventListener('click', (e) => {
    if (e.target === qrModal) closeQRModal();
  });
  
  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && qrModal.classList.contains('show')) {
      closeQRModal();
    }
  });
</script>
{% endblock %}
