{% extends "base.html" %}
{% block title %}Fill in the Blanks | {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
  .wrap{max-width:1000px;margin:1.25rem auto;padding:0 1rem;}
  .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);}
  .h1{font-size:1.25rem;font-weight:900;margin-bottom:.25rem;}
  .muted{color:#64748b;font-size:.95rem;}
  
  .student-form{
    background: linear-gradient(135deg, #06b6d415, #0891b215);
    border:1px solid rgba(6,182,212,.2);
    border-radius:14px;
    padding:16px;
    margin-bottom:16px;
  }
  .student-form h3{margin:0 0 12px;font-size:1rem;color:#0e7490;}
  .form-grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
  @media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
  .form-group label{display:block;font-weight:800;font-size:.9rem;margin-bottom:4px;color:#334155;}
  .form-group select,.form-group input{width:100%;padding:.7rem .85rem;border-radius:10px;border:1px solid rgba(0,0,0,.15);outline:none;font-size:1rem;background:#fff;}
  .form-group select:focus,.form-group input:focus{border-color:#06b6d4;box-shadow: 0 0 0 3px rgba(6,182,212,.15);}
  .required{color:#ef4444;}
  
  .progress-bar{height:6px;background:#e2e8f0;border-radius:3px;margin-top:12px;overflow:hidden;}
  .progress-bar .fill{height:100%;background: linear-gradient(90deg, #06b6d4, #0891b2);transition: width .3s ease;}
  .progress-text{font-size:.85rem;color:#64748b;margin-top:6px;text-align:right;}
  
  .q{margin-top:14px;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f8fafc;transition: border-color .2s;}
  .q.answered{border-color:#22c55e;background:#f0fdf4;}
  .q strong{display:block;margin-bottom:10px;font-size:1.02rem;}
  
  .sentence-display{font-size:1.15rem;line-height:1.8;margin-bottom:1rem;text-align:center;padding:1rem;background:#fff;border-radius:10px;}
  .blank-slot{display:inline-block;min-width:80px;padding:.2rem .5rem;border-bottom:3px solid #06b6d4;background:#ecfeff;border-radius:6px 6px 0 0;font-weight:700;color:#0891b2;}
  .blank-slot.correct{background:#dcfce7;border-color:#22c55e;color:#166534;}
  .blank-slot.wrong{background:#fee2e2;border-color:#ef4444;color:#991b1b;}
  
  .choices{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
  .choice{padding:12px 18px;border-radius:12px;border:2px solid rgba(0,0,0,.08);background:#fff;cursor:pointer;transition: all .15s;font-weight:600;}
  .choice:hover:not(.disabled){border-color:#06b6d4;background:rgba(6,182,212,.04);}
  .choice.selected{border-color:#06b6d4;background:rgba(6,182,212,.08);}
  .choice.correct{border-color:#22c55e;background:#22c55e;color:#fff;}
  .choice.wrong{border-color:#ef4444;background:#ef4444;color:#fff;}
  .choice.disabled{opacity:.6;cursor:not-allowed;}
  
  .feedback{margin-top:8px;font-size:.9rem;padding:8px 10px;border-radius:8px;display:none;text-align:center;}
  .feedback.show{display:block;}
  .feedback.correct{background:#dcfce7;color:#166534;}
  .feedback.wrong{background:#fef2f2;color:#991b1b;}
  
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:0;border-radius:12px;padding:.85rem 1.5rem;font-weight:900;font-size:1rem;cursor:pointer;transition: all .2s;}
  .btn-primary{background: linear-gradient(135deg, #06b6d4, #0891b2);color:#fff;box-shadow: 0 4px 14px rgba(6,182,212,.35);}
  .btn-primary:hover{transform: translateY(-2px);}
  .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none;}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid rgba(0,0,0,.08);justify-content:center;}
  
  .result{margin-top:16px;padding:16px;border-radius:14px;display:none;text-align:center;}
  .result.show{display:block;}
  .result.success{background: linear-gradient(135deg, #dcfce7, #bbf7d0);border:1px solid #22c55e;}
  .result.fail{background: linear-gradient(135deg, #fef2f2, #fecaca);border:1px solid #ef4444;}
  .result h3{margin:0 0 8px;font-size:1.1rem;}
  .result .score{font-size:2.5rem;font-weight:900;margin:8px 0;}
  
  .manual-input{display:none;margin-top:8px;}
  .manual-input.show{display:block;}
  
  .sound-toggle{position:fixed;bottom:15px;right:15px;width:45px;height:45px;border-radius:50%;background:#06b6d4;color:#fff;border:none;font-size:1.3rem;cursor:pointer;box-shadow:0 4px 12px rgba(6,182,212,.4);}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="card">
    <div class="h1">‚úçÔ∏è Fill in the Blanks</div>
    <div class="muted">{{ topic.name }} ‚Ä¢ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>

    <div class="student-form">
      <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏Ç‡∏≤ <span class="required">*</span></label>
          <select id="classroomSelect" onchange="loadStudents()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            {% for cls in classrooms %}
            <option value="{{ cls.id }}" data-name="{{ cls.name }}">{{ cls.name }}</option>
            {% endfor %}
            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)</option>
          </select>
          <input type="text" id="classroomManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å">
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
          <select id="studentSelect">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
            <option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>
          </select>
          <input type="text" id="studentManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>
      </div>
    </div>

    <div class="progress-bar"><div class="fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß 0 / 0 ‡∏Ç‡πâ‡∏≠</div>

    <div id="questionsContainer"></div>

    <div class="bar">
      <button class="btn btn-primary" id="btnSubmit">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <div class="result" id="resultBox">
      <h3 id="resultTitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</h3>
      <div class="score" id="resultScore">0/0</div>
      <div class="muted" id="resultPercent">0%</div>
      <div id="resultMsg" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

<script>
const practiceData = {{ practice_data | tojson | safe }};
const token = "{{ token }}";

let soundEnabled = true;
let audioContext = null;
function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); return audioContext; }
function playTone(freq, dur, type = 'sine', vol = 0.3) {
  if (!soundEnabled) return;
  try { const ctx = initAudio(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = freq; osc.type = type;
    gain.gain.setValueAtTime(vol, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + dur);
  } catch (e) {}
}
function playCorrectSound() { playTone(523, 0.15); setTimeout(() => playTone(659, 0.15), 100); setTimeout(() => playTone(784, 0.2), 200); }
function playWrongSound() { playTone(200, 0.3, 'square', 0.15); }
function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá'; }

const classroomSelect = document.getElementById("classroomSelect");
const classroomManual = document.getElementById("classroomManual");
const studentSelect = document.getElementById("studentSelect");
const studentManual = document.getElementById("studentManual");

window.loadStudents = async function() {
  const cid = classroomSelect.value;
  if (cid === 'other') { classroomManual.classList.add('show'); studentSelect.value = 'other'; studentManual.classList.add('show'); return; }
  classroomManual.classList.remove('show');
  if (!cid) { studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option><option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>'; studentManual.classList.remove('show'); return; }
  try {
    const res = await fetch(`/api/public/classroom/${cid}/students`);
    const students = await res.json();
    let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>';
    students.forEach(s => { html += `<option value="${s.student_name}">${s.student_no ? s.student_no + '. ' : ''}${s.student_name}</option>`; });
    html += '<option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>';
    studentSelect.innerHTML = html;
    studentManual.classList.remove('show');
  } catch(e) { console.error(e); }
};
studentSelect.addEventListener('change', function() { if (this.value === 'other') { studentManual.classList.add('show'); studentManual.focus(); } else { studentManual.classList.remove('show'); } });

let questions = [];
let userAnswers = {};

function init() {
  questions = prepareQuestions();
  if (questions.length === 0) { document.getElementById('questionsContainer').innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ô‡∏µ‡πâ</p>'; return; }
  renderQuestions();
  updateProgress();
}

function prepareQuestions() {
  const result = [];
  if (practiceData.mcq_questions && practiceData.mcq_questions.length > 0) {
    practiceData.mcq_questions.forEach((q, i) => {
      if (q.prompt && q.choices && q.correct_answer) { result.push({ id: i, sentence: q.prompt, answer: q.correct_answer, choices: q.choices }); }
    });
  }
  if (practiceData.vocabulary && practiceData.vocabulary.length > 0) {
    practiceData.vocabulary.forEach((v, i) => {
      if (v.word && v.example) {
        const blank = v.example.replace(new RegExp('\\b' + v.word + '\\b', 'i'), '_____');
        if (blank !== v.example) { result.push({ id: 100 + i, sentence: blank, answer: v.word, choices: null }); }
      }
    });
  }
  for (let i = result.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [result[i], result[j]] = [result[j], result[i]]; }
  return result.slice(0, 15);
}

function generateChoices(q) {
  if (q.choices && q.choices.length >= 4) { const c = [...q.choices]; for (let i = c.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [c[i], c[j]] = [c[j], c[i]]; } return c; }
  const choices = [q.answer];
  const others = questions.map(x => x.answer).filter(a => a !== q.answer);
  for (let i = others.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [others[i], others[j]] = [others[j], others[i]]; }
  for (let i = 0; i < 3 && i < others.length; i++) { if (!choices.includes(others[i])) choices.push(others[i]); }
  const fillers = ['the', 'is', 'are', 'have', 'has', 'do', 'does'];
  while (choices.length < 4) { const f = fillers[Math.floor(Math.random() * fillers.length)]; if (!choices.includes(f)) choices.push(f); }
  for (let i = choices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [choices[i], choices[j]] = [choices[j], choices[i]]; }
  return choices.slice(0, 4);
}

function renderQuestions() {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = questions.map((q, idx) => {
    const choices = generateChoices(q);
    let displayText = q.sentence;
    if (!displayText.includes('_____')) { displayText = displayText + ` <span class="blank-slot" id="blank${q.id}">?</span>`; }
    else { displayText = displayText.replace('_____', `<span class="blank-slot" id="blank${q.id}">?</span>`); }
    return `<div class="q" id="q${q.id}" data-qid="${q.id}">
        <strong>${idx + 1}. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</strong>
        <div class="sentence-display">${displayText}</div>
        <div class="choices" id="choices${q.id}">${choices.map(c => `<div class="choice" data-answer="${escapeHtml(c)}" onclick="selectChoice(${q.id}, this, '${escapeHtml(c).replace(/'/g, "\\'")}')">${escapeHtml(c)}</div>`).join('')}</div>
        <div class="feedback" id="fb${q.id}"></div>
      </div>`;
  }).join('');
}

function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

function selectChoice(qid, el, answer) {
  if (document.getElementById('btnSubmit').disabled) return;
  playTone(400, 0.1, 'sine', 0.2);
  const container = document.getElementById('choices' + qid);
  container.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  userAnswers[qid] = answer;
  const blank = document.getElementById('blank' + qid);
  if (blank) blank.textContent = answer;
  document.getElementById('q' + qid).classList.add('answered');
  updateProgress();
}

function updateProgress() {
  const answered = Object.keys(userAnswers).length;
  const total = questions.length;
  document.getElementById('progressFill').style.width = (total > 0 ? answered / total * 100 : 0) + '%';
  document.getElementById('progressText').textContent = `‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${answered} / ${total} ‡∏Ç‡πâ‡∏≠`;
}

function getStudentInfo() {
  let classroom = classroomSelect.value === 'other' ? classroomManual.value.trim() : (classroomSelect.value ? (classroomSelect.options[classroomSelect.selectedIndex].dataset.name || classroomSelect.options[classroomSelect.selectedIndex].text) : '');
  let studentName = studentSelect.value === 'other' ? studentManual.value.trim() : studentSelect.value;
  return { classroom, studentName };
}

document.getElementById('btnSubmit').addEventListener('click', async () => {
  const { classroom, studentName } = getStudentInfo();
  if (!classroom) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á'); return; }
  if (!studentName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á'); return; }
  
  const unanswered = questions.length - Object.keys(userAnswers).length;
  if (unanswered > 0 && !confirm(`‡∏¢‡∏±‡∏á‡∏°‡∏µ ${unanswered} ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
  
  let score = 0;
  questions.forEach(q => {
    const userAns = userAnswers[q.id] || '';
    const isCorrect = userAns.toLowerCase().trim() === q.answer.toLowerCase().trim();
    const blank = document.getElementById('blank' + q.id);
    const fb = document.getElementById('fb' + q.id);
    const container = document.getElementById('choices' + q.id);
    container.querySelectorAll('.choice').forEach(c => { c.classList.add('disabled'); if (c.dataset.answer.toLowerCase().trim() === q.answer.toLowerCase().trim()) c.classList.add('correct'); });
    if (isCorrect) { score++; if (blank) blank.classList.add('correct'); fb.className = 'feedback show correct'; fb.innerHTML = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'; }
    else { playWrongSound(); if (blank) { blank.textContent = q.answer; blank.classList.add('wrong'); } const sel = container.querySelector('.choice.selected'); if (sel) sel.classList.add('wrong'); fb.className = 'feedback show wrong'; fb.innerHTML = `‚ùå ‡∏ú‡∏¥‡∏î ‚Äî ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: <strong>${q.answer}</strong>`; }
  });
  if (score > 0) playCorrectSound();
  
  try { await fetch(`/api/public/fill/${token}/submit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ student_name: studentName, student_no: "", classroom: classroom, score: score, total: questions.length, answers: userAnswers }) }); } catch (e) { console.error(e); }
  
  const pct = Math.round(score / questions.length * 100);
  const isPass = pct >= 50;
  const resultBox = document.getElementById('resultBox');
  resultBox.classList.add('show', isPass ? 'success' : 'fail');
  document.getElementById('resultTitle').textContent = isPass ? 'üéâ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!' : 'üí™ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!';
  document.getElementById('resultScore').textContent = `${score}/${questions.length}`;
  document.getElementById('resultPercent').textContent = `${pct}%`;
  document.getElementById('resultMsg').innerHTML = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
  
  document.querySelectorAll('select, input[type=text]').forEach(el => el.disabled = true);
  resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
  btnSubmit.innerHTML = '‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
});

init();
</script>
{% endblock %}
