{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
  <div>
    <h2 style="margin:0;">Dashboard</h2>
    <div style="color:#64748b;margin-top:6px;">
      {{ session.email }} ‚Ä¢
      <b>{{ (session.plan or 'free')|upper }}</b>
      {% if (session.plan or 'free') == 'free' %}
        <span style="margin-left:6px;color:#94a3b8;">(‡∏à‡∏≥‡∏Å‡∏±‡∏î 5 ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)</span>
      {% else %}
        <span style="margin-left:6px;color:#94a3b8;">(‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)</span>
      {% endif %}
    </div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ -->
    <a class="btn" href="{{ url_for('my_create_topic') }}">‚ûï Create Topic</a>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πÑ‡∏•‡∏î‡πå -->
    <a class="btn" href="{{ url_for('ai_slides') }}">ü§ñ Generate Slides (AI)</a>

    <!-- ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à -->
    <a class="btn" href="{{ url_for('pricing') }}">üí≥ Pricing</a>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Upgrade ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Free -->
    {% if (session.plan or 'free') == 'free' %}
      <a class="btn" href="{{ url_for('billing') }}" style="background:#111827;">üîí Upgrade (69‡∏ø)</a>
    {% endif %}

    <!-- ‚úÖ Admin -->
    {% if session.role == 'admin' %}
      <a class="btn" href="{{ url_for('admin_dashboard') }}">üõ† Admin</a>
    {% endif %}
  </div>
</div>

<hr style="margin:16px 0;">

<!-- =========================
     Recent Topics (‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
========================= -->
<h3 style="margin:0 0 8px;color:#4f46e5;">Recent Topics</h3>
<div style="height:2px;background:#4f46e5;opacity:.25;margin:0 0 14px;"></div>

{% if my_topics and my_topics|length > 0 %}
  <div style="display:grid;gap:10px;">
    {% for t in my_topics[:5] %}
      {% set tid = t.id if t.id is defined else t.get('id') %}
      {% set tname = t.name if t.name is defined else t.get('name') %}
      <div class="card" style="padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">{{ tname }}</div>
        <a class="btn" href="{{ url_for('topic_detail', topic_id=tid) }}">View</a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="card" style="padding:14px;color:#64748b;">
    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚Äî ‡∏Å‡∏î <b>Create Topic</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>Generate Slides (AI)</b> ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
  </div>
{% endif %}

<hr style="margin:18px 0;">

<!-- =========================
     All Topics (admin ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / teacher ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
========================= -->
<h3 style="margin:0 0 10px;">All Topics</h3>

{% if topics and topics|length > 0 %}
  <div style="overflow:auto;">
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">ID</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">Name</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">Type</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for topic in topics %}
          {% set tid = topic.id if topic.id is defined else topic.get('id') %}
          {% set tname = topic.name if topic.name is defined else topic.get('name') %}
          {% set ttype = topic.topic_type if topic.topic_type is defined else topic.get('topic_type') %}
          <tr>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ tid }}</td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">
              <b>{{ tname }}</b>
              <div style="color:#64748b;font-size:13px;margin-top:4px;">
                {{ topic.description if topic.description is defined else topic.get('description') }}
              </div>
            </td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">
              {{ ttype }}
            </td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">
              <a class="btn" href="{{ url_for('topic_detail', topic_id=tid) }}">üìå Open</a>
              <a class="btn" href="{{ url_for('view_slides', topic_id=tid) }}">üìΩ Slides</a>
              <a class="btn" href="{{ url_for('game', topic_id=tid) }}">üéÆ Game</a>
              <a class="btn" href="{{ url_for('practice', topic_id=tid) }}">üìù Practice</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="card" style="padding:14px;color:#64748b;">
    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
  </div>
{% endif %}

<hr style="margin:18px 0;">

<!-- =========================
     Recent Scores / History (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
========================= -->
<h3 style="margin:0 0 10px;">Recent Practice Attempts</h3>

{% if recent and recent|length > 0 %}
  <div style="overflow:auto;">
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">When</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">Topic</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">Score</th>
          <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;">%</th>
        </tr>
      </thead>
      <tbody>
        {% for r in recent %}
          {% set when = r.created_at if r.created_at is defined else r.get('created_at') %}
          {% set tname = r.topic_name if r.topic_name is defined else r.get('topic_name') %}
          {% set score = r.score if r.score is defined else r.get('score') %}
          {% set total = r.total if r.total is defined else r.get('total') %}
          {% set pct = r.percentage if r.percentage is defined else r.get('percentage') %}
          <tr>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ when }}</td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ tname }}</td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ score }}/{{ total }}</td>
            <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ "%.1f"|format(pct or 0) }}%</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="card" style="padding:14px;color:#64748b;">
    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î
  </div>
{% endif %}

{% endblock %}
