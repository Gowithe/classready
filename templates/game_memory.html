{% extends "base.html" %}
{% block title %}Memory Match - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #667eea;
  --primary-dark: #5a67d8;
  --success: #22c55e;
  --danger: #ef4444;
  --warning: #f59e0b;
}

/* Navigation */
.quick-nav {
  display: flex;
  gap: .75rem;
  flex-wrap: wrap;
  align-items: center;
  margin: .75rem 0 1.25rem;
}
.nav-btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .6rem .9rem;
  border-radius: 12px;
  font-weight: 800;
  text-decoration: none;
  border: 1px solid rgba(0,0,0,.10);
  background: #f7fafc;
  color: #1a202c;
  transition: all .15s ease;
}
.nav-btn:hover {
  background: #edf2f7;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}

/* Setup Screen */
.setup-screen {
  max-width: 550px;
  margin: 1.5rem auto;
  background: #fff;
  padding: 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,.1);
  text-align: center;
}
.setup-screen h2 {
  color: var(--primary);
  margin-bottom: 0.5rem;
}
.setup-options {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  text-align: left;
}
.setup-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.85rem 1rem;
  background: #f8fafc;
  border-radius: 12px;
}
.setup-row label {
  font-weight: 700;
  color: #334155;
}
.setup-row select {
  padding: .5rem 1rem;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  font-weight: 600;
  font-size: 0.95rem;
}
.btn-start {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--primary), #764ba2);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 800;
  cursor: pointer;
  transition: all .2s;
}
.btn-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102,126,234,.4);
}

/* Game Container */
.game-container {
  display: none;
  max-width: 950px;
  margin: 0 auto;
}
.game-container.active {
  display: block;
}

/* Stats Bar */
.stats-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  margin-bottom: 1rem;
}
.scoreboard {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.team-score {
  text-align: center;
  padding: 0.5rem 1rem;
  border-radius: 10px;
  background: #f8fafc;
  border: 2px solid transparent;
  min-width: 70px;
  transition: all 0.2s;
}
.team-score.active {
  border-color: var(--primary);
  background: #eef2ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(102,126,234,.2);
}
.team-score.scored {
  animation: scoreFlash 0.5s ease;
}
@keyframes scoreFlash {
  50% { background: #dcfce7; }
}
.team-value {
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--primary);
}
.team-label {
  font-size: 0.7rem;
  color: #64748b;
  font-weight: 700;
  text-transform: uppercase;
}
.stat-item {
  text-align: center;
  padding: 0.4rem 0.8rem;
}
.stat-value {
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--primary);
}
.stat-label {
  font-size: .75rem;
  color: #64748b;
  font-weight: 600;
}
.controls {
  display: flex;
  gap: 0.4rem;
}
.ctrl-btn {
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  background: #f8fafc;
  font-weight: 700;
  font-size: 0.85rem;
  cursor: pointer;
}
.ctrl-btn:hover {
  background: #e2e8f0;
}

/* Turn Indicator */
.turn-indicator {
  text-align: center;
  padding: 0.5rem;
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  border-radius: 10px;
  margin-bottom: 1rem;
  font-weight: 700;
  color: var(--primary-dark);
}

/* Cards Grid */
.cards-grid {
  display: grid;
  gap: 10px;
  margin-bottom: 1rem;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}
.cards-grid.grid-4 { grid-template-columns: repeat(4, 1fr); }
.cards-grid.grid-5 { grid-template-columns: repeat(5, 1fr); }
.cards-grid.grid-6 { grid-template-columns: repeat(6, 1fr); }

@media (max-width: 600px) {
  .cards-grid.grid-4,
  .cards-grid.grid-5,
  .cards-grid.grid-6 { grid-template-columns: repeat(3, 1fr); gap: 8px; }
}

/* Card */
.card {
  aspect-ratio: 1;
  perspective: 1000px;
  cursor: pointer;
}
.card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.5s;
  transform-style: preserve-3d;
}
.card.flipped .card-inner {
  transform: rotateY(180deg);
}
.card-front, .card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  padding: 6px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}
.card-front {
  background: linear-gradient(135deg, var(--primary), #764ba2);
  color: #fff;
}
.card-number {
  font-size: clamp(1.5rem, 5vw, 2.5rem);
  font-weight: 900;
}
.card-back {
  background: #fff;
  border: 2px solid #e2e8f0;
  transform: rotateY(180deg);
  color: #1e293b;
  word-break: break-word;
  overflow: hidden;
}
.card-back-number {
  position: absolute;
  top: 4px;
  left: 6px;
  font-size: 0.7rem;
  color: #94a3b8;
  font-weight: 800;
}
.card-back-content {
  font-size: clamp(0.65rem, 2.2vw, 0.95rem);
  line-height: 1.3;
  padding: 0 2px;
}
.card-back.word {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-color: #f59e0b;
}
.card-back.meaning {
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  border-color: #3b82f6;
}
.card.matched .card-inner {
  opacity: 0.4;
  transform: rotateY(180deg) scale(0.95);
}
.card.matched {
  pointer-events: none;
}

/* Actions */
.actions {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  flex-wrap: wrap;
  padding-top: 0.5rem;
}
.btn {
  padding: .65rem 1.25rem;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all .2s;
}
.btn-secondary {
  background: #f1f5f9;
  color: #475569;
}
.btn-secondary:hover {
  background: #e2e8f0;
}
.btn-primary {
  background: var(--primary);
  color: #fff;
}
.btn-primary:hover {
  background: var(--primary-dark);
}

/* Win Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active {
  display: flex;
}
.modal-box {
  background: #fff;
  padding: 2rem;
  border-radius: 20px;
  text-align: center;
  max-width: 420px;
  width: 92%;
  animation: popIn .3s ease;
}
@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-box h2 {
  font-size: 1.75rem;
  margin-bottom: .5rem;
}
.modal-box .trophy {
  font-size: 3.5rem;
  margin-bottom: 0.75rem;
}
.winner-announce {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--primary);
  margin: 0.5rem 0;
}
.modal-stats {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  margin: 1rem 0;
  flex-wrap: wrap;
}
.modal-stat {
  text-align: center;
}
.modal-stat-value {
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--primary);
}
.modal-stat-label {
  font-size: .8rem;
  color: #64748b;
}
.final-scores {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 1rem 0;
  flex-wrap: wrap;
}
.final-team {
  padding: 0.5rem 1rem;
  background: #f8fafc;
  border-radius: 10px;
  text-align: center;
}
.final-team.winner {
  background: linear-gradient(135deg, #dcfce7, #bbf7d0);
  border: 2px solid var(--success);
}
.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<div class="quick-nav">
  <a href="{{ url_for('topic_detail', topic_id=topic.id) }}" class="nav-btn">‚Üê Back to Topic</a>
  <a href="{{ url_for('game', topic_id=topic.id) }}" class="nav-btn">üéØ Bamboozle</a>
  <a href="{{ url_for('game_millionaire', topic_id=topic.id) }}" class="nav-btn">üèÜ Millionaire</a>
</div>

<!-- Setup Screen -->
<div class="setup-screen" id="setupScreen">
  <h2>üÉè Memory Match</h2>
  <p style="color:#64748b; margin-bottom:1.25rem;">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‚Üî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
  
  <div class="setup-options">
    <div class="setup-row">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°</label>
      <select id="teamsSelect">
        <option value="1">1 ‡∏ó‡∏µ‡∏° (Solo)</option>
        <option value="2" selected>2 ‡∏ó‡∏µ‡∏°</option>
        <option value="3">3 ‡∏ó‡∏µ‡∏°</option>
        <option value="4">4 ‡∏ó‡∏µ‡∏°</option>
      </select>
    </div>
    <div class="setup-row">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà</label>
      <select id="pairsSelect">
        <option value="6">6 ‡∏Ñ‡∏π‡πà (12 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="8" selected>8 ‡∏Ñ‡∏π‡πà (16 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="10">10 ‡∏Ñ‡∏π‡πà (20 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="12">12 ‡∏Ñ‡∏π‡πà (24 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
      </select>
    </div>
  </div>
  
  <button class="btn-start" onclick="startGame()">üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
  
  <p style="margin-top:1.25rem; font-size:.85rem; color:#94a3b8;">
    ‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î 2 ‡πÉ‡∏ö ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå ‚Üî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢) ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô!<br>
    ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ä‡∏ô‡∏∞ üèÜ
  </p>
</div>

<!-- Game Container -->
<div class="game-container" id="gameContainer">
  <div class="stats-bar">
    <div class="scoreboard" id="scoreboard"></div>
    <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
      <div class="stat-item">
        <div class="stat-value" id="matchesCount">0/0</div>
        <div class="stat-label">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="timerDisplay">00:00</div>
        <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn" onclick="resetGame()">üîÑ</button>
        <button class="ctrl-btn" id="soundToggle" onclick="toggleSound()">üîä</button>
      </div>
    </div>
  </div>
  
  <div class="turn-indicator" id="turnIndicator">üéØ ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á Team 1</div>
  
  <div class="cards-grid grid-4" id="cardsGrid"></div>
  
  <div class="actions">
    <button class="btn btn-secondary" onclick="backToSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</div>

<!-- Win Modal -->
<div class="modal-overlay" id="winModal">
  <div class="modal-box">
    <div class="trophy">üèÜ</div>
    <h2>‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h2>
    <div class="winner-announce" id="winnerAnnounce">Team 1 ‡∏ä‡∏ô‡∏∞!</div>
    
    <div class="final-scores" id="finalScores"></div>
    
    <div class="modal-stats">
      <div class="modal-stat">
        <div class="modal-stat-value" id="finalPairs">0</div>
        <div class="modal-stat-label">‡∏Ñ‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="modal-stat">
        <div class="modal-stat-value" id="finalTime">00:00</div>
        <div class="modal-stat-label">‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="backToSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <button class="btn btn-primary" onclick="playAgain()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å</button>
    </div>
  </div>
</div>

<script>
// Game Data from server
const gameData = {{ game_data | tojson | safe }};

// ===== SOUND SYSTEM (Web Audio API) =====
let soundEnabled = true;
let audioContext = null;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioContext;
}

function playTone(frequency, duration, type = 'sine', volume = 0.3) {
  if (!soundEnabled) return;
  try {
    const ctx = initAudio();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    gainNode.gain.setValueAtTime(volume, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + duration);
  } catch (e) {}
}

function playFlipSound() {
  playTone(500, 0.1, 'sine', 0.2);
}

function playMatchSound() {
  playTone(523, 0.15, 'sine', 0.3);
  setTimeout(() => playTone(659, 0.15, 'sine', 0.3), 100);
  setTimeout(() => playTone(784, 0.2, 'sine', 0.3), 200);
}

function playWrongSound() {
  playTone(200, 0.3, 'square', 0.15);
}

function playWinSound() {
  [523, 659, 784, 1047].forEach((note, i) => {
    setTimeout(() => playTone(note, 0.3, 'sine', 0.3), i * 150);
  });
}

function playStartSound() {
  playTone(440, 0.1, 'sine', 0.2);
  setTimeout(() => playTone(554, 0.1, 'sine', 0.2), 100);
  setTimeout(() => playTone(659, 0.15, 'sine', 0.25), 200);
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
  if (soundEnabled) playTone(440, 0.1, 'sine', 0.2);
}

// Game State
let cards = [];
let flippedCards = [];
let matchedPairs = 0;
let totalPairs = 0;
let gameTimer = null;
let seconds = 0;
let isLocked = false;

// Team State
let numTeams = 2;
let currentTeam = 0;
let teamScores = {};

function startGame() {
  playStartSound();
  
  numTeams = parseInt(document.getElementById('teamsSelect').value);
  const pairsCount = parseInt(document.getElementById('pairsSelect').value);
  totalPairs = pairsCount;
  
  // Reset team scores
  teamScores = {};
  for (let i = 0; i < numTeams; i++) {
    teamScores[i] = 0;
  }
  currentTeam = 0;
  
  // Prepare card pairs from VOCABULARY only
  const pairs = preparePairs(pairsCount);
  if (pairs.length < pairsCount) {
    alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô Slides');
    return;
  }
  
  // Create cards array (word + meaning for each pair)
  cards = [];
  pairs.forEach((pair, idx) => {
    cards.push({ id: idx * 2, pairId: idx, type: 'word', content: pair.word });
    cards.push({ id: idx * 2 + 1, pairId: idx, type: 'meaning', content: pair.meaning });
  });
  
  // Shuffle cards
  shuffleArray(cards);
  
  // Assign display numbers after shuffle
  cards.forEach((card, idx) => {
    card.displayNum = idx + 1;
  });
  
  // Reset state
  flippedCards = [];
  matchedPairs = 0;
  seconds = 0;
  isLocked = false;
  
  // Update UI
  document.getElementById('matchesCount').textContent = `0/${totalPairs}`;
  document.getElementById('timerDisplay').textContent = '00:00';
  
  // Set grid columns
  const grid = document.getElementById('cardsGrid');
  grid.className = 'cards-grid';
  if (cards.length <= 12) grid.classList.add('grid-4');
  else if (cards.length <= 20) grid.classList.add('grid-5');
  else grid.classList.add('grid-6');
  
  // Render
  renderScoreboard();
  renderCards();
  updateTurnIndicator();
  
  // Show game
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('gameContainer').classList.add('active');
  
  // Start timer
  startTimer();
}

function preparePairs(count) {
  const pairs = [];
  
  // Get vocabulary from game data (from slides)
  if (gameData.vocabulary && gameData.vocabulary.length > 0) {
    gameData.vocabulary.forEach(v => {
      if (v.word && v.meaning) {
        pairs.push({ word: v.word, meaning: v.meaning });
      }
    });
  }
  
  // Shuffle and take required amount
  shuffleArray(pairs);
  return pairs.slice(0, count);
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function renderScoreboard() {
  const sb = document.getElementById('scoreboard');
  sb.innerHTML = '';
  
  for (let i = 0; i < numTeams; i++) {
    const div = document.createElement('div');
    div.className = 'team-score' + (i === currentTeam ? ' active' : '');
    div.id = `team-${i}`;
    
    const label = numTeams === 1 ? 'SCORE' : `TEAM ${i + 1}`;
    div.innerHTML = `
      <div class="team-value">${teamScores[i]}</div>
      <div class="team-label">${label}</div>
    `;
    sb.appendChild(div);
  }
}

function updateTurnIndicator() {
  const indicator = document.getElementById('turnIndicator');
  if (numTeams === 1) {
    indicator.style.display = 'none';
  } else {
    indicator.style.display = 'block';
    indicator.innerHTML = `üéØ ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á <strong>Team ${currentTeam + 1}</strong>`;
  }
}

function renderCards() {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = cards.map((card, index) => `
    <div class="card" data-index="${index}" onclick="flipCard(${index})">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-number">${card.displayNum}</div>
        </div>
        <div class="card-back ${card.type}">
          <div class="card-back-number">#${card.displayNum}</div>
          <div class="card-back-content">${escapeHtml(card.content)}</div>
        </div>
      </div>
    </div>
  `).join('');
}

function flipCard(index) {
  if (isLocked) return;
  
  const cardEl = document.querySelector(`.card[data-index="${index}"]`);
  const card = cards[index];
  
  // Don't flip if already flipped or matched
  if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
  
  // Don't flip more than 2 cards
  if (flippedCards.length >= 2) return;
  
  playFlipSound();
  
  // Flip the card
  cardEl.classList.add('flipped');
  flippedCards.push({ index, card, element: cardEl });
  
  // Check for match when 2 cards are flipped
  if (flippedCards.length === 2) {
    checkMatch();
  }
}

function checkMatch() {
  const [first, second] = flippedCards;
  
  // Check if same pair (but different type: word ‚Üî meaning)
  if (first.card.pairId === second.card.pairId && first.card.type !== second.card.type) {
    // Match!
    playMatchSound();
    
    setTimeout(() => {
      first.element.classList.add('matched');
      second.element.classList.add('matched');
      
      // Add score to current team
      teamScores[currentTeam]++;
      matchedPairs++;
      
      // Update UI
      const teamEl = document.getElementById(`team-${currentTeam}`);
      teamEl.querySelector('.team-value').textContent = teamScores[currentTeam];
      teamEl.classList.add('scored');
      setTimeout(() => teamEl.classList.remove('scored'), 500);
      
      document.getElementById('matchesCount').textContent = `${matchedPairs}/${totalPairs}`;
      
      flippedCards = [];
      
      // Check win
      if (matchedPairs === totalPairs) {
        endGame();
      }
      // Same team continues (don't switch turn on match)
    }, 500);
  } else {
    // No match
    playWrongSound();
    isLocked = true;
    
    setTimeout(() => {
      first.element.classList.remove('flipped');
      second.element.classList.remove('flipped');
      flippedCards = [];
      isLocked = false;
      
      // Switch to next team
      if (numTeams > 1) {
        currentTeam = (currentTeam + 1) % numTeams;
        renderScoreboard();
        updateTurnIndicator();
      }
    }, 1000);
  }
}

function startTimer() {
  if (gameTimer) clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timerDisplay').textContent = `${mins}:${secs}`;
  }, 1000);
}

function stopTimer() {
  if (gameTimer) {
    clearInterval(gameTimer);
    gameTimer = null;
  }
}

function endGame() {
  stopTimer();
  playWinSound();
  
  const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  
  // Find winner
  let maxScore = -1;
  let winners = [];
  for (let i = 0; i < numTeams; i++) {
    if (teamScores[i] > maxScore) {
      maxScore = teamScores[i];
      winners = [i];
    } else if (teamScores[i] === maxScore) {
      winners.push(i);
    }
  }
  
  // Winner announcement
  const announce = document.getElementById('winnerAnnounce');
  if (numTeams === 1) {
    announce.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${teamScores[0]} ‡∏Ñ‡∏π‡πà!`;
  } else if (winners.length > 1) {
    announce.textContent = `‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô! (${maxScore} ‡∏Ñ‡∏π‡πà)`;
  } else {
    announce.textContent = `üéâ Team ${winners[0] + 1} ‡∏ä‡∏ô‡∏∞!`;
  }
  
  // Final scores display
  const finalScores = document.getElementById('finalScores');
  finalScores.innerHTML = '';
  for (let i = 0; i < numTeams; i++) {
    const div = document.createElement('div');
    div.className = 'final-team' + (winners.includes(i) ? ' winner' : '');
    div.innerHTML = `
      <div class="team-value">${teamScores[i]}</div>
      <div class="team-label">${numTeams === 1 ? '‡∏Ñ‡∏π‡πà' : `Team ${i + 1}`}</div>
    `;
    finalScores.appendChild(div);
  }
  
  document.getElementById('finalPairs').textContent = totalPairs;
  document.getElementById('finalTime').textContent = `${mins}:${secs}`;
  document.getElementById('winModal').classList.add('active');
}

function resetGame() {
  stopTimer();
  document.getElementById('winModal').classList.remove('active');
  startGame();
}

function playAgain() {
  document.getElementById('winModal').classList.remove('active');
  startGame();
}

function backToSetup() {
  stopTimer();
  document.getElementById('winModal').classList.remove('active');
  document.getElementById('gameContainer').classList.remove('active');
  document.getElementById('setupScreen').style.display = 'block';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}
