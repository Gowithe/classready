{% extends "base.html" %}
{% block title %}Memory Match - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #667eea;
  --primary-dark: #5a67d8;
  --success: #22c55e;
  --danger: #ef4444;
  --warning: #f59e0b;
}

/* Navigation */
.quick-nav {
  display: flex;
  gap: .75rem;
  flex-wrap: wrap;
  align-items: center;
  margin: .75rem 0 1.25rem;
}
.nav-btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .6rem .9rem;
  border-radius: 12px;
  font-weight: 800;
  text-decoration: none;
  border: 1px solid rgba(0,0,0,.10);
  background: #f7fafc;
  color: #1a202c;
  transition: all .15s ease;
}
.nav-btn:hover {
  background: #edf2f7;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}

/* Setup Screen */
.setup-screen {
  max-width: 600px;
  margin: 2rem auto;
  background: #fff;
  padding: 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,.1);
  text-align: center;
}
.setup-screen h2 {
  color: var(--primary);
  margin-bottom: 1.5rem;
}
.setup-options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1.5rem;
  text-align: left;
}
.setup-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 12px;
}
.setup-row label {
  font-weight: 700;
}
.setup-row select {
  padding: .5rem 1rem;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  font-weight: 600;
}
.btn-start {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--primary), #764ba2);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 800;
  cursor: pointer;
  transition: all .2s;
}
.btn-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102,126,234,.4);
}

/* Game Container */
.game-container {
  display: none;
  max-width: 900px;
  margin: 0 auto;
}
.game-container.active {
  display: block;
}

/* Stats Bar */
.stats-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  margin-bottom: 1.5rem;
}
.stat-item {
  text-align: center;
}
.stat-value {
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--primary);
}
.stat-label {
  font-size: .85rem;
  color: #64748b;
  font-weight: 600;
}

/* Cards Grid */
.cards-grid {
  display: grid;
  gap: 12px;
  margin-bottom: 1.5rem;
}
.cards-grid.grid-4 { grid-template-columns: repeat(4, 1fr); }
.cards-grid.grid-5 { grid-template-columns: repeat(5, 1fr); }
.cards-grid.grid-6 { grid-template-columns: repeat(6, 1fr); }

@media (max-width: 600px) {
  .cards-grid.grid-4,
  .cards-grid.grid-5,
  .cards-grid.grid-6 { grid-template-columns: repeat(3, 1fr); }
}

/* Card */
.card {
  aspect-ratio: 1;
  perspective: 1000px;
  cursor: pointer;
}
.card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.5s;
  transform-style: preserve-3d;
}
.card.flipped .card-inner {
  transform: rotateY(180deg);
}
.card-front, .card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  padding: 8px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}
.card-front {
  background: linear-gradient(135deg, var(--primary), #764ba2);
  color: #fff;
  font-size: 2rem;
}
.card-back {
  background: #fff;
  border: 2px solid #e2e8f0;
  transform: rotateY(180deg);
  font-size: clamp(0.7rem, 2.5vw, 1rem);
  color: #1e293b;
  word-break: break-word;
  overflow: hidden;
}
.card-back.word {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-color: #f59e0b;
}
.card-back.meaning {
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  border-color: #3b82f6;
}
.card.matched .card-inner {
  opacity: 0.5;
  transform: rotateY(180deg) scale(0.95);
}
.card.matched {
  pointer-events: none;
}

/* Actions */
.actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}
.btn {
  padding: .75rem 1.5rem;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
}
.btn-secondary {
  background: #f1f5f9;
  color: #475569;
}
.btn-secondary:hover {
  background: #e2e8f0;
}
.btn-primary {
  background: var(--primary);
  color: #fff;
}
.btn-primary:hover {
  background: var(--primary-dark);
}

/* Win Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active {
  display: flex;
}
.modal-box {
  background: #fff;
  padding: 2.5rem;
  border-radius: 20px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  animation: popIn .3s ease;
}
@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-box h2 {
  font-size: 2rem;
  margin-bottom: .5rem;
}
.modal-box .trophy {
  font-size: 4rem;
  margin-bottom: 1rem;
}
.modal-stats {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin: 1.5rem 0;
}
.modal-stat {
  text-align: center;
}
.modal-stat-value {
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--primary);
}
.modal-stat-label {
  font-size: .85rem;
  color: #64748b;
}
.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<div class="quick-nav">
  <a href="{{ url_for('topic_detail', topic_id=topic.id) }}" class="nav-btn">‚Üê Back to Topic</a>
  <a href="{{ url_for('game', topic_id=topic.id) }}" class="nav-btn">üéØ Bamboozle</a>
  <a href="{{ url_for('game_millionaire', topic_id=topic.id) }}" class="nav-btn">üèÜ Millionaire</a>
</div>

<!-- Setup Screen -->
<div class="setup-screen" id="setupScreen">
  <h2>üÉè Memory Match</h2>
  <p style="color:#64748b; margin-bottom:1.5rem;">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</p>
  
  <div class="setup-options">
    <div class="setup-row">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà</label>
      <select id="pairsSelect">
        <option value="6">6 ‡∏Ñ‡∏π‡πà (12 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="8" selected>8 ‡∏Ñ‡∏π‡πà (16 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="10">10 ‡∏Ñ‡∏π‡πà (20 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
        <option value="12">12 ‡∏Ñ‡∏π‡πà (24 ‡∏Å‡∏≤‡∏£‡πå‡∏î)</option>
      </select>
    </div>
  </div>
  
  <button class="btn-start" onclick="startGame()">üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
  
  <p style="margin-top:1.5rem; font-size:.85rem; color:#94a3b8;">
    ‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î 2 ‡πÉ‡∏ö ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏≥ ‚Üî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢) ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ<br>
    ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏•‡∏¥‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
  </p>
</div>

<!-- Game Container -->
<div class="game-container" id="gameContainer">
  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="movesCount">0</div>
      <div class="stat-label">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏•‡∏¥‡∏Å</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="matchesCount">0 / 0</div>
      <div class="stat-label">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="timerDisplay">00:00</div>
      <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤</div>
    </div>
  </div>
  
  <div class="cards-grid grid-4" id="cardsGrid">
    <!-- Cards will be inserted here -->
  </div>
  
  <div class="actions">
    <button class="btn btn-secondary" onclick="resetGame()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    <button class="btn btn-secondary" onclick="backToSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    <button class="btn btn-secondary" id="soundToggle" onclick="toggleSound()">üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  </div>
</div>

<!-- Win Modal -->
<div class="modal-overlay" id="winModal">
  <div class="modal-box">
    <div class="trophy">üèÜ</div>
    <h2>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</h2>
    <p style="color:#64748b;">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</p>
    
    <div class="modal-stats">
      <div class="modal-stat">
        <div class="modal-stat-value" id="finalMoves">0</div>
        <div class="modal-stat-label">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏•‡∏¥‡∏Å</div>
      </div>
      <div class="modal-stat">
        <div class="modal-stat-value" id="finalTime">00:00</div>
        <div class="modal-stat-label">‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="backToSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <button class="btn btn-primary" onclick="playAgain()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </div>
  </div>
</div>

<script>
// Game Data from server
const gameData = {{ game_data | tojson | safe }};

// ===== SOUND SYSTEM (Web Audio API) =====
let soundEnabled = true;
let audioContext = null;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioContext;
}

function playTone(frequency, duration, type = 'sine', volume = 0.3) {
  if (!soundEnabled) return;
  try {
    const ctx = initAudio();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    gainNode.gain.setValueAtTime(volume, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    
    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + duration);
  } catch (e) {
    console.log('Audio error:', e);
  }
}

function playFlipSound() {
  playTone(500, 0.1, 'sine', 0.2);
}

function playMatchSound() {
  // Happy ascending notes
  playTone(523, 0.15, 'sine', 0.3);
  setTimeout(() => playTone(659, 0.15, 'sine', 0.3), 100);
  setTimeout(() => playTone(784, 0.2, 'sine', 0.3), 200);
}

function playWrongSound() {
  playTone(200, 0.3, 'square', 0.15);
}

function playWinSound() {
  // Victory fanfare
  const notes = [523, 659, 784, 1047];
  notes.forEach((note, i) => {
    setTimeout(() => playTone(note, 0.3, 'sine', 0.3), i * 150);
  });
}

function playStartSound() {
  playTone(440, 0.1, 'sine', 0.2);
  setTimeout(() => playTone(554, 0.1, 'sine', 0.2), 100);
  setTimeout(() => playTone(659, 0.15, 'sine', 0.25), 200);
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á' : 'üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
  if (soundEnabled) playTone(440, 0.1, 'sine', 0.2);
}

// Game State
let cards = [];
let flippedCards = [];
let matchedPairs = 0;
let totalPairs = 0;
let moves = 0;
let gameTimer = null;
let seconds = 0;
let isLocked = false;

// Initialize
function startGame() {
  playStartSound();
  const pairsCount = parseInt(document.getElementById('pairsSelect').value);
  totalPairs = pairsCount;
  
  // Prepare card pairs
  const pairs = preparePairs(pairsCount);
  if (pairs.length < pairsCount) {
    alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á');
    return;
  }
  
  // Create cards array (word + meaning for each pair)
  cards = [];
  pairs.forEach((pair, idx) => {
    cards.push({ id: idx * 2, pairId: idx, type: 'word', content: pair.word });
    cards.push({ id: idx * 2 + 1, pairId: idx, type: 'meaning', content: pair.meaning });
  });
  
  // Shuffle cards
  shuffleArray(cards);
  
  // Reset state
  flippedCards = [];
  matchedPairs = 0;
  moves = 0;
  seconds = 0;
  isLocked = false;
  
  // Update UI
  document.getElementById('movesCount').textContent = '0';
  document.getElementById('matchesCount').textContent = `0 / ${totalPairs}`;
  document.getElementById('timerDisplay').textContent = '00:00';
  
  // Set grid columns
  const grid = document.getElementById('cardsGrid');
  grid.className = 'cards-grid';
  if (cards.length <= 12) grid.classList.add('grid-4');
  else if (cards.length <= 20) grid.classList.add('grid-5');
  else grid.classList.add('grid-6');
  
  // Render cards
  renderCards();
  
  // Show game
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('gameContainer').classList.add('active');
  
  // Start timer
  startTimer();
}

function preparePairs(count) {
  const pairs = [];
  
  // Try to get vocabulary from game data
  if (gameData.vocabulary && gameData.vocabulary.length > 0) {
    gameData.vocabulary.forEach(v => {
      if (v.word && v.meaning) {
        pairs.push({ word: v.word, meaning: v.meaning });
      }
    });
  }
  
  // Also use game questions (question ‚Üî answer)
  if (gameData.questions && gameData.questions.length > 0) {
    gameData.questions.forEach(q => {
      if (q.question && q.answer) {
        pairs.push({ word: q.question, meaning: q.answer });
      }
    });
  }
  
  // Shuffle and take required amount
  shuffleArray(pairs);
  return pairs.slice(0, count);
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function renderCards() {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = cards.map((card, index) => `
    <div class="card" data-index="${index}" onclick="flipCard(${index})">
      <div class="card-inner">
        <div class="card-front">?</div>
        <div class="card-back ${card.type}">${escapeHtml(card.content)}</div>
      </div>
    </div>
  `).join('');
}

function flipCard(index) {
  if (isLocked) return;
  
  const cardEl = document.querySelector(`.card[data-index="${index}"]`);
  const card = cards[index];
  
  // Don't flip if already flipped or matched
  if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
  
  // Don't flip more than 2 cards
  if (flippedCards.length >= 2) return;
  
  // Play flip sound
  playFlipSound();
  
  // Flip the card
  cardEl.classList.add('flipped');
  flippedCards.push({ index, card, element: cardEl });
  
  // Check for match when 2 cards are flipped
  if (flippedCards.length === 2) {
    moves++;
    document.getElementById('movesCount').textContent = moves;
    checkMatch();
  }
}

function checkMatch() {
  const [first, second] = flippedCards;
  
  // Check if same pair (but different type)
  if (first.card.pairId === second.card.pairId && first.card.type !== second.card.type) {
    // Match! Play sound
    playMatchSound();
    setTimeout(() => {
      first.element.classList.add('matched');
      second.element.classList.add('matched');
      matchedPairs++;
      document.getElementById('matchesCount').textContent = `${matchedPairs} / ${totalPairs}`;
      flippedCards = [];
      
      // Check win
      if (matchedPairs === totalPairs) {
        endGame();
      }
    }, 500);
  } else {
    // No match - play wrong sound and flip back
    playWrongSound();
    isLocked = true;
    setTimeout(() => {
      first.element.classList.remove('flipped');
      second.element.classList.remove('flipped');
      flippedCards = [];
      isLocked = false;
    }, 1000);
  }
}

function startTimer() {
  if (gameTimer) clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timerDisplay').textContent = `${mins}:${secs}`;
  }, 1000);
}

function stopTimer() {
  if (gameTimer) {
    clearInterval(gameTimer);
    gameTimer = null;
  }
}

function endGame() {
  stopTimer();
  playWinSound();
  
  const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  
  document.getElementById('finalMoves').textContent = moves;
  document.getElementById('finalTime').textContent = `${mins}:${secs}`;
  document.getElementById('winModal').classList.add('active');
}

function resetGame() {
  stopTimer();
  document.getElementById('winModal').classList.remove('active');
  startGame();
}

function playAgain() {
  document.getElementById('winModal').classList.remove('active');
  startGame();
}

function backToSetup() {
  stopTimer();
  document.getElementById('winModal').classList.remove('active');
  document.getElementById('gameContainer').classList.remove('active');
  document.getElementById('setupScreen').style.display = 'block';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}
