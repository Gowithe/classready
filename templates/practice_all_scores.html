{% extends "base.html" %}
{% block title %}Practice Scores | {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
  .wrap{max-width:1200px;margin:1.25rem auto;padding:0 1rem;}
  
  /* Header */
  .head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
    flex-wrap:wrap;
    margin-bottom:16px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  .title{font-size:1.3rem;font-weight:900;color:#1e293b;}
  .muted{color:#64748b;font-size:.9rem;margin-top:4px;}
  
  /* Buttons */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    border-radius:10px;
    padding:.6rem 1rem;
    font-weight:700;
    text-decoration:none;
    color:#0f172a;
    font-size:.9rem;
    cursor:pointer;
    transition: all .2s;
  }
  .btn:hover{
    background:#f8fafc;
    border-color:#667eea;
    color:#667eea;
  }
  .btn-primary{
    background: linear-gradient(135deg, #667eea, #764ba2);
    color:#fff;
    border:none;
  }
  .btn-primary:hover{
    opacity:.9;
    color:#fff;
  }
  .btn-success{
    background:#22c55e;
    color:#fff;
    border:none;
  }
  .btn-success:hover{
    background:#16a34a;
    color:#fff;
  }
  .btn-group{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  
  /* Tabs */
  .tabs{
    display:flex;
    gap:0;
    margin-bottom:16px;
    border-bottom:2px solid #e2e8f0;
  }
  .tab{
    padding:.75rem 1.5rem;
    font-weight:800;
    font-size:.95rem;
    color:#64748b;
    cursor:pointer;
    border-bottom:3px solid transparent;
    margin-bottom:-2px;
    transition: all .2s;
    background:none;
    border-left:none;
    border-right:none;
    border-top:none;
  }
  .tab:hover{
    color:#334155;
    background:#f8fafc;
  }
  .tab.active{
    color:#667eea;
    border-bottom-color:#667eea;
    background:#fff;
  }
  .tab.mcq{border-bottom-color:#667eea;}
  .tab.mcq.active{color:#667eea;border-bottom-color:#667eea;}
  .tab.fill{border-bottom-color:#06b6d4;}
  .tab.fill.active{color:#06b6d4;border-bottom-color:#06b6d4;}
  .tab.unscramble{border-bottom-color:#f97316;}
  .tab.unscramble.active{color:#f97316;border-bottom-color:#f97316;}
  
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  
  /* Filter & Stats Section */
  .filter-section{
    background:#f8fafc;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:14px;
    margin-bottom:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:12px;
  }
  .filter-row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .filter-row label{
    font-weight:700;
    font-size:.9rem;
    color:#475569;
  }
  .filter-row select,
  .filter-row input{
    padding:.5rem .75rem;
    border:1px solid rgba(0,0,0,.15);
    border-radius:8px;
    font-size:.9rem;
    outline:none;
    min-width:140px;
  }
  .filter-row select:focus,
  .filter-row input:focus{
    border-color:#667eea;
  }
  
  /* Stats */
  .stats{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .stat-item{
    text-align:center;
    padding:8px 16px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:10px;
  }
  .stat-value{
    font-size:1.5rem;
    font-weight:900;
    color:#667eea;
  }
  .stat-label{
    font-size:.75rem;
    color:#64748b;
    text-transform:uppercase;
    letter-spacing:.5px;
  }
  
  /* Table */
  .table-wrap{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.04);
  }
  table{
    width:100%;
    border-collapse:collapse;
  }
  th,td{
    padding:.75rem 1rem;
    text-align:left;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  th{
    background: linear-gradient(135deg, #667eea, #764ba2);
    color:#fff;
    font-weight:800;
    font-size:.85rem;
    text-transform:uppercase;
    letter-spacing:.5px;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  th:hover{
    background: linear-gradient(135deg, #5b6fd9, #6a4299);
  }
  th .sort-icon{
    margin-left:4px;
    opacity:.7;
  }
  tr:hover td{
    background:#f8fafc;
  }
  
  /* Score styling */
  .pill{
    display:inline-block;
    padding:.25rem .6rem;
    border-radius:999px;
    font-weight:800;
    font-size:.85rem;
  }
  .pill-success{background:#dcfce7;color:#166534;}
  .pill-warning{background:#fef3c7;color:#92400e;}
  .pill-danger{background:#fee2e2;color:#991b1b;}
  
  .pct-bar{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .pct-bar .bar{
    width:60px;
    height:8px;
    background:#e2e8f0;
    border-radius:4px;
    overflow:hidden;
  }
  .pct-bar .fill{
    height:100%;
    border-radius:4px;
    transition: width .3s;
  }
  .pct-bar .fill.high{background:#22c55e;}
  .pct-bar .fill.mid{background:#f59e0b;}
  .pct-bar .fill.low{background:#ef4444;}
  
  /* Type badge */
  .type-badge{
    display:inline-block;
    padding:.2rem .5rem;
    border-radius:6px;
    font-weight:700;
    font-size:.75rem;
  }
  .type-mcq{background:#eef2ff;color:#4338ca;}
  .type-fill{background:#ecfeff;color:#0e7490;}
  .type-unscramble{background:#fff7ed;color:#c2410c;}
  
  /* Empty state */
  .empty{
    text-align:center;
    padding:3rem;
    color:#64748b;
  }
  .empty-icon{font-size:3rem;margin-bottom:1rem;}
  
  /* Responsive */
  @media(max-width:768px){
    th,td{padding:.5rem .6rem;font-size:.85rem;}
    .stats{justify-content:center;}
    .filter-row{width:100%;}
    .filter-row select,
    .filter-row input{flex:1;min-width:100px;}
    .tabs{overflow-x:auto;}
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <!-- Header -->
  <div class="head">
    <div>
      <div class="title">üìä Practice Scores</div>
      <div class="muted">{{ topic.name }} ‚Ä¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</div>
    </div>
    <div class="btn-group">
      <a class="btn" href="{{ url_for('topic_detail', topic_id=topic.id) }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
      <a class="btn btn-success" href="{{ url_for('practice_all_scores_excel', topic_id=topic.id) }}">üì• Excel</a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab mcq active" onclick="showTab('all')">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="tab mcq" onclick="showTab('mcq')">üìù MCQ</button>
    <button class="tab fill" onclick="showTab('fill')">‚úçÔ∏è Fill Blanks</button>
    <button class="tab unscramble" onclick="showTab('unscramble')">üîÄ Unscramble</button>
  </div>

  <!-- Filter & Stats -->
  <div class="filter-section">
    <div class="filter-row">
      <label>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label>
      <input type="text" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà..." oninput="filterTable()">
      
      <label>üè´ ‡∏´‡πâ‡∏≠‡∏á:</label>
      <select id="classroomFilter" onchange="filterTable()">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for cls in classrooms %}
        <option value="{{ cls }}">{{ cls }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="totalCount">{{ all_submissions|length }}</div>
        <div class="stat-label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="avgScore">-</div>
        <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="passCount">-</div>
        <div class="stat-label">‡∏ú‡πà‡∏≤‡∏ô ‚â•50%</div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table id="scoresTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)" style="width:50px"># <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(1)">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(2)" style="width:60px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(3)" style="width:80px">‡∏´‡πâ‡∏≠‡∏á <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(4)" style="width:100px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(5)" style="width:90px">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(6)" style="width:120px">% <span class="sort-icon">‚áÖ</span></th>
          <th onclick="sortTable(7)" style="width:140px">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á <span class="sort-icon">‚áÖ</span></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% if all_submissions and all_submissions|length > 0 %}
          {% for s in all_submissions %}
          <tr data-name="{{ s.student_name|lower }}" data-no="{{ s.student_no or '' }}" data-class="{{ s.classroom or '' }}" data-pct="{{ s.percentage|default(0) }}" data-type="{{ s.practice_type }}">
            <td>{{ loop.index }}</td>
            <td><strong>{{ s.student_name }}</strong></td>
            <td>{{ s.student_no or '-' }}</td>
            <td>{{ s.classroom or '-' }}</td>
            <td>
              {% if s.practice_type == 'mcq' %}
                <span class="type-badge type-mcq">üìù MCQ</span>
              {% elif s.practice_type == 'fill' %}
                <span class="type-badge type-fill">‚úçÔ∏è Fill</span>
              {% elif s.practice_type == 'unscramble' %}
                <span class="type-badge type-unscramble">üîÄ Unscr</span>
              {% else %}
                <span class="type-badge">{{ s.practice_type }}</span>
              {% endif %}
            </td>
            <td>
              {% set pct = s.percentage|default(0)|int %}
              <span class="pill {% if pct >= 80 %}pill-success{% elif pct >= 50 %}pill-warning{% else %}pill-danger{% endif %}">
                {{ s.score }}/{{ s.total }}
              </span>
            </td>
            <td>
              <div class="pct-bar">
                <div class="bar">
                  <div class="fill {% if pct >= 80 %}high{% elif pct >= 50 %}mid{% else %}low{% endif %}" style="width:{{ pct }}%"></div>
                </div>
                <span>{{ '%.0f'|format(s.percentage or 0) }}%</span>
              </div>
            </td>
            <td class="muted">{{ s.created_at[:16].replace('T', ' ') if s.created_at else '-' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr id="emptyRow">
            <td colspan="8">
              <div class="empty">
                <div class="empty-icon">üì≠</div>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</p>
                <p class="muted">‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  
  <div class="muted" style="margin-top:12px;text-align:center;">
    üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‚Ä¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
  </div>
</div>

<script>
// Store original data for filtering
const allRows = [];
document.querySelectorAll("#tableBody tr:not(#emptyRow)").forEach((row, i) => {
  allRows.push({
    el: row,
    index: i + 1,
    name: row.dataset.name || "",
    no: row.dataset.no || "",
    classroom: row.dataset.class || "",
    pct: parseFloat(row.dataset.pct) || 0,
    type: row.dataset.type || ""
  });
});

let currentTab = 'all';

function showTab(tab) {
  currentTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  filterTable();
}

// Calculate and update stats
function updateStats(){
  const visibleRows = allRows.filter(r => r.el.style.display !== "none");
  const total = visibleRows.length;
  
  document.getElementById("totalCount").textContent = total;
  
  if(total > 0){
    const sumPct = visibleRows.reduce((acc, r) => acc + r.pct, 0);
    const avg = sumPct / total;
    const passCount = visibleRows.filter(r => r.pct >= 50).length;
    
    document.getElementById("avgScore").textContent = avg.toFixed(0) + "%";
    document.getElementById("passCount").textContent = passCount;
  } else {
    document.getElementById("avgScore").textContent = "-";
    document.getElementById("passCount").textContent = "-";
  }
}

// Filter table
function filterTable(){
  const search = (document.getElementById("searchInput").value || "").toLowerCase().trim();
  const classroom = document.getElementById("classroomFilter").value;
  
  let visibleCount = 0;
  
  allRows.forEach(row => {
    let show = true;
    
    // Tab filter
    if(currentTab !== 'all' && row.type !== currentTab){
      show = false;
    }
    
    // Search filter
    if(show && search){
      const matchName = row.name.includes(search);
      const matchNo = row.no.includes(search);
      if(!matchName && !matchNo) show = false;
    }
    
    // Classroom filter
    if(show && classroom && row.classroom !== classroom){
      show = false;
    }
    
    row.el.style.display = show ? "" : "none";
    if(show) visibleCount++;
  });
  
  // Show/hide empty message
  const emptyRow = document.getElementById("emptyRow");
  if(emptyRow){
    emptyRow.style.display = visibleCount === 0 && allRows.length > 0 ? "" : "none";
  }
  
  // Update row numbers
  let num = 1;
  allRows.forEach(row => {
    if(row.el.style.display !== "none"){
      row.el.cells[0].textContent = num++;
    }
  });
  
  updateStats();
}

// Sort table
let sortCol = -1;
let sortAsc = true;

function sortTable(colIndex){
  if(sortCol === colIndex){
    sortAsc = !sortAsc;
  } else {
    sortCol = colIndex;
    sortAsc = true;
  }
  
  const tbody = document.getElementById("tableBody");
  
  allRows.sort((a, b) => {
    let valA, valB;
    
    switch(colIndex){
      case 0: // index
        valA = a.index;
        valB = b.index;
        break;
      case 1: // name
        valA = a.name;
        valB = b.name;
        break;
      case 2: // no
        valA = parseInt(a.no) || 999;
        valB = parseInt(b.no) || 999;
        break;
      case 3: // classroom
        valA = a.classroom;
        valB = b.classroom;
        break;
      case 4: // type
        valA = a.type;
        valB = b.type;
        break;
      case 5: // score (by percentage)
      case 6: // percentage
        valA = a.pct;
        valB = b.pct;
        break;
      case 7: // time
        valA = a.el.cells[7].textContent;
        valB = b.el.cells[7].textContent;
        break;
      default:
        return 0;
    }
    
    if(typeof valA === "string"){
      return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } else {
      return sortAsc ? valA - valB : valB - valA;
    }
  });
  
  // Re-append rows in sorted order
  allRows.forEach(row => {
    tbody.appendChild(row.el);
  });
  
  // Update row numbers
  filterTable();
}

// Initial stats calculation
updateStats();
</script>
{% endblock %}
