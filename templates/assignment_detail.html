{% extends "base.html" %}
{% block title %}{{ assignment.title }} | Assignment{% endblock %}

{% block extra_css %}
<style>
  .wrap{max-width:1200px;margin:1.25rem auto;padding:0 1rem;}
  
  /* Header */
  .page-header{
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff;
    padding:24px 28px;
    border-radius:20px;
    margin-bottom:24px;
  }
  .header-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    flex-wrap:wrap;
    gap:16px;
    margin-bottom:16px;
  }
  .header-info h1{margin:0 0 6px;font-size:1.4rem;font-weight:900;}
  .header-meta{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    opacity:.9;
    font-size:.95rem;
  }
  .header-meta span{display:flex;align-items:center;gap:6px;}
  
  .btn{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    border:none;
    border-radius:12px;
    padding:.7rem 1.1rem;
    font-weight:700;
    text-decoration:none;
    cursor:pointer;
    transition:all .2s;
    font-size:.9rem;
  }
  .btn-white{background:rgba(255,255,255,.95);color:#667eea;}
  .btn-ghost{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);}
  .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;}
  .btn-secondary{background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;}
  .btn-success{background:#22c55e;color:#fff;}
  
  /* Stats Row */
  .stats-row{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:16px;
    background:rgba(255,255,255,.1);
    border-radius:14px;
    padding:16px;
  }
  @media(max-width:768px){.stats-row{grid-template-columns:repeat(2,1fr);}}
  .stat-item{text-align:center;}
  .stat-value{font-size:1.8rem;font-weight:900;}
  .stat-label{font-size:.85rem;opacity:.85;}
  
  /* Link Box */
  .link-box{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    padding:20px;
    margin-bottom:24px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:16px;
  }
  .link-url{
    flex:1;
    background:#f8fafc;
    padding:12px 16px;
    border-radius:10px;
    font-family:monospace;
    font-size:.9rem;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    border:1px solid #e2e8f0;
    min-width:200px;
  }
  
  /* Tables */
  .card{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.04);
    margin-bottom:24px;
  }
  .card-header{
    padding:16px 20px;
    border-bottom:1px solid #f1f5f9;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .card-title{font-size:1.1rem;font-weight:800;color:#1e293b;}
  
  table{width:100%;border-collapse:collapse;}
  th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #f1f5f9;}
  th{background:#f8fafc;font-weight:700;font-size:.85rem;color:#64748b;text-transform:uppercase;}
  tr:hover td{background:#fafbfc;}
  
  .status-badge{
    display:inline-block;
    padding:4px 10px;
    border-radius:20px;
    font-size:.8rem;
    font-weight:700;
  }
  .badge-submitted{background:#dcfce7;color:#166534;}
  .badge-pending{background:#fef3c7;color:#92400e;}
  
  .score-pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:20px;
    font-weight:700;
    font-size:.85rem;
  }
  .score-high{background:#dcfce7;color:#166534;}
  .score-mid{background:#fef3c7;color:#92400e;}
  .score-low{background:#fee2e2;color:#991b1b;}
  
  /* Progress */
  .progress-big{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:24px;
  }
  .progress-bar-big{
    flex:1;
    height:24px;
    background:#e2e8f0;
    border-radius:12px;
    overflow:hidden;
  }
  .progress-fill-big{
    height:100%;
    background:linear-gradient(90deg,#667eea,#764ba2);
    transition:width .5s;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:.85rem;
  }
  .progress-text{font-weight:700;font-size:1.1rem;color:#1e293b;}
  
  /* Empty */
  .empty{text-align:center;padding:40px;color:#64748b;}
  .empty-icon{font-size:3rem;margin-bottom:12px;}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <!-- Header -->
  <div class="page-header">
    <div class="header-top">
      <div class="header-info">
        <h1>üìã {{ assignment.title }}</h1>
        <div class="header-meta">
          <span>üè´ {{ classroom.name }}</span>
          <span>üìö {{ topic.name }}</span>
          {% if assignment.due_date %}
          <span>‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: {{ assignment.due_date[:16].replace('T', ' ') }}</span>
          {% endif %}
        </div>
      </div>
      <div style="display:flex;gap:10px;">
        <a href="{{ url_for('classroom_detail', classroom_id=classroom.id) }}" class="btn btn-ghost">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
        {% if practice_link %}
        <a href="{{ url_for('practice_scores', topic_id=topic.id) }}" class="btn btn-white">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        {% endif %}
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-value">{{ total_students }}</div>
        <div class="stat-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ submitted_count }}</div>
        <div class="stat-label">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ not_submitted_count }}</div>
        <div class="stat-label">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ '%.0f'|format(avg_score) }}%</div>
        <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
      </div>
    </div>
  </div>

  <!-- Link Box -->
  {% if practice_link %}
  <div class="link-box">
    <div>
      <strong>üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong>
      <div style="font-size:.85rem;color:#64748b;margin-top:4px;">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</div>
    </div>
    <div class="link-url" id="linkUrl">{{ student_url }}</div>
    <button class="btn btn-primary" onclick="copyLink()">üìã Copy</button>
  </div>
  {% endif %}

  <!-- Progress -->
  <div class="progress-big">
    <div class="progress-text">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
    <div class="progress-bar-big">
      {% set pct = (submitted_count / total_students * 100) if total_students > 0 else 0 %}
      <div class="progress-fill-big" style="width:{{ pct|int }}%">
        {% if pct > 10 %}{{ pct|int }}%{% endif %}
      </div>
    </div>
    <div class="progress-text">{{ submitted_count }}/{{ total_students }}</div>
  </div>

  <!-- Submitted -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ({{ submitted|length }})</div>
    </div>
    {% if submitted %}
    <table>
      <thead>
        <tr>
          <th style="width:60px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
          <th style="width:100px">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
          <th style="width:80px">%</th>
          <th style="width:160px">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</th>
        </tr>
      </thead>
      <tbody>
        {% for s in submitted %}
        <tr>
          <td><strong>{{ s.student_no or '-' }}</strong></td>
          <td>{{ s.student_name }}</td>
          <td>
            {% if s.submission %}
              {% set sub = s.submission %}
              {% set pct = sub.percentage|default(0)|int %}
              <span class="score-pill {% if pct >= 80 %}score-high{% elif pct >= 50 %}score-mid{% else %}score-low{% endif %}">
                {{ sub.score }}/{{ sub.total }}
              </span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if s.submission %}
              {{ '%.0f'|format(s.submission.percentage or 0) }}%
            {% else %}
              -
            {% endif %}
          </td>
          <td style="color:#64748b;font-size:.9rem;">
            {% if s.submission %}
              {{ s.submission.created_at[:16].replace('T', ' ') }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty">
      <div class="empty-icon">üì≠</div>
      <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>
    </div>
    {% endif %}
  </div>

  <!-- Not Submitted -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á ({{ not_submitted|length }})</div>
    </div>
    {% if not_submitted %}
    <table>
      <thead>
        <tr>
          <th style="width:60px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
          <th style="width:100px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody>
        {% for s in not_submitted %}
        <tr>
          <td><strong>{{ s.student_no or '-' }}</strong></td>
          <td>{{ s.student_name }}</td>
          <td><span class="status-badge badge-pending">‡∏£‡∏≠‡∏™‡πà‡∏á</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty" style="padding:20px;">
      <p>üéâ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
function copyLink() {
  const url = document.getElementById('linkUrl').textContent;
  navigator.clipboard.writeText(url).then(() => {
    alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ');
  });
}
</script>
{% endblock %}
