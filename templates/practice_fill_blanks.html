{% extends "base.html" %}
{% block title %}Fill in the Blanks - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #667eea;
  --primary-dark: #5a67d8;
  --success: #22c55e;
  --danger: #ef4444;
  --warning: #f59e0b;
}

.quick-nav {
  display: flex;
  gap: .75rem;
  flex-wrap: wrap;
  align-items: center;
  margin: .75rem 0 1.25rem;
}
.nav-btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .6rem .9rem;
  border-radius: 12px;
  font-weight: 800;
  text-decoration: none;
  border: 1px solid rgba(0,0,0,.10);
  background: #f7fafc;
  color: #1a202c;
  transition: all .15s ease;
}
.nav-btn:hover {
  background: #edf2f7;
  transform: translateY(-1px);
}

/* Student Link Section */
.link-section {
  background: #fff;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  justify-content: space-between;
}
.link-section h4 { margin: 0; font-size: .95rem; color: #334155; }
.link-url {
  flex: 1;
  min-width: 200px;
  padding: .5rem .75rem;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: .85rem;
  background: #f8fafc;
  color: #475569;
}
.link-actions { display: flex; gap: .5rem; }
.btn-small {
  padding: .5rem 1rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: .85rem;
  cursor: pointer;
  transition: all .2s;
  text-decoration: none;
}
.btn-copy { background: var(--primary); color: #fff; }
.btn-copy:hover { background: var(--primary-dark); }
.btn-create { background: var(--success); color: #fff; }
.btn-scores { background: var(--warning); color: #1e293b; }

.practice-container { max-width: 800px; margin: 0 auto; }

.progress-section {
  background: #fff;
  padding: 1.25rem;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  margin-bottom: 1.5rem;
}
.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: .75rem;
}
.progress-text { font-weight: 700; color: #334155; }
.progress-score { font-weight: 800; color: var(--primary); }
.progress-bar {
  height: 10px;
  background: #e2e8f0;
  border-radius: 999px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #a78bfa);
  border-radius: 999px;
  transition: width 0.3s ease;
}

.question-card {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,.1);
  padding: 2rem;
  margin-bottom: 1.5rem;
}
.question-number {
  display: inline-block;
  background: linear-gradient(135deg, var(--primary), #a78bfa);
  color: #fff;
  padding: .4rem 1rem;
  border-radius: 999px;
  font-weight: 800;
  font-size: .9rem;
  margin-bottom: 1rem;
}
.sentence-display {
  font-size: 1.25rem;
  line-height: 1.8;
  color: #1e293b;
  margin-bottom: 1.5rem;
  text-align: center;
}
.blank-slot {
  display: inline-block;
  min-width: 80px;
  padding: .2rem .6rem;
  margin: 0 .2rem;
  border-bottom: 3px solid var(--primary);
  background: #f0f4ff;
  border-radius: 8px 8px 0 0;
  font-weight: 700;
  color: var(--primary);
  text-align: center;
}
.blank-slot.correct { background: #dcfce7; border-color: var(--success); color: var(--success); }
.blank-slot.wrong { background: #fee2e2; border-color: var(--danger); color: var(--danger); }

.choices-container {
  display: flex;
  flex-wrap: wrap;
  gap: .75rem;
  justify-content: center;
}
.choice-btn {
  padding: .75rem 1.5rem;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  background: #fff;
  font-size: 1rem;
  font-weight: 600;
  color: #334155;
  cursor: pointer;
  transition: all .2s;
}
.choice-btn:hover:not(:disabled) {
  border-color: var(--primary);
  background: #f0f4ff;
  transform: translateY(-2px);
}
.choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.choice-btn.correct { border-color: var(--success); background: var(--success); color: #fff; }
.choice-btn.wrong { border-color: var(--danger); background: var(--danger); color: #fff; }

.feedback {
  text-align: center;
  padding: 1rem;
  border-radius: 12px;
  margin-top: 1rem;
  font-weight: 700;
  display: none;
}
.feedback.show { display: block; }
.feedback.correct { background: #dcfce7; color: #166534; }
.feedback.wrong { background: #fee2e2; color: #991b1b; }

.nav-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
.btn {
  padding: .75rem 2rem;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
}
.btn-primary { background: linear-gradient(135deg, var(--primary), #a78bfa); color: #fff; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,.4); }
.btn-secondary { background: #f1f5f9; color: #475569; }

.result-screen {
  display: none;
  text-align: center;
  padding: 3rem 2rem;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,.1);
}
.result-screen.active { display: block; }
.result-emoji { font-size: 5rem; margin-bottom: 1rem; }
.result-title { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-bottom: .5rem; }
.result-score { font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 2rem; }
.result-details { display: flex; justify-content: center; gap: 3rem; margin-bottom: 2rem; }
.result-stat { text-align: center; }
.result-stat-value { font-size: 1.5rem; font-weight: 800; }
.result-stat-value.correct { color: var(--success); }
.result-stat-value.wrong { color: var(--danger); }
.result-stat-label { font-size: .85rem; color: #64748b; }
.result-actions { display: flex; gap: 1rem; justify-content: center; }

.sound-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary);
  color: #fff;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(102,126,234,.4);
}
</style>
{% endblock %}

{% block content %}
<div class="quick-nav">
  <a href="{{ url_for('topic_detail', topic_id=topic.id) }}" class="nav-btn">‚Üê Back to Topic</a>
  <a href="{{ url_for('practice', topic_id=topic.id) }}" class="nav-btn">üìù MCQ Practice</a>
  <a href="{{ url_for('practice_unscramble', topic_id=topic.id) }}" class="nav-btn">üîÄ Unscramble</a>
</div>

<div class="link-section">
  <h4>üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  {% if student_url %}
  <input type="text" class="link-url" id="studentUrl" value="{{ student_url }}" readonly>
  <div class="link-actions">
    <button class="btn-small btn-copy" onclick="copyLink()">üìã Copy</button>
    <a href="{{ url_for('practice_fill_blanks_scores', topic_id=topic.id) }}" class="btn-small btn-scores">üìä ‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
  </div>
  {% else %}
  <span style="color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå</span>
  <button class="btn-small btn-create" onclick="createLink()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
  {% endif %}
</div>

<div class="practice-container">
  <div class="progress-section">
    <div class="progress-header">
      <span class="progress-text">Question <span id="currentNum">1</span> / <span id="totalNum">10</span></span>
      <span class="progress-score">Score: <span id="score">0</span></span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <div class="question-card" id="questionCard">
    <div class="question-number" id="questionNumber">Question 1</div>
    <div class="sentence-display" id="sentenceDisplay">Loading...</div>
    <div class="choices-container" id="choicesContainer"></div>
    <div class="feedback" id="feedback"></div>
    <div class="nav-buttons">
      <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display:none;">Next ‚Üí</button>
    </div>
  </div>

  <div class="result-screen" id="resultScreen">
    <div class="result-emoji" id="resultEmoji">üéâ</div>
    <div class="result-title" id="resultTitle">Great Job!</div>
    <div class="result-score" id="resultScore">80%</div>
    <div class="result-details">
      <div class="result-stat">
        <div class="result-stat-value correct" id="correctCount">8</div>
        <div class="result-stat-label">Correct</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-value wrong" id="wrongCount">2</div>
        <div class="result-stat-label">Wrong</div>
      </div>
    </div>
    <div class="result-actions">
      <button class="btn btn-secondary" onclick="location.href='{{ url_for('topic_detail', topic_id=topic.id) }}'">üè† Back</button>
      <button class="btn btn-primary" onclick="restartPractice()">üîÑ Try Again</button>
    </div>
  </div>
</div>

<button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

<script>
const practiceData = {{ practice_data | tojson | safe }};
const topicId = {{ topic.id }};

let soundEnabled = true;
let audioContext = null;

function initAudio() {
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  return audioContext;
}

function playTone(freq, dur, type = 'sine', vol = 0.3) {
  if (!soundEnabled) return;
  try {
    const ctx = initAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    osc.type = type;
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + dur);
  } catch (e) {}
}

function playCorrectSound() {
  playTone(523, 0.15); setTimeout(() => playTone(659, 0.15), 100); setTimeout(() => playTone(784, 0.2), 200);
}
function playWrongSound() { playTone(200, 0.3, 'square', 0.15); }
function playWinSound() { [523, 659, 784, 1047].forEach((n, i) => setTimeout(() => playTone(n, 0.3), i * 150)); }
function playClickSound() { playTone(400, 0.1, 'sine', 0.2); }
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
}

function copyLink() {
  const input = document.getElementById('studentUrl');
  input.select();
  document.execCommand('copy');
  alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!');
}

function createLink() {
  fetch(`/api/practice/${topicId}/fill-blanks/link`, { method: 'POST' })
    .then(r => r.json())
    .then(data => { if (data.url) location.reload(); });
}

let questions = [];
let currentIndex = 0;
let score = 0;
let correctCount = 0;
let wrongCount = 0;
let answered = false;

function init() {
  questions = prepareQuestions();
  if (questions.length === 0) {
    document.getElementById('sentenceDisplay').innerHTML = '<p style="color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Generate Practice ‡∏Å‡πà‡∏≠‡∏ô</p>';
    return;
  }
  document.getElementById('totalNum').textContent = questions.length;
  loadQuestion();
}

function prepareQuestions() {
  const result = [];
  
  // From MCQ practice questions
  if (practiceData.mcq_questions && practiceData.mcq_questions.length > 0) {
    practiceData.mcq_questions.forEach(q => {
      if (q.prompt && q.choices && q.correct_answer) {
        result.push({
          sentence: q.prompt,
          answer: q.correct_answer,
          choices: q.choices,
          hint: q.explain || ''
        });
      }
    });
  }
  
  // From vocabulary
  if (practiceData.vocabulary && practiceData.vocabulary.length > 0) {
    practiceData.vocabulary.forEach(v => {
      if (v.word && v.example) {
        const blank = v.example.replace(new RegExp('\\b' + v.word + '\\b', 'i'), '_____');
        if (blank !== v.example) {
          result.push({ sentence: blank, answer: v.word, choices: null, hint: v.meaning || '' });
        }
      }
    });
  }
  
  // From game questions
  if (practiceData.questions && practiceData.questions.length > 0) {
    practiceData.questions.forEach(q => {
      if (q.question && q.answer) {
        result.push({ sentence: q.question, answer: q.answer, choices: null, hint: '' });
      }
    });
  }
  
  shuffleArray(result);
  return result.slice(0, 15);
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function loadQuestion() {
  if (currentIndex >= questions.length) { showResult(); return; }
  
  answered = false;
  const q = questions[currentIndex];
  
  document.getElementById('currentNum').textContent = currentIndex + 1;
  document.getElementById('questionNumber').textContent = `Question ${currentIndex + 1}`;
  document.getElementById('progressFill').style.width = `${(currentIndex / questions.length) * 100}%`;
  
  let displayText = q.sentence;
  if (!displayText.includes('_____')) {
    displayText = displayText + ' <span class="blank-slot" id="blankSlot">?</span>';
  } else {
    displayText = displayText.replace('_____', '<span class="blank-slot" id="blankSlot">?</span>');
  }
  document.getElementById('sentenceDisplay').innerHTML = displayText;
  
  let choices;
  if (q.choices && q.choices.length >= 4) {
    choices = [...q.choices];
    shuffleArray(choices);
  } else {
    choices = generateChoices(q.answer);
  }
  
  const container = document.getElementById('choicesContainer');
  container.innerHTML = '';
  
  choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = choice;
    btn.dataset.answer = choice;
    btn.addEventListener('click', function() { selectAnswer(this, choice); });
    container.appendChild(btn);
  });
  
  document.getElementById('feedback').classList.remove('show');
  document.getElementById('feedback').className = 'feedback';
  document.getElementById('nextBtn').style.display = 'none';
}

function generateChoices(correct) {
  const choices = [correct];
  const others = questions.map(q => q.answer).filter(a => a !== correct);
  shuffleArray(others);
  
  for (let i = 0; i < 3 && i < others.length; i++) {
    if (!choices.includes(others[i])) choices.push(others[i]);
  }
  
  const fillers = ['the', 'is', 'are', 'have', 'has', 'do', 'does', 'can', 'will'];
  while (choices.length < 4) {
    const f = fillers[Math.floor(Math.random() * fillers.length)];
    if (!choices.includes(f)) choices.push(f);
  }
  
  shuffleArray(choices);
  return choices.slice(0, 4);
}

function selectAnswer(btn, answer) {
  if (answered) return;
  answered = true;
  playClickSound();
  
  const q = questions[currentIndex];
  const isCorrect = answer.toLowerCase().trim() === q.answer.toLowerCase().trim();
  const blankSlot = document.getElementById('blankSlot');
  const feedback = document.getElementById('feedback');
  
  if (blankSlot) blankSlot.textContent = q.answer;
  
  document.querySelectorAll('.choice-btn').forEach(b => {
    b.disabled = true;
    if (b.dataset.answer.toLowerCase().trim() === q.answer.toLowerCase().trim()) {
      b.classList.add('correct');
    }
  });
  
  if (isCorrect) {
    playCorrectSound();
    if (blankSlot) blankSlot.classList.add('correct');
    feedback.textContent = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
    feedback.className = 'feedback show correct';
    score += 10;
    correctCount++;
  } else {
    playWrongSound();
    btn.classList.add('wrong');
    if (blankSlot) blankSlot.classList.add('wrong');
    feedback.textContent = '‚ùå ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠: ' + q.answer;
    feedback.className = 'feedback show wrong';
    wrongCount++;
  }
  
  document.getElementById('score').textContent = score;
  document.getElementById('nextBtn').style.display = 'inline-block';
}

function nextQuestion() { currentIndex++; loadQuestion(); }

function showResult() {
  playWinSound();
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('resultScreen').classList.add('active');
  
  const percent = Math.round((correctCount / questions.length) * 100);
  document.getElementById('resultScore').textContent = percent + '%';
  document.getElementById('correctCount').textContent = correctCount;
  document.getElementById('wrongCount').textContent = wrongCount;
  
  let emoji = 'üéâ', title = '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!';
  if (percent < 50) { emoji = 'üò¢'; title = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!'; }
  else if (percent < 70) { emoji = 'üòä'; title = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!'; }
  else if (percent < 90) { emoji = 'üåü'; title = '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'; }
  
  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultTitle').textContent = title;
}

function restartPractice() {
  currentIndex = 0; score = 0; correctCount = 0; wrongCount = 0;
  document.getElementById('questionCard').style.display = 'block';
  document.getElementById('resultScreen').classList.remove('active');
  document.getElementById('score').textContent = '0';
  shuffleArray(questions);
  loadQuestion();
}

init();
</script>
{% endblock %}
