{% extends "base.html" %}
{% block title %}Practice | {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
  .wrap{max-width:1000px;margin:1.25rem auto;padding:0 1rem;}
  .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);}
  .h1{font-size:1.25rem;font-weight:900;margin-bottom:.25rem;}
  .muted{color:#64748b;font-size:.95rem;}
  
  /* Student Info Form */
  .student-form{
    background: linear-gradient(135deg, #667eea15, #764ba215);
    border:1px solid rgba(102,126,234,.2);
    border-radius:14px;
    padding:16px;
    margin-bottom:16px;
  }
  .student-form h3{
    margin:0 0 12px;
    font-size:1rem;
    color:#4338ca;
  }
  .form-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media(max-width:600px){
    .form-grid{grid-template-columns:1fr;}
  }
  .form-group label{
    display:block;
    font-weight:800;
    font-size:.9rem;
    margin-bottom:4px;
    color:#334155;
  }
  .form-group select,
  .form-group input{
    width:100%;
    padding:.7rem .85rem;
    border-radius:10px;
    border:1px solid rgba(0,0,0,.15);
    outline:none;
    font-size:1rem;
    transition: border-color .2s, box-shadow .2s;
    background:#fff;
  }
  .form-group select:focus,
  .form-group input:focus{
    border-color:#667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,.15);
  }
  .form-group select.error,
  .form-group input.error{
    border-color:#ef4444;
    background:#fef2f2;
  }
  .required{color:#ef4444;}
  
  /* Questions */
  .q{
    margin-top:14px;
    padding:14px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.08);
    background:#f8fafc;
    transition: border-color .2s;
  }
  .q.answered{
    border-color:#22c55e;
    background:#f0fdf4;
  }
  .q strong{display:block;margin-bottom:10px;font-size:1.02rem;}
  .choices{display:grid;gap:8px}
  .choice{
    display:flex;
    gap:10px;
    align-items:center;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    cursor:pointer;
    transition: all .15s;
  }
  .choice:hover{
    border-color:#667eea;
    background:rgba(102,126,234,.04);
  }
  .choice input[type="radio"]{
    width:18px;
    height:18px;
    accent-color:#667eea;
  }
  .choice.selected{
    border-color:#667eea;
    background:rgba(102,126,234,.08);
  }
  
  /* Buttons */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    border:0;
    border-radius:12px;
    padding:.85rem 1.5rem;
    font-weight:900;
    font-size:1rem;
    cursor:pointer;
    transition: all .2s;
  }
  .btn-primary{
    background: linear-gradient(135deg, #667eea, #764ba2);
    color:#fff;
    box-shadow: 0 4px 14px rgba(102,126,234,.35);
  }
  .btn-primary:hover{
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102,126,234,.45);
  }
  .btn-primary:disabled{
    opacity:.6;
    cursor:not-allowed;
    transform:none;
  }
  .bar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:16px;
    padding-top:16px;
    border-top:1px solid rgba(0,0,0,.08);
    justify-content:center;
  }
  
  /* Result */
  .result{
    margin-top:16px;
    padding:16px;
    border-radius:14px;
    display:none;
    text-align:center;
  }
  .result.show{display:block;}
  .result.success{
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    border:1px solid #22c55e;
  }
  .result.fail{
    background: linear-gradient(135deg, #fef2f2, #fecaca);
    border:1px solid #ef4444;
  }
  .result h3{margin:0 0 8px;font-size:1.1rem;}
  .result .score{font-size:2.5rem;font-weight:900;margin:8px 0;}
  
  /* Feedback */
  .feedback{margin-top:8px;font-size:.9rem;padding:8px 10px;border-radius:8px;}
  .feedback.correct{background:#dcfce7;color:#166534;}
  .feedback.wrong{background:#fef2f2;color:#991b1b;}
  
  /* Progress */
  .progress-bar{
    height:6px;
    background:#e2e8f0;
    border-radius:3px;
    margin-top:12px;
    overflow:hidden;
  }
  .progress-bar .fill{
    height:100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width .3s ease;
  }
  .progress-text{
    font-size:.85rem;
    color:#64748b;
    margin-top:6px;
    text-align:right;
  }
  
  /* Manual input */
  .manual-input{display:none;margin-top:8px;}
  .manual-input.show{display:block;}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="card">
    <div class="h1">üìù {{ topic.name }}</div>
    <div class="muted">Practice Mode ‚Ä¢ {{ questions|length }} Questions</div>

    <!-- Student Info Form -->
    <div class="student-form">
      <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏Ç‡∏≤ (Department) <span class="required">*</span></label>
          <select id="classroomSelect" onchange="loadStudents()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            {% for cls in classrooms %}
            <option value="{{ cls.id }}" data-name="{{ cls.name }}">{{ cls.name }}</option>
            {% endfor %}
            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)</option>
          </select>
          <input type="text" id="classroomManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å">
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Name) <span class="required">*</span></label>
          <select id="studentSelect">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
            <option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>
          </select>
          <input type="text" id="studentManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-bar">
      <div class="fill" id="progressFill" style="width:0%"></div>
    </div>
    <div class="progress-text" id="progressText">‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß 0 / {{ questions|length }} ‡∏Ç‡πâ‡∏≠</div>

    <!-- Questions -->
    <div id="questions">
      {% for q in questions %}
      <div class="q" data-qid="{{ q.id }}">
        <strong>{{ loop.index }}. {{ q.prompt }}</strong>
        <div class="choices">
          {% for ch in q.choices %}
          <label class="choice">
            <input type="radio" name="q{{ q.id }}" value="{{ ch }}">
            <span>{{ ch }}</span>
          </label>
          {% endfor %}
        </div>
        <div class="feedback" id="fb{{ q.id }}" style="display:none"></div>
      </div>
      {% endfor %}
    </div>

    <div class="bar">
      <button class="btn btn-primary" id="btnSubmit">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <div class="result" id="resultBox">
      <h3 id="resultTitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</h3>
      <div class="score" id="resultScore">0/0</div>
      <div class="muted" id="resultPercent">0%</div>
      <div id="resultMsg" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const token = {{ token|tojson }};
  const totalQuestions = {{ questions|length }};
  
  const btnSubmit = document.getElementById("btnSubmit");
  const resultBox = document.getElementById("resultBox");
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");
  
  const classroomSelect = document.getElementById("classroomSelect");
  const classroomManual = document.getElementById("classroomManual");
  const studentSelect = document.getElementById("studentSelect");
  const studentManual = document.getElementById("studentManual");

  // Load students when classroom is selected
  window.loadStudents = async function() {
    const classroomId = classroomSelect.value;
    
    if (classroomId === 'other') {
      classroomManual.classList.add('show');
      studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option><option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>';
      studentSelect.value = 'other';
      studentManual.classList.add('show');
      return;
    } else {
      classroomManual.classList.remove('show');
    }
    
    if (!classroomId) {
      studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option><option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>';
      studentManual.classList.remove('show');
      return;
    }
    
    try {
      const res = await fetch(`/api/public/classroom/${classroomId}/students`);
      const students = await res.json();
      
      let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>';
      students.forEach(s => {
        const display = s.student_no ? `${s.student_no}. ${s.student_name}` : s.student_name;
        html += `<option value="${s.student_name}">${display}</option>`;
      });
      html += '<option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>';
      studentSelect.innerHTML = html;
      studentManual.classList.remove('show');
    } catch(e) {
      console.error(e);
    }
  };
  
  studentSelect.addEventListener('change', function() {
    if (this.value === 'other') {
      studentManual.classList.add('show');
      studentManual.focus();
    } else {
      studentManual.classList.remove('show');
    }
  });

  function updateProgress(){
    let answered = 0;
    document.querySelectorAll(".q").forEach(q => {
      if(q.querySelector("input[type=radio]:checked")){
        answered++;
        q.classList.add("answered");
      } else {
        q.classList.remove("answered");
      }
    });
    const pct = totalQuestions > 0 ? (answered / totalQuestions * 100) : 0;
    progressFill.style.width = pct + "%";
    progressText.textContent = `‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${answered} / ${totalQuestions} ‡∏Ç‡πâ‡∏≠`;
  }

  document.querySelectorAll(".q input[type=radio]").forEach(radio => {
    radio.addEventListener("change", updateProgress);
  });

  document.querySelectorAll(".choice").forEach(choice => {
    choice.addEventListener("click", function(){
      const parent = this.closest(".choices");
      parent.querySelectorAll(".choice").forEach(c => c.classList.remove("selected"));
      this.classList.add("selected");
    });
  });

  function collectAnswers(){
    const answers = {};
    document.querySelectorAll(".q").forEach(q => {
      const qid = q.getAttribute("data-qid");
      const sel = q.querySelector("input[type=radio]:checked");
      answers[qid] = sel ? sel.value : "";
    });
    return answers;
  }

  function getStudentInfo() {
    let classroom = '';
    let studentName = '';
    
    if (classroomSelect.value === 'other') {
      classroom = classroomManual.value.trim();
    } else if (classroomSelect.value) {
      classroom = classroomSelect.options[classroomSelect.selectedIndex].dataset.name || classroomSelect.options[classroomSelect.selectedIndex].text;
    }
    
    if (studentSelect.value === 'other') {
      studentName = studentManual.value.trim();
    } else {
      studentName = studentSelect.value;
    }
    
    return { classroom, studentName };
  }

  btnSubmit.addEventListener("click", async () => {
    const { classroom, studentName } = getStudentInfo();

    if(!classroom){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
      classroomSelect.focus();
      return;
    }
    
    if(!studentName){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
      if(studentSelect.value === 'other') studentManual.focus();
      else studentSelect.focus();
      return;
    }

    const answers = collectAnswers();
    const unanswered = Object.values(answers).filter(a => !a).length;
    if(unanswered > 0){
      if(!confirm(`‡∏¢‡∏±‡∏á‡∏°‡∏µ ${unanswered} ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    }

    btnSubmit.disabled = true;
    btnSubmit.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

    try{
      const res = await fetch(`/api/p/${token}/submit`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          student_name: studentName,
          student_no: "",
          classroom: classroom,
          answers: answers
        })
      });

      const data = await res.json();
      if(!res.ok){
        alert(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = "üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
        return;
      }

      const pct = Math.round(data.percentage);
      const isPass = pct >= 50;
      
      resultBox.classList.add("show", isPass ? "success" : "fail");
      document.getElementById("resultTitle").textContent = isPass ? "üéâ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!" : "üí™ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!";
      document.getElementById("resultScore").textContent = `${data.score}/${data.total}`;
      document.getElementById("resultPercent").textContent = `${pct}%`;
      document.getElementById("resultMsg").innerHTML = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";

      const feedback = data.feedback || {};
      document.querySelectorAll(".q").forEach(q => {
        const qid = q.getAttribute("data-qid");
        const fb = document.getElementById(`fb${qid}`);
        const qfb = feedback[qid];
        if(qfb){
          fb.style.display = "block";
          fb.className = qfb.is_correct ? "feedback correct" : "feedback wrong";
          fb.innerHTML = qfb.is_correct ? "‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!" : `‚ùå ‡∏ú‡∏¥‡∏î ‚Äî ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: <strong>${qfb.correct_answer}</strong>`;
        }
      });

      // Disable everything
      document.querySelectorAll("input[type=radio], select, input[type=text]").forEach(el => el.disabled = true);
      resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
      btnSubmit.innerHTML = "‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";

    } catch(e) {
      console.error(e);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
      btnSubmit.disabled = false;
      btnSubmit.innerHTML = "üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
    }
  });

  updateProgress();
})();
</script>
{% endblock %}
