{% extends "base.html" %}
{% block title %}Sentence Builder - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #8b5cf6;
  --primary-dark: #7c3aed;
  --success: #22c55e;
  --danger: #ef4444;
  --warning: #f59e0b;
}

* { box-sizing: border-box; }

.game-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 1rem;
}

/* Header */
.game-header {
  background: linear-gradient(135deg, var(--primary), #a78bfa);
  color: #fff;
  padding: 1.5rem;
  border-radius: 16px;
  margin-bottom: 1rem;
  text-align: center;
}
.game-header h1 { margin: 0 0 0.5rem; font-size: 1.5rem; }
.game-header p { margin: 0; opacity: 0.9; }

/* Nav */
.nav-row {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}
.nav-btn {
  padding: 0.6rem 1rem;
  border-radius: 10px;
  font-weight: 700;
  text-decoration: none;
  background: #f1f5f9;
  color: #334155;
  border: 1px solid rgba(0,0,0,0.08);
}
.nav-btn:hover { background: #e2e8f0; }

/* Student Wheel Section */
.wheel-section {
  background: #fff;
  border-radius: 16px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.wheel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 1rem;
}
.wheel-header h3 { margin: 0; color: #334155; }

.student-input-row {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}
.student-input-row input {
  flex: 1;
  min-width: 200px;
  padding: 0.6rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 1rem;
}
.student-input-row input:focus {
  outline: none;
  border-color: var(--primary);
}
.student-input-row button {
  padding: 0.6rem 1rem;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}
.btn-add { background: var(--primary); color: #fff; }
.btn-clear-list { background: #f1f5f9; color: #64748b; }

.student-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
  min-height: 40px;
}
.student-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.4rem 0.8rem;
  background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
  color: #5b21b6;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
}
.student-tag button {
  background: none;
  border: none;
  color: #7c3aed;
  cursor: pointer;
  font-size: 1rem;
  padding: 0;
  line-height: 1;
}

/* Settings Row */
.settings-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin: 1.5rem 0;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px dashed #cbd5e1;
}
.settings-row label {
  font-weight: 700;
  color: #475569;
}
.settings-row select {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 1rem;
  color: #1e293b;
  cursor: pointer;
}

/* Wheel Canvas */
.wheel-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}
.wheel-wrapper {
  position: relative;
  width: 280px;
  height: 280px;
}
#wheelCanvas {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  box-shadow: 0 8px 30px rgba(139,92,246,0.3);
}
.wheel-pointer {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 2rem;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  z-index: 10;
}
.btn-spin {
  padding: 1rem 3rem;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(139,92,246,0.4);
  transition: all 0.2s;
}
.btn-spin:hover { transform: translateY(-2px); }
.btn-spin:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.selected-student {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--primary);
  text-align: center;
  padding: 1rem;
  background: linear-gradient(135deg, #f5f3ff, #ede9fe);
  border-radius: 12px;
  display: none;
  margin-top: 1rem;
}
.selected-student.show { display: block; }

/* Game Section */
.game-section {
  background: #fff;
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  display: none;
}
.game-section.active { display: block; }

/* Score Bar */
.score-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: linear-gradient(135deg, #f5f3ff, #ede9fe);
  border-radius: 12px;
  margin-bottom: 1rem;
}
.score-item { text-align: center; }
.score-value { font-size: 1.5rem; font-weight: 900; color: var(--primary); }
.score-label { font-size: 0.8rem; color: #64748b; text-transform: uppercase; }

/* Question Card */
.question-card {
  background: #f8fafc;
  border-radius: 16px;
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.question-number {
  display: inline-block;
  background: var(--primary);
  color: #fff;
  padding: 0.3rem 1rem;
  border-radius: 999px;
  font-weight: 800;
  font-size: 0.9rem;
  margin-bottom: 1rem;
}
.current-player {
  display: inline-block;
  background: var(--warning);
  color: #1e293b;
  padding: 0.3rem 1rem;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.85rem;
  margin-left: 0.5rem;
}

/* Question Sentence (Thai) */
.question-sentence {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
  text-align: center;
  padding: 2rem 1.5rem;
  background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
  border-radius: 12px;
  margin-bottom: 1.5rem;
  border: 2px solid #818cf8;
  box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
  position: relative;
}
.question-label {
  display: block;
  font-size: 0.9rem;
  color: #4338ca;
  margin-bottom: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.question-sentence::before {
  content: 'üáπüá≠';
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 1.5rem;
  opacity: 0.5;
}

/* Answer Zone */
.answer-zone {
  min-height: 90px;
  border: 3px dashed #cbd5e1;
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
  justify-content: center;
  background: #fff;
  transition: all 0.2s;
}
.answer-zone.active { border-color: var(--primary); background: #faf5ff; }
.answer-zone.correct { border-color: var(--success); background: #dcfce7; border-style: solid; }
.answer-zone.wrong { border-color: var(--danger); background: #fee2e2; border-style: solid; }
.answer-zone .placeholder { color: #94a3b8; font-style: italic; font-size: 1.1rem; }

.answer-token {
  padding: 0.6rem 1.2rem;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 1.1rem;
  box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
}
.answer-token:hover { background: var(--danger); transform: translateY(-2px); }

/* Word Pool */
.words-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: #f1f5f9;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
}
.word-token {
  padding: 0.7rem 1.4rem;
  background: #fff;
  color: #334155;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.15s;
}
.word-token:hover:not(:disabled) { 
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-3px); 
  box-shadow: 0 6px 12px rgba(139,92,246,0.15); 
}
.word-token:disabled { 
  opacity: 0.4; 
  cursor: not-allowed; 
  transform: none; 
  background: #cbd5e1;
  border-color: transparent;
  color: #64748b;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: wrap;
}
.btn {
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-secondary { background: #e2e8f0; color: #475569; }
.btn-secondary:hover { background: #cbd5e1; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #16a34a; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Feedback */
.feedback {
  text-align: center;
  padding: 1.5rem;
  border-radius: 12px;
  margin-top: 1rem;
  margin-bottom: 1rem;
  font-weight: 700;
  display: none;
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.feedback.show { display: block; }
.feedback.correct { background: #dcfce7; color: #15803d; border: 2px solid #22c55e; }
.feedback.wrong { background: #fee2e2; color: #b91c1c; border: 2px solid #ef4444; }
.correct-answer { margin-top: 0.5rem; font-weight: 600; font-size: 1.3rem; color: #1e293b; }

/* Result Screen */
.result-screen {
  display: none;
  text-align: center;
  padding: 2rem;
}
.result-screen.active { display: block; }
.result-emoji { font-size: 5rem; margin-bottom: 1rem; }
.result-title { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-bottom: 1rem; }
.result-score { font-size: 3rem; font-weight: 900; color: var(--primary); margin-bottom: 1.5rem; }
.result-details { 
  display: flex; 
  justify-content: center; 
  gap: 2rem; 
  margin-bottom: 2rem;
  flex-wrap: wrap;
}
.result-stat { text-align: center; }
.result-stat-value { font-size: 1.5rem; font-weight: 800; }
.result-stat-value.correct-text { color: var(--success); }
.result-stat-value.wrong-text { color: var(--danger); }
.result-stat-label { font-size: 0.85rem; color: #64748b; }

/* Leaderboard */
.leaderboard {
  background: #f8fafc;
  border-radius: 12px;
  padding: 1rem;
  margin-top: 1.5rem;
  text-align: left;
}
.leaderboard h4 { margin: 0 0 1rem; color: #334155; }
.leaderboard-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #e2e8f0;
}
.leaderboard-item:last-child { border-bottom: none; }
.leaderboard-rank { font-weight: 800; color: var(--primary); width: 30px; }
.leaderboard-name { flex: 1; font-weight: 600; }
.leaderboard-score { font-weight: 800; color: var(--success); }

/* Timer */
.timer { font-size: 2rem; font-weight: 900; color: var(--warning); }
.timer.danger { color: var(--danger); animation: pulse 0.5s infinite; }
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Sound Toggle */
.sound-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary);
  color: #fff;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(139,92,246,0.4);
  z-index: 100;
}

/* Editor Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:200;}
.modal-backdrop.show{display:flex;}
.modal{
  width:min(920px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:#fff;
  border-radius:16px;
  box-shadow:0 18px 60px rgba(0,0,0,.35);
  border:1px solid rgba(0,0,0,.08);
}
.modal-header{
  position:sticky;top:0;
  background:linear-gradient(135deg, var(--primary), #a78bfa);
  color:#fff;
  padding:1rem 1.25rem;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  border-top-left-radius:16px;border-top-right-radius:16px;
}
.modal-header h3{margin:0;font-size:1.1rem;}
.modal-body{padding:1.25rem;}
.modal-actions{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:flex-end;padding:0 1.25rem 1.25rem;}
.editor-table{width:100%;border-collapse:separate;border-spacing:0 10px;}
.editor-table th{font-size:.85rem;color:#64748b;text-align:left;padding:0 .5rem;}
.editor-row{
  background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;
}
.editor-row td{padding:.6rem .5rem;vertical-align:top;}
.editor-input{
  width:100%;
  padding:.65rem .75rem;
  border:2px solid #e2e8f0;
  border-radius:10px;
  font-size:1rem;
}
.editor-input:focus{outline:none;border-color:var(--primary);}
.btn-danger{background:var(--danger);color:#fff;}
.btn-danger:hover{background:#dc2626;}
.small-note{color:#64748b;font-size:.9rem;margin:.25rem 0 1rem;}

</style>
{% endblock %}

{% block content %}
<div class="game-container">
  <div class="nav-row">
    <a href="{{ url_for('topic_detail', topic_id=topic.id) }}" class="nav-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    <a href="{{ url_for('game', topic_id=topic.id) }}" class="nav-btn">üéØ Bamboozle</a>
    <a href="{{ url_for('game_memory', topic_id=topic.id) }}" class="nav-btn">üÉè Memory</a>
    <a href="#" class="nav-btn" onclick="openEditor(); return false;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</a>
  </div>

  <div class="game-header">
    <h1>üèóÔ∏è Sentence Builder (EN Words)</h1>
    <p>{{ topic.name }} ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
  </div>

  <div class="wheel-section">
    <div class="wheel-header">
      <h3>üé° ‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    </div>
    
    <div class="student-input-row">
      <input type="text" id="studentNameInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏û‡∏¥‡πà‡∏°" maxlength="50">
      <button class="btn-add" onclick="addStudent()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button class="btn-clear-list" onclick="clearStudents()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
    
    <div class="student-list" id="studentList">
      <span style="color:#94a3b8;font-style:italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
    </div>
    
    <div class="settings-row">
      <label for="qCount">üìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠:</label>
      <select id="qCount">
        <option value="10" selected>10 ‡∏Ç‡πâ‡∏≠</option>
        <option value="20">20 ‡∏Ç‡πâ‡∏≠</option>
        <option value="30">30 ‡∏Ç‡πâ‡∏≠</option>
        <option value="999">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>
    
    <div class="wheel-container">
      <div class="wheel-wrapper">
        <div class="wheel-pointer">üìç</div>
        <canvas id="wheelCanvas" width="280" height="280"></canvas>
      </div>
      <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center;">
        <button class="btn-spin" id="btnSpin" onclick="spinWheel()" disabled>üé∞ ‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠</button>
        <button class="btn btn-success" onclick="startSoloGame()">üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢</button>
      </div>
    </div>
    
    <div class="selected-student" id="selectedStudent"></div>
  </div>

  <div class="game-section" id="gameSection">
    <div class="score-bar">
      <div class="score-item">
        <div class="score-value" id="currentQ">1</div>
        <div class="score-label">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</div>
      </div>
      <div class="score-item">
        <div class="timer" id="timer">30</div>
        <div class="score-label">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
      </div>
      <div class="score-item">
        <div class="score-value" id="score">0</div>
        <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      </div>
    </div>

    <div class="question-card" id="questionCard">
      <div>
        <span class="question-number" id="questionNumber">Question 1</span>
        <span class="current-player" id="currentPlayer">üë§ -</span>
      </div>
      
      <div class="question-sentence">
        <span class="question-label">üáπüá≠ ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</span>
        <span id="questionText" style="display:block; margin-top:5px;">Loading...</span>
      </div>
      
      <div class="answer-zone" id="answerZone">
        <span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
      </div>
      
      <div class="words-container" id="wordsContainer"></div>
      
      <div class="feedback" id="feedback"></div>
      
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="clearAnswer()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
        <button class="btn btn-success" id="btnCheck" onclick="checkAnswer()">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        <button class="btn btn-primary" id="btnNext" onclick="nextQuestion()" style="display:none;">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Üí</button>
      </div>
    </div>

    <div class="result-screen" id="resultScreen">
      <div class="result-emoji" id="resultEmoji">üéâ</div>
      <div class="result-title" id="resultTitle">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</div>
      <div class="result-score" id="resultScore">0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      <div class="result-details">
        <div class="result-stat">
          <div class="result-stat-value correct-text" id="totalCorrect">0</div>
          <div class="result-stat-label">‡∏ñ‡∏π‡∏Å</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value wrong-text" id="totalWrong">0</div>
          <div class="result-stat-label">‡∏ú‡∏¥‡∏î</div>
        </div>
      </div>
      
      <div class="leaderboard" id="leaderboard" style="display:none;">
        <h4>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
        <div id="leaderboardList"></div>
      </div>
      
      <div class="action-buttons" style="margin-top:1.5rem;">
        <button class="btn btn-secondary" onclick="location.href='{{ url_for('topic_detail', topic_id=topic.id) }}'">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="btn btn-primary" onclick="restartGame()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </div>
  </div>
</div>


<!-- Sentence Editor Modal -->
<div class="modal-backdrop" id="editorBackdrop" onclick="onBackdropClick(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÑ‡∏ó‡∏¢ ‚Üí ‡πÄ‡∏â‡∏•‡∏¢‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</h3>
      <button class="btn btn-secondary" onclick="closeEditor()">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="small-note">
        ‚Ä¢ ‡πÉ‡∏™‡πà <b>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</b> ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞ <b>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</b> ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏â‡∏•‡∏¢ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏õ‡πá‡∏ô Tokens ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)<br>
        ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </div>
      <table class="editor-table">
        <thead>
          <tr>
            <th style="width:48%;">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (TH)</th>
            <th style="width:48%;">‡πÄ‡∏â‡∏•‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (EN)</th>
            <th style="width:4%;">‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody id="editorTbody"></tbody>
      </table>
      <div class="action-buttons" style="justify-content:flex-start; margin-top:.25rem;">
        <button class="btn btn-primary" onclick="addEditorRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</button>
        <button class="btn btn-secondary" onclick="loadCustomSentences(true)">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="fillFromExamples()">‚ú® ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Examples (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏¢) ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πà‡∏≤‡∏á</button>
      <button class="btn btn-success" onclick="saveCustomSentences()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>


<button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

<script>
// Data
const gameData = {{ game_data | tojson | safe }};
let students = {{ students | tojson | safe }} || [];

let customSentences = []; // [{th,en}] loaded from backend

// Sound System
let soundEnabled = true;
let audioContext = null;

function initAudio() {
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  return audioContext;
}
function playTone(freq, dur, type='sine', vol=0.3) {
  if(!soundEnabled) return;
  try {
    const ctx = initAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    osc.type = type;
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + dur);
  } catch(e){}
}
function playClickSound() { playTone(600, 0.08, 'sine', 0.2); }
function playDropSound() { playTone(400, 0.1, 'sine', 0.25); }
function playCorrectSound() { playTone(523, 0.15); setTimeout(()=>playTone(659, 0.15), 100); setTimeout(()=>playTone(784, 0.2), 200); }
function playWrongSound() { playTone(200, 0.4, 'square', 0.15); }
function playSpinSound() { let freq=200; for(let i=0;i<20;i++) setTimeout(()=>playTone(freq+i*30, 0.05, 'sine', 0.15), i*50); }
function playWinSound() { const n=[523,659,784,1047]; n.forEach((x,i)=>setTimeout(()=>playTone(x,0.3), i*150)); }
function playTickSound() { playTone(800, 0.05, 'sine', 0.1); }
function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá'; }

// Student Wheel
const colors = ['#8b5cf6', '#ec4899', '#06b6d4', '#22c55e', '#f59e0b', '#ef4444', '#6366f1', '#14b8a6', '#f97316', '#a855f7'];
document.getElementById('studentNameInput').addEventListener('keypress', function(e) { if(e.key === 'Enter') addStudent(); });

function addStudent() {
  const input = document.getElementById('studentNameInput');
  const name = input.value.trim();
  if(!name) return;
  if(students.includes(name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
  students.push(name);
  input.value = '';
  renderStudentList();
  drawWheel();
  document.getElementById('btnSpin').disabled = students.length < 2;
  playClickSound();
}
function removeStudent(index) {
  students.splice(index, 1);
  renderStudentList();
  drawWheel();
  document.getElementById('btnSpin').disabled = students.length < 2;
}
function clearStudents() {
  students = [];
  renderStudentList();
  drawWheel();
  document.getElementById('btnSpin').disabled = true;
}
function renderStudentList() {
  const list = document.getElementById('studentList');
  if(students.length === 0) list.innerHTML = '<span style="color:#94a3b8;font-style:italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>';
  else list.innerHTML = students.map((s, i) => `<span class="student-tag">${escapeHtml(s)} <button onclick="removeStudent(${i})">√ó</button></span>`).join('');
}

const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
let rotation = 0;
let isSpinning = false;

function drawWheel() {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const r = Math.min(cx, cy) - 5;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if(students.length === 0) {
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.fillStyle='#f1f5f9'; ctx.fill(); ctx.stroke();
    ctx.fillStyle='#94a3b8'; ctx.font='14px Prompt'; ctx.textAlign='center'; ctx.fillText('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', cx, cy);
    return;
  }
  const slice = (2*Math.PI) / students.length;
  students.forEach((s, i) => {
    const start = rotation + i * slice;
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, start+slice); ctx.closePath();
    ctx.fillStyle = colors[i % colors.length]; ctx.fill(); ctx.stroke();
    ctx.save(); ctx.translate(cx, cy); ctx.rotate(start + slice/2); ctx.textAlign='right';
    ctx.fillStyle='#fff'; ctx.font='bold 12px Prompt';
    ctx.fillText(s.length > 8 ? s.substring(0,8)+'...' : s, r-15, 4);
    ctx.restore();
  });
  ctx.beginPath(); ctx.arc(cx, cy, 20, 0, 2*Math.PI); ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
}

function spinWheel() {
  if(isSpinning || students.length < 2) return;
  isSpinning = true;
  document.getElementById('btnSpin').disabled = true;
  document.getElementById('selectedStudent').classList.remove('show');
  playSpinSound();
  
  const spins = 5 + Math.random() * 5;
  const target = rotation + spins * 2 * Math.PI;
  const startRot = rotation;
  const startTime = performance.now();
  
  function animate(time) {
    const p = Math.min((time - startTime) / 4000, 1);
    const ease = 1 - Math.pow(1 - p, 3);
    rotation = startRot + (target - startRot) * ease;
    drawWheel();
    if(p < 1) requestAnimationFrame(animate);
    else {
      isSpinning = false;
      document.getElementById('btnSpin').disabled = false;
      const slice = (2*Math.PI) / students.length;
      const norm = ((rotation % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
      const ptr = (3*Math.PI/2 - norm + 2*Math.PI) % (2*Math.PI);
      const winIdx = Math.floor(ptr / slice) % students.length;
      const winner = students[winIdx];
      const sel = document.getElementById('selectedStudent');
      sel.textContent = 'üéâ ' + winner + ' üéâ';
      sel.classList.add('show');
      playWinSound();
      setTimeout(() => { currentPlayerName = winner; startGameWithPlayer(winner); }, 1500);
    }
  }
  requestAnimationFrame(animate);
}

// ==========================================
// GAME LOGIC (TH Prompt -> EN Tokens)
// ==========================================
let questions = [];
let currentIndex = 0;
let score = 0;
let correctCount = 0;
let wrongCount = 0;
let answered = false;
let currentAnswer = [];
let currentWords = [];
let currentPlayerName = '';
let timerInterval = null;
let timeLeft = 30;
let playerScores = {};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Tokens (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á + ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô)
// - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏≠‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® '
// - ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ? ! . , ; : ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏á‡πà‡∏≤‡∏¢
function splitEnglishTokens(text) {
  if (!text) return [];
  const cleaned = String(text)
    .replace(/[‚Äú‚Äù]/g, '"')
    .replace(/[‚Äô]/g, "'")
    .replace(/[?!.,;:]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  if (!cleaned) return [];
  return cleaned.split(' ').filter(Boolean);
}

function prepareQuestions() {
  const result = [];

  // 0) Custom sentences (teacher-edited)
  if (Array.isArray(customSentences) && customSentences.length > 0) {
    customSentences.forEach(it => {
      if (!it) return;
      const th = (it.th || '').trim();
      const en = (it.en || '').trim();
      if (th && en && /[‡∏Å-‡πô]/.test(th)) {
        result.push({
          prompt: th,
          target: en.replace(/\s+/g, ' ').trim(),
          words: splitEnglishTokens(en)
        });
      }
    });
  }

  // 1. ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Examples

  
  // 1. ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Examples
  if (gameData.examples && gameData.examples.length > 0) {
    gameData.examples.forEach(ex => {
      // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á EN ‡πÅ‡∏•‡∏∞ TH
      if (ex.en && ex.th) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
        const hasThaiChar = /[‡∏Å-‡πô]/.test(ex.th);
        
        if (hasThaiChar) {
          result.push({
            prompt: ex.th, // ‡πÇ‡∏à‡∏ó‡∏¢‡πå = ‡πÑ‡∏ó‡∏¢
            target: ex.en.replace(/\s+/g, ' ').trim(), // ‡πÄ‡∏â‡∏•‡∏¢ = ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
            words: splitEnglishTokens(ex.en) // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏õ‡πá‡∏ô Tokens
          });
        }
      }
    });
  }
  
  // Shuffle ‡πÇ‡∏à‡∏ó‡∏¢‡πå
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  
  const qLimit = parseInt(document.getElementById('qCount').value) || 10;
  return result.slice(0, qLimit);
}

function startSoloGame() {
  currentPlayerName = 'Player';
  startGameWithPlayer('Player');
}

function startGameWithPlayer(playerName) {
  document.getElementById('gameSection').classList.add('active');
  document.getElementById('currentPlayer').textContent = 'üë§ ' + playerName;
  
  questions = prepareQuestions();
  
  if (questions.length === 0) {
    document.getElementById('questionText').innerHTML = '<span style="color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Topic ‡∏ô‡∏µ‡πâ</span>';
    return;
  } else {
    document.getElementById('questionText').style.color = '#1e293b';
  }
  
  currentIndex = 0;
  score = 0;
  correctCount = 0;
  wrongCount = 0;
  
  loadQuestion();
}

function loadQuestion() {
  if (currentIndex >= questions.length) {
    showResult();
    return;
  }
  
  answered = false;
  currentAnswer = [];
  const q = questions[currentIndex];
  
  // Update UI
  document.getElementById('currentQ').textContent = currentIndex + 1;
  document.getElementById('questionNumber').textContent = `Question ${currentIndex + 1}/${questions.length}`;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  document.getElementById('questionText').textContent = q.prompt;
  
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© & Shuffle
  currentWords = [...q.words];
  let scrambled = [...currentWords];
  let attempts = 0;
  do {
    for (let i = scrambled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
    }
    attempts++;
  } while (scrambled.join(' ') === currentWords.join(' ') && scrambled.length > 1 && attempts < 10);
  
  renderWords(scrambled);
  
  // Reset Answer Zone
  const answerZone = document.getElementById('answerZone');
  answerZone.innerHTML = '<span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
  answerZone.className = 'answer-zone';
  
  document.getElementById('feedback').classList.remove('show');
  document.getElementById('feedback').className = 'feedback';
  document.getElementById('btnCheck').style.display = 'inline-block';
  document.getElementById('btnNext').style.display = 'none';
  
  startTimer();
}

function renderWords(words) {
  const container = document.getElementById('wordsContainer');
  container.innerHTML = words.map((word, i) => `
    <button class="word-token" data-word="${escapeHtml(word)}" data-idx="${i}" onclick="addWord(this)">
      ${escapeHtml(word)}
    </button>
  `).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addWord(btn) {
  if (answered || btn.disabled) return;
  playClickSound();
  currentAnswer.push({ word: btn.dataset.word, btn: btn });
  btn.disabled = true;
  updateAnswerZone();
}

function removeWord(index) {
  if (answered) return;
  playDropSound();
  const removed = currentAnswer.splice(index, 1)[0];
  if (removed && removed.btn) removed.btn.disabled = false;
  updateAnswerZone();
}

function updateAnswerZone() {
  const answerZone = document.getElementById('answerZone');
  if (currentAnswer.length === 0) {
    answerZone.innerHTML = '<span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
    answerZone.classList.remove('active');
  } else {
    answerZone.classList.add('active');
    answerZone.innerHTML = currentAnswer.map((item, i) => 
      `<button class="answer-token" onclick="removeWord(${i})">${escapeHtml(item.word)}</button>`
    ).join('');
  }
}

function clearAnswer() {
  if (answered) return;
  currentAnswer.forEach(item => { if(item.btn) item.btn.disabled = false; });
  currentAnswer = [];
  updateAnswerZone();
}

function startTimer() {
  timeLeft = 30; 
  updateTimerDisplay();
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 5) { document.getElementById('timer').classList.add('danger'); playTickSound(); }
    if (timeLeft <= 0) { clearInterval(timerInterval); if (!answered) checkAnswer(true); }
  }, 1000);
}
function updateTimerDisplay() {
  document.getElementById('timer').textContent = timeLeft;
  if (timeLeft > 5) document.getElementById('timer').classList.remove('danger');
}

function normalizeEnglish(text) {
  return String(text || '')
    .replace(/[‚Äú‚Äù]/g, '"')
    .replace(/[‚Äô]/g, "'")
    .replace(/[?!.,;:]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase();
}

function checkAnswer(autoSubmit = false) {
  if (answered) return;
  clearInterval(timerInterval);
  answered = true;
  
  const q = questions[currentIndex];
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)
  const userAnswer = currentAnswer.map(a => a.word).join(' ').trim();
  const correctAnswer = normalizeEnglish(q.target);
  
  // Compare (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥)
  const isCorrect = normalizeEnglish(userAnswer) === correctAnswer;
  
  const answerZone = document.getElementById('answerZone');
  const feedback = document.getElementById('feedback');
  document.querySelectorAll('.word-token').forEach(b => b.disabled = true);
  
  if (isCorrect) {
    playCorrectSound();
    answerZone.classList.add('correct');
    const bonus = Math.max(0, timeLeft);
    const points = 10 + bonus;
    score += points;
    correctCount++;
    feedback.innerHTML = `‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! +${points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
    feedback.className = 'feedback show correct';
  } else {
    playWrongSound();
    answerZone.classList.add('wrong');
    wrongCount++;
    feedback.innerHTML = `‚ùå ‡πÄ‡∏â‡∏•‡∏¢: <div class="correct-answer">${escapeHtml(q.target)}</div>`;
    feedback.className = 'feedback show wrong';
  }
  
  document.getElementById('score').textContent = score;
  document.getElementById('btnCheck').style.display = 'none';
  document.getElementById('btnNext').style.display = 'inline-block';
}

function nextQuestion() {
  currentIndex++;
  if (students.length >= 2 && currentIndex < questions.length) {
    document.getElementById('gameSection').classList.remove('active');
    setTimeout(() => spinWheel(), 500);
  } else {
    loadQuestion();
  }
}

function showResult() {
  clearInterval(timerInterval);
  playWinSound();
  if (currentPlayerName) playerScores[currentPlayerName] = (playerScores[currentPlayerName] || 0) + score;
  
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('resultScreen').classList.add('active');
  document.getElementById('resultScore').textContent = score + ' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
  document.getElementById('totalCorrect').textContent = correctCount;
  document.getElementById('totalWrong').textContent = wrongCount;
  
  if (Object.keys(playerScores).length > 1) {
    const leaderboard = document.getElementById('leaderboard');
    leaderboard.style.display = 'block';
    const sorted = Object.entries(playerScores).sort((a, b) => b[1] - a[1]);
    document.getElementById('leaderboardList').innerHTML = sorted.map(([name, s], i) => 
      `<div class="leaderboard-item">
         <span class="leaderboard-rank">${i+1}.</span>
         <span class="leaderboard-name">${escapeHtml(name)}</span>
         <span class="leaderboard-score">${s} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
       </div>`).join('');
  }
}

function restartGame() {
  document.getElementById('questionCard').style.display = 'block';
  document.getElementById('resultScreen').classList.remove('active');
  document.getElementById('gameSection').classList.remove('active');
  document.getElementById('selectedStudent').classList.remove('show');
  document.getElementById('score').textContent = '0';
  if (students.length >= 2) spinWheel();
  else { currentPlayerName = 'Player'; startGameWithPlayer('Player'); }
}


// ===============================
// Editor Modal (CRUD custom sentences)
// ===============================
const TOPIC_ID = {{ topic.id }};
function openEditor(){
  document.getElementById('editorBackdrop').classList.add('show');
  loadCustomSentences(false);
}
function closeEditor(){
  document.getElementById('editorBackdrop').classList.remove('show');
}
function onBackdropClick(e){
  closeEditor();
}
function addEditorRow(thVal='', enVal=''){
  const tb = document.getElementById('editorTbody');
  const tr = document.createElement('tr');
  tr.className = 'editor-row';
  tr.innerHTML = `
    <td><textarea class="editor-input" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡∏∞">${escapeHtml(thVal)}</textarea></td>
    <td><textarea class="editor-input" rows="2" placeholder="e.g. What time is checkout?">${escapeHtml(enVal)}</textarea></td>
    <td style="text-align:center;">
      <button class="btn btn-danger" style="padding:.55rem .8rem;" onclick="this.closest('tr').remove()">√ó</button>
    </td>
  `;
  tb.appendChild(tr);
}
async function loadCustomSentences(showToast){
  try{
    const res = await fetch(`/api/topic/${TOPIC_ID}/sentence-builder/custom`, {headers:{'Accept':'application/json'}});
    const data = await res.json();
    customSentences = (data.items || []);
    const tb = document.getElementById('editorTbody');
    tb.innerHTML = '';
    if(customSentences.length === 0){
      addEditorRow('', '');
      addEditorRow('', '');
      addEditorRow('', '');
    }else{
      customSentences.forEach(it => addEditorRow(it.th||'', it.en||''));
    }
    if(showToast) alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}
function collectEditorRows(){
  const rows = Array.from(document.querySelectorAll('#editorTbody tr'));
  const items = [];
  rows.forEach(r=>{
    const tds = r.querySelectorAll('textarea');
    const th = (tds[0]?.value || '').trim();
    const en = (tds[1]?.value || '').trim();
    if(th || en) items.push({th, en});
  });
  return items;
}
async function saveCustomSentences(){
  const items = collectEditorRows();
  try{
    const res = await fetch(`/api/topic/${TOPIC_ID}/sentence-builder/custom`, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify({items})
    });
    const data = await res.json();
    if(!data.ok) throw new Error('not ok');
    customSentences = data.items || [];
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    closeEditor();
  }catch(e){
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}
function fillFromExamples(){
  const existing = new Set((collectEditorRows()||[]).map(it => (it.th||'').trim() + '||' + (it.en||'').trim()));
  const toAdd = [];
  if (gameData.examples && Array.isArray(gameData.examples)){
    gameData.examples.forEach(ex=>{
      if(!ex || !ex.en || !ex.th) return;
      const th = String(ex.th).trim();
      const en = String(ex.en).trim();
      if(!th || !en) return;
      if(!/[‡∏Å-‡πô]/.test(th)) return;
      const key = th + '||' + en;
      if(!existing.has(key)){
        existing.add(key);
        toAdd.push({th, en});
      }
    });
  }
  toAdd.forEach(it=>addEditorRow(it.th, it.en));
  alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å Examples ‡πÅ‡∏•‡πâ‡∏ß');
}

// Load custom sentences silently on page load (so game uses them immediately)
(async ()=>{ 
  try{ 
    const r=await fetch(`/api/topic/${TOPIC_ID}/sentence-builder/custom`,{headers:{'Accept':'application/json'}}); 
    const d=await r.json(); 
    customSentences = (d.items||[]); 
  }catch(e){} 
})();

renderStudentList();
drawWheel();
if (students.length < 2) document.getElementById('btnSpin').disabled = true;
</script>
{% endblock %}
