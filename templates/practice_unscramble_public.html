{% extends "base.html" %}
{% block title %}Sentence Unscramble | {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
  .wrap{max-width:1000px;margin:1.25rem auto;padding:0 1rem;}
  .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);}
  .h1{font-size:1.25rem;font-weight:900;margin-bottom:.25rem;}
  .muted{color:#64748b;font-size:.95rem;}
  
  .student-form{
    background: linear-gradient(135deg, #f9731615, #ea580c15);
    border:1px solid rgba(249,115,22,.2);
    border-radius:14px;
    padding:16px;
    margin-bottom:16px;
  }
  .student-form h3{margin:0 0 12px;font-size:1rem;color:#c2410c;}
  .form-grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
  @media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
  .form-group label{display:block;font-weight:800;font-size:.9rem;margin-bottom:4px;color:#334155;}
  .form-group select,.form-group input{width:100%;padding:.7rem .85rem;border-radius:10px;border:1px solid rgba(0,0,0,.15);outline:none;font-size:1rem;background:#fff;}
  .form-group select:focus,.form-group input:focus{border-color:#f97316;box-shadow: 0 0 0 3px rgba(249,115,22,.15);}
  .required{color:#ef4444;}
  
  .progress-bar{height:6px;background:#e2e8f0;border-radius:3px;margin-top:12px;overflow:hidden;}
  .progress-bar .fill{height:100%;background: linear-gradient(90deg, #f97316, #ea580c);transition: width .3s ease;}
  .progress-text{font-size:.85rem;color:#64748b;margin-top:6px;text-align:right;}
  
  .q{margin-top:14px;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f8fafc;transition: border-color .2s;}
  .q.answered{border-color:#22c55e;background:#f0fdf4;}
  .q strong{display:block;margin-bottom:6px;font-size:1.02rem;}
  .hint-text{color:#94a3b8;font-size:.85rem;margin-bottom:12px;font-style:italic;}
  
  .answer-zone{min-height:60px;border:3px dashed #cbd5e1;border-radius:12px;padding:.75rem;margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;justify-content:center;background:#fff;transition: all .2s;}
  .answer-zone.active{border-color:#f97316;background:#fff7ed;}
  .answer-zone.correct{border-color:#22c55e;background:#dcfce7;border-style:solid;}
  .answer-zone.wrong{border-color:#ef4444;background:#fee2e2;border-style:solid;}
  .answer-zone .placeholder{color:#94a3b8;font-style:italic;}
  
  .words-container{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:.75rem;}
  .word-token{padding:.6rem 1rem;background: linear-gradient(135deg, #f97316, #ea580c);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 3px 8px rgba(249,115,22,.3);transition: all .15s;}
  .word-token:hover:not(:disabled){transform:translateY(-2px);}
  .word-token:disabled{opacity:.4;cursor:not-allowed;}
  
  .answer-token{padding:.4rem .8rem;background:#f97316;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition: all .15s;}
  .answer-token:hover{background:#ef4444;}
  
  .feedback{margin-top:8px;font-size:.9rem;padding:8px 10px;border-radius:8px;display:none;text-align:center;}
  .feedback.show{display:block;}
  .feedback.correct{background:#dcfce7;color:#166534;}
  .feedback.wrong{background:#fef2f2;color:#991b1b;}
  
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:0;border-radius:12px;padding:.85rem 1.5rem;font-weight:900;font-size:1rem;cursor:pointer;transition: all .2s;}
  .btn-primary{background: linear-gradient(135deg, #f97316, #ea580c);color:#fff;box-shadow: 0 4px 14px rgba(249,115,22,.35);}
  .btn-primary:hover{transform: translateY(-2px);}
  .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none;}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid rgba(0,0,0,.08);justify-content:center;}
  
  .result{margin-top:16px;padding:16px;border-radius:14px;display:none;text-align:center;}
  .result.show{display:block;}
  .result.success{background: linear-gradient(135deg, #dcfce7, #bbf7d0);border:1px solid #22c55e;}
  .result.fail{background: linear-gradient(135deg, #fef2f2, #fecaca);border:1px solid #ef4444;}
  .result h3{margin:0 0 8px;font-size:1.1rem;}
  .result .score{font-size:2.5rem;font-weight:900;margin:8px 0;}
  
  .manual-input{display:none;margin-top:8px;}
  .manual-input.show{display:block;}
  
  .sound-toggle{position:fixed;bottom:15px;right:15px;width:45px;height:45px;border-radius:50%;background:#f97316;color:#fff;border:none;font-size:1.3rem;cursor:pointer;box-shadow:0 4px 12px rgba(249,115,22,.4);}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="card">
    <div class="h1">üîÄ Sentence Unscramble</div>
    <div class="muted">{{ topic.name }} ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>

    <div class="student-form">
      <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏Ç‡∏≤ <span class="required">*</span></label>
          <select id="classroomSelect" onchange="loadStudents()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            {% for cls in classrooms %}
            <option value="{{ cls.id }}" data-name="{{ cls.name }}">{{ cls.name }}</option>
            {% endfor %}
            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)</option>
          </select>
          <input type="text" id="classroomManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å">
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
          <select id="studentSelect">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
            <option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>
          </select>
          <input type="text" id="studentManual" class="manual-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>
      </div>
    </div>

    <div class="progress-bar"><div class="fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß 0 / 0 ‡∏Ç‡πâ‡∏≠</div>

    <div id="questionsContainer"></div>

    <div class="bar">
      <button class="btn btn-primary" id="btnSubmit">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <div class="result" id="resultBox">
      <h3 id="resultTitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</h3>
      <div class="score" id="resultScore">0/0</div>
      <div class="muted" id="resultPercent">0%</div>
      <div id="resultMsg" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

<script>
const practiceData = {{ practice_data | tojson | safe }};
const token = "{{ token }}";

let soundEnabled = true;
let audioContext = null;
function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); return audioContext; }
function playTone(freq, dur, type = 'sine', vol = 0.3) {
  if (!soundEnabled) return;
  try { const ctx = initAudio(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = freq; osc.type = type;
    gain.gain.setValueAtTime(vol, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + dur);
  } catch (e) {}
}
function playCorrectSound() { playTone(523, 0.15); setTimeout(() => playTone(659, 0.15), 100); setTimeout(() => playTone(784, 0.2), 200); }
function playWrongSound() { playTone(200, 0.3, 'square', 0.15); }
function playClickSound() { playTone(500, 0.08, 'sine', 0.2); }
function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá'; }

const classroomSelect = document.getElementById("classroomSelect");
const classroomManual = document.getElementById("classroomManual");
const studentSelect = document.getElementById("studentSelect");
const studentManual = document.getElementById("studentManual");

window.loadStudents = async function() {
  const cid = classroomSelect.value;
  if (cid === 'other') { classroomManual.classList.add('show'); studentSelect.value = 'other'; studentManual.classList.add('show'); return; }
  classroomManual.classList.remove('show');
  if (!cid) { studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option><option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>'; studentManual.classList.remove('show'); return; }
  try {
    const res = await fetch(`/api/public/classroom/${cid}/students`);
    const students = await res.json();
    let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>';
    students.forEach(s => { html += `<option value="${s.student_name}">${s.student_no ? s.student_no + '. ' : ''}${s.student_name}</option>`; });
    html += '<option value="other">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</option>';
    studentSelect.innerHTML = html;
    studentManual.classList.remove('show');
  } catch(e) { console.error(e); }
};
studentSelect.addEventListener('change', function() { if (this.value === 'other') { studentManual.classList.add('show'); studentManual.focus(); } else { studentManual.classList.remove('show'); } });

let questions = [];
let userAnswers = {};
let questionStates = {};

function init() {
  questions = prepareQuestions();
  if (questions.length === 0) { 
    document.getElementById('questionsContainer').innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ô‡∏µ‡πâ</p>'; 
    return; 
  }
  questions.forEach(q => {
    questionStates[q.id] = { selectedWords: [], availableButtons: [] };
  });
  renderQuestions();
  updateProgress();
}

function prepareQuestions() {
  const result = [];
  if (practiceData.examples && practiceData.examples.length > 0) {
    practiceData.examples.forEach((ex, i) => {
      if (ex.en && ex.en.split(' ').length >= 3) {
        result.push({ id: i, sentence: ex.en.replace(/[.!?]$/, ''), hint: ex.th || '', words: ex.en.replace(/[.!?]$/, '').split(' ') });
      }
    });
  }
  if (practiceData.vocabulary && practiceData.vocabulary.length > 0) {
    practiceData.vocabulary.forEach((v, i) => {
      if (v.example && v.example.split(' ').length >= 3) {
        result.push({ id: 100 + i, sentence: v.example.replace(/[.!?]$/, ''), hint: v.meaning || '', words: v.example.replace(/[.!?]$/, '').split(' ') });
      }
    });
  }
  for (let i = result.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [result[i], result[j]] = [result[j], result[i]]; }
  return result.slice(0, 10);
}

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

function renderQuestions() {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = questions.map((q, idx) => {
    const scrambled = shuffleArray(q.words);
    return `<div class="q" id="q${q.id}" data-qid="${q.id}">
      <strong>${idx + 1}. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</strong>
      ${q.hint ? `<div class="hint-text">üí° ${escapeHtml(q.hint)}</div>` : ''}
      <div class="answer-zone" id="answer${q.id}"><span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</span></div>
      <div class="words-container" id="words${q.id}">
        ${scrambled.map((w, wi) => `<button class="word-token" data-qid="${q.id}" data-word="${escapeHtml(w)}" data-idx="${wi}" onclick="addWord(${q.id}, this)">${escapeHtml(w)}</button>`).join('')}
      </div>
      <div class="feedback" id="fb${q.id}"></div>
    </div>`;
  }).join('');
}

window.addWord = function(qid, btn) {
  if (btn.disabled || document.getElementById('btnSubmit').disabled) return;
  playClickSound();
  
  const state = questionStates[qid];
  state.selectedWords.push({ word: btn.dataset.word, btn: btn });
  btn.disabled = true;
  state.availableButtons.push(btn);
  
  updateAnswerZone(qid);
  checkAnswered(qid);
};

window.removeWord = function(qid, index) {
  if (document.getElementById('btnSubmit').disabled) return;
  playClickSound();
  
  const state = questionStates[qid];
  const removed = state.selectedWords.splice(index, 1)[0];
  if (removed && removed.btn) removed.btn.disabled = false;
  
  updateAnswerZone(qid);
  checkAnswered(qid);
};

function updateAnswerZone(qid) {
  const zone = document.getElementById('answer' + qid);
  const state = questionStates[qid];
  
  if (state.selectedWords.length === 0) {
    zone.innerHTML = '<span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</span>';
    zone.classList.remove('active');
  } else {
    zone.classList.add('active');
    zone.innerHTML = state.selectedWords.map((item, i) => 
      `<button class="answer-token" onclick="removeWord(${qid}, ${i})">${escapeHtml(item.word)}</button>`
    ).join('');
  }
}

function checkAnswered(qid) {
  const q = questions.find(x => x.id === qid);
  const state = questionStates[qid];
  const qEl = document.getElementById('q' + qid);
  
  if (state.selectedWords.length === q.words.length) {
    qEl.classList.add('answered');
    userAnswers[qid] = state.selectedWords.map(s => s.word);
  } else {
    qEl.classList.remove('answered');
    delete userAnswers[qid];
  }
  updateProgress();
}

function updateProgress() {
  const answered = Object.keys(userAnswers).length;
  const total = questions.length;
  document.getElementById('progressFill').style.width = (total > 0 ? answered / total * 100 : 0) + '%';
  document.getElementById('progressText').textContent = `‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${answered} / ${total} ‡∏Ç‡πâ‡∏≠`;
}

function getStudentInfo() {
  let classroom = classroomSelect.value === 'other' ? classroomManual.value.trim() : (classroomSelect.value ? (classroomSelect.options[classroomSelect.selectedIndex].dataset.name || classroomSelect.options[classroomSelect.selectedIndex].text) : '');
  let studentName = studentSelect.value === 'other' ? studentManual.value.trim() : studentSelect.value;
  return { classroom, studentName };
}

document.getElementById('btnSubmit').addEventListener('click', async () => {
  const { classroom, studentName } = getStudentInfo();
  if (!classroom) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á'); return; }
  if (!studentName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á'); return; }
  
  let unanswered = 0;
  questions.forEach(q => { if (!userAnswers[q.id] || userAnswers[q.id].length !== q.words.length) unanswered++; });
  if (unanswered > 0 && !confirm(`‡∏¢‡∏±‡∏á‡∏°‡∏µ ${unanswered} ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
  
  let score = 0;
  questions.forEach(q => {
    const userAns = userAnswers[q.id] || [];
    const correct = q.words.join(' ');
    const userStr = userAns.join(' ');
    const isCorrect = userStr.toLowerCase() === correct.toLowerCase();
    
    const zone = document.getElementById('answer' + q.id);
    const fb = document.getElementById('fb' + q.id);
    
    document.querySelectorAll(`#words${q.id} .word-token`).forEach(b => b.disabled = true);
    
    if (isCorrect) {
      score++;
      zone.classList.add('correct');
      fb.className = 'feedback show correct';
      fb.innerHTML = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
    } else {
      playWrongSound();
      zone.classList.add('wrong');
      fb.className = 'feedback show wrong';
      fb.innerHTML = `‚ùå ‡∏ú‡∏¥‡∏î ‚Äî ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: <strong>${correct}</strong>`;
    }
  });
  if (score > 0) playCorrectSound();
  
  try { 
    await fetch(`/api/public/unscramble/${token}/submit`, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ student_name: studentName, student_no: "", classroom: classroom, score: score, total: questions.length, answers: userAnswers }) 
    }); 
  } catch (e) { console.error(e); }
  
  const pct = Math.round(score / questions.length * 100);
  const isPass = pct >= 50;
  const resultBox = document.getElementById('resultBox');
  resultBox.classList.add('show', isPass ? 'success' : 'fail');
  document.getElementById('resultTitle').textContent = isPass ? 'üéâ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!' : 'üí™ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!';
  document.getElementById('resultScore').textContent = `${score}/${questions.length}`;
  document.getElementById('resultPercent').textContent = `${pct}%`;
  document.getElementById('resultMsg').innerHTML = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
  
  document.querySelectorAll('select, input[type=text]').forEach(el => el.disabled = true);
  resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
  btnSubmit.innerHTML = '‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
});

init();
</script>
{% endblock %}
