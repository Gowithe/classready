<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentence Unscramble - {{ topic.name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    :root {
      --primary: #f59e0b;
      --primary-dark: #d97706;
      --success: #22c55e;
      --danger: #ef4444;
    }
    .container { max-width: 700px; margin: 0 auto; }
    
    .name-form {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.1);
      text-align: center;
    }
    .name-form h1 { color: var(--primary); margin-bottom: 0.5rem; }
    .name-form p { color: #64748b; margin-bottom: 1.5rem; }
    .name-form input {
      width: 100%;
      max-width: 300px;
      padding: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    .name-form input:focus { outline: none; border-color: var(--primary); }
    .btn-start {
      padding: 1rem 3rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-start:hover { background: var(--primary-dark); }
    
    .practice-container { display: none; }
    .practice-container.active { display: block; }
    
    .progress-section {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s;
    }
    
    .question-card {
      background: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.1);
      margin-bottom: 1rem;
    }
    .question-number {
      display: inline-block;
      background: var(--primary);
      color: #fff;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    .instruction {
      text-align: center;
      color: #64748b;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .hint-text {
      text-align: center;
      color: #94a3b8;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      font-style: italic;
    }
    
    .answer-zone {
      min-height: 60px;
      border: 3px dashed #cbd5e1;
      border-radius: 12px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
    }
    .answer-zone.correct { border-color: var(--success); background: #dcfce7; border-style: solid; }
    .answer-zone.wrong { border-color: var(--danger); background: #fee2e2; border-style: solid; }
    .answer-zone .placeholder { color: #94a3b8; font-style: italic; }
    
    .words-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .word-token {
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(245,158,11,.3);
    }
    .word-token:hover:not(:disabled) { transform: translateY(-2px); }
    .word-token:disabled { opacity: 0.4; cursor: not-allowed; }
    
    .answer-token {
      padding: 0.4rem 0.8rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .answer-token:hover { background: var(--danger); }
    
    .feedback {
      text-align: center;
      padding: 0.75rem;
      border-radius: 10px;
      margin-top: 0.75rem;
      font-weight: 700;
      display: none;
    }
    .feedback.show { display: block; }
    .feedback.correct { background: #dcfce7; color: #166534; }
    .feedback.wrong { background: #fee2e2; color: #991b1b; }
    .correct-answer { margin-top: 0.5rem; font-weight: 600; color: #166534; }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .btn {
      padding: 0.6rem 1.5rem;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-primary { background: var(--primary); color: #fff; }
    
    .result-screen {
      display: none;
      text-align: center;
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.1);
    }
    .result-screen.active { display: block; }
    .result-emoji { font-size: 4rem; margin-bottom: 0.5rem; }
    .result-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; }
    .result-score { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 1rem; }
    .result-details { display: flex; justify-content: center; gap: 2rem; margin-bottom: 1.5rem; }
    .result-stat { text-align: center; }
    .result-stat-value { font-size: 1.3rem; font-weight: 800; }
    .result-stat-value.correct { color: var(--success); }
    .result-stat-value.wrong { color: var(--danger); }
    .result-stat-label { font-size: 0.8rem; color: #64748b; }
    
    .sound-toggle {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="name-form" id="nameForm">
    <h1>üîÄ Sentence Unscramble</h1>
    <p>{{ topic.name }}</p>
    <input type="text" id="studentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" maxlength="100">
    <br>
    <button class="btn-start" onclick="startPractice()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</button>
  </div>
  
  <div class="practice-container" id="practiceContainer">
    <div class="progress-section">
      <div class="progress-header">
        <span>Question <span id="currentNum">1</span> / <span id="totalNum">10</span></span>
        <span>Score: <span id="score">0</span></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="question-card" id="questionCard">
      <div class="question-number" id="questionNumber">Question 1</div>
      <p class="instruction">üîÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
      <p class="hint-text" id="hintText"></p>
      
      <div class="answer-zone" id="answerZone">
        <span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</span>
      </div>
      
      <div class="words-container" id="wordsContainer"></div>
      
      <div class="feedback" id="feedback"></div>
      
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="clearAnswer()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
        <button class="btn btn-success" id="checkBtn" onclick="checkAnswer()">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à</button>
        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display:none;">Next ‚Üí</button>
      </div>
    </div>
    
    <div class="result-screen" id="resultScreen">
      <div class="result-emoji" id="resultEmoji">üéâ</div>
      <div class="result-title" id="resultTitle">Great Job!</div>
      <div class="result-score" id="resultScore">80%</div>
      <div class="result-details">
        <div class="result-stat">
          <div class="result-stat-value correct" id="correctCount">8</div>
          <div class="result-stat-label">Correct</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value wrong" id="wrongCount">2</div>
          <div class="result-stat-label">Wrong</div>
        </div>
      </div>
      <p style="color:#64748b;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</p>
    </div>
  </div>
</div>

<button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

<script>
const practiceData = {{ practice_data | tojson | safe }};
const token = "{{ token }}";
let studentName = "";

let soundEnabled = true;
let audioContext = null;
function initAudio() {
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  return audioContext;
}
function playTone(freq, dur, type = 'sine', vol = 0.3) {
  if (!soundEnabled) return;
  try {
    const ctx = initAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.value = freq; osc.type = type;
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + dur);
  } catch (e) {}
}
function playCorrectSound() { playTone(523, 0.15); setTimeout(() => playTone(659, 0.15), 100); setTimeout(() => playTone(784, 0.2), 200); }
function playWrongSound() { playTone(200, 0.3, 'square', 0.15); }
function playWinSound() { [523, 659, 784, 1047].forEach((n, i) => setTimeout(() => playTone(n, 0.3), i * 150)); }
function playClickSound() { playTone(500, 0.08, 'sine', 0.2); }
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
}

let questions = [];
let currentIndex = 0;
let score = 0;
let correctCount = 0;
let wrongCount = 0;
let answered = false;
let currentAnswer = [];
let currentWords = [];

function startPractice() {
  studentName = document.getElementById('studentName').value.trim() || 'Anonymous';
  document.getElementById('nameForm').style.display = 'none';
  document.getElementById('practiceContainer').classList.add('active');
  init();
}

function init() {
  questions = prepareQuestions();
  if (questions.length === 0) {
    document.getElementById('wordsContainer').innerHTML = '<p style="color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    return;
  }
  document.getElementById('totalNum').textContent = questions.length;
  loadQuestion();
}

function prepareQuestions() {
  const result = [];
  if (practiceData.examples && practiceData.examples.length > 0) {
    practiceData.examples.forEach(ex => {
      if (ex.en && ex.en.split(' ').length >= 3) {
        result.push({ sentence: ex.en.replace(/[.!?]$/, ''), hint: ex.th || '' });
      }
    });
  }
  if (practiceData.vocabulary && practiceData.vocabulary.length > 0) {
    practiceData.vocabulary.forEach(v => {
      if (v.example && v.example.split(' ').length >= 3) {
        result.push({ sentence: v.example.replace(/[.!?]$/, ''), hint: v.meaning || '' });
      }
    });
  }
  if (practiceData.dialogues && practiceData.dialogues.length > 0) {
    practiceData.dialogues.forEach(d => {
      if (d.text && d.text.split(' ').length >= 3) {
        result.push({ sentence: d.text.replace(/[.!?]$/, ''), hint: '' });
      }
    });
  }
  shuffleArray(result);
  return result.slice(0, 12);
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function loadQuestion() {
  if (currentIndex >= questions.length) { showResult(); return; }
  answered = false;
  currentAnswer = [];
  const q = questions[currentIndex];
  
  document.getElementById('currentNum').textContent = currentIndex + 1;
  document.getElementById('questionNumber').textContent = 'Question ' + (currentIndex + 1);
  document.getElementById('progressFill').style.width = (currentIndex / questions.length * 100) + '%';
  document.getElementById('hintText').textContent = q.hint ? 'üí° ' + q.hint : '';
  
  currentWords = q.sentence.split(' ');
  const scrambled = [...currentWords];
  shuffleArray(scrambled);
  while (scrambled.join(' ') === currentWords.join(' ') && scrambled.length > 2) {
    shuffleArray(scrambled);
  }
  
  renderWords(scrambled);
  
  const answerZone = document.getElementById('answerZone');
  answerZone.innerHTML = '<span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</span>';
  answerZone.className = 'answer-zone';
  
  document.getElementById('feedback').classList.remove('show');
  document.getElementById('feedback').className = 'feedback';
  document.getElementById('checkBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').style.display = 'none';
}

function renderWords(words) {
  const container = document.getElementById('wordsContainer');
  container.innerHTML = '';
  words.forEach((word, i) => {
    const btn = document.createElement('button');
    btn.className = 'word-token';
    btn.textContent = word;
    btn.dataset.word = word;
    btn.dataset.index = i;
    btn.addEventListener('click', function() { addWord(this); });
    container.appendChild(btn);
  });
}

function addWord(btn) {
  if (answered || btn.disabled) return;
  playClickSound();
  currentAnswer.push({ word: btn.dataset.word, btn: btn });
  btn.disabled = true;
  updateAnswerZone();
}

function removeWord(index) {
  if (answered) return;
  const removed = currentAnswer.splice(index, 1)[0];
  removed.btn.disabled = false;
  updateAnswerZone();
}

function updateAnswerZone() {
  const answerZone = document.getElementById('answerZone');
  if (currentAnswer.length === 0) {
    answerZone.innerHTML = '<span class="placeholder">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</span>';
  } else {
    answerZone.innerHTML = currentAnswer.map((item, i) => 
      '<button class="answer-token" onclick="removeWord(' + i + ')">' + item.word + '</button>'
    ).join('');
  }
}

function clearAnswer() {
  if (answered) return;
  currentAnswer.forEach(item => item.btn.disabled = false);
  currentAnswer = [];
  updateAnswerZone();
}

function checkAnswer() {
  if (answered || currentAnswer.length === 0) return;
  answered = true;
  
  const userAnswer = currentAnswer.map(a => a.word).join(' ');
  const correctAnswer = currentWords.join(' ');
  const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
  
  const answerZone = document.getElementById('answerZone');
  const feedback = document.getElementById('feedback');
  
  document.querySelectorAll('.word-token').forEach(b => b.disabled = true);
  
  if (isCorrect) {
    playCorrectSound();
    answerZone.classList.add('correct');
    feedback.innerHTML = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
    feedback.className = 'feedback show correct';
    score += 10;
    correctCount++;
  } else {
    playWrongSound();
    answerZone.classList.add('wrong');
    feedback.innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<div class="correct-answer">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: ' + correctAnswer + '</div>';
    feedback.className = 'feedback show wrong';
    wrongCount++;
  }
  
  document.getElementById('score').textContent = score;
  document.getElementById('checkBtn').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'inline-block';
}

function nextQuestion() { currentIndex++; loadQuestion(); }

function showResult() {
  playWinSound();
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('resultScreen').classList.add('active');
  
  const percent = Math.round((correctCount / questions.length) * 100);
  document.getElementById('resultScore').textContent = percent + '%';
  document.getElementById('correctCount').textContent = correctCount;
  document.getElementById('wrongCount').textContent = wrongCount;
  
  let emoji = 'üéâ', title = '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!';
  if (percent < 50) { emoji = 'üò¢'; title = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!'; }
  else if (percent < 70) { emoji = 'üòä'; title = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!'; }
  else if (percent < 90) { emoji = 'üåü'; title = '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'; }
  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultTitle').textContent = title;
  
  // Submit score
  fetch('/api/public/unscramble/' + token + '/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: studentName, score: correctCount, total: questions.length })
  });
}
</script>
</body>
</html>
