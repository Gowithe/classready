{% extends "base.html" %}
{% block title %}{{ subject.name }} - ‡∏Ñ‡∏•‡∏±‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary: #667eea;
    --secondary: #764ba2;
    --subject-color: {{ subject.color or '#667eea' }};
  }
  
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    color: #64748b;
  }
  .breadcrumb a { color: var(--primary); text-decoration: none; }
  
  .subject-header {
    background: linear-gradient(135deg, var(--subject-color), var(--secondary));
    color: white;
    padding: 2.5rem 2rem;
    border-radius: 20px;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  
  .subject-icon {
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
  }
  
  .subject-info h1 { margin: 0 0 0.5rem; font-size: 2rem; }
  .subject-info p { margin: 0; opacity: 0.9; }
  .subject-meta {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.75rem;
    font-size: 0.95rem;
    opacity: 0.9;
  }
  
  .filter-bar {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .filter-bar label { font-weight: 600; color: #64748b; font-size: 0.9rem; }
  .filter-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
  }
  .filter-btn:hover { background: #f8fafc; }
  .filter-btn.active { background: var(--subject-color); color: white; border-color: var(--subject-color); }
  
  .units-list { display: flex; flex-direction: column; gap: 1rem; }
  
  .unit-row {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.05);
    transition: all 0.2s;
  }
  .unit-row:hover { transform: translateX(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  
  .unit-number {
    width: 50px;
    height: 50px;
    background: var(--subject-color);
    color: white;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  .unit-number.free { background: #22c55e; }
  .unit-number.cloned { background: #64748b; }
  
  .unit-content { flex: 1; }
  .unit-content h3 { margin: 0 0 0.25rem; font-size: 1.1rem; color: #1e293b; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
  .unit-content p { margin: 0; font-size: 0.9rem; color: #64748b; }
  .unit-meta { display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem; color: #94a3b8; }
  
  .unit-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
  .badge-free { background: #dcfce7; color: #166534; }
  .badge-premium { background: #fef3c7; color: #92400e; }
  .badge-cloned { background: #e0e7ff; color: #4f46e5; }
  
  .unit-actions { display: flex; gap: 0.75rem; flex-shrink: 0; }
  .btn-view { padding: 0.6rem 1.25rem; background: var(--subject-color); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 0.85rem; text-decoration: none; }
  .btn-view:hover { filter: brightness(1.1); }
  .btn-open { padding: 0.6rem 1.25rem; background: #f1f5f9; color: #475569; border: none; border-radius: 10px; font-weight: 700; font-size: 0.85rem; text-decoration: none; }
  
  .premium-banner {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
    padding: 1.5rem 2rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .premium-banner h3 { margin: 0; }
  .premium-banner p { margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.9rem; }
  .btn-premium { padding: 0.75rem 1.5rem; background: white; color: #f59e0b; border: none; border-radius: 10px; font-weight: 800; text-decoration: none; }
  
  .empty-state { text-align: center; padding: 4rem; color: #64748b; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
  <a href="{{ url_for('library') }}">üìö ‡∏Ñ‡∏•‡∏±‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
  <span>‚Ä∫</span>
  <span>{{ subject.name }}</span>
</div>

<div class="subject-header">
  <div class="subject-icon">{{ subject.icon or 'üìö' }}</div>
  <div class="subject-info">
    <h1>{{ subject.name }}</h1>
    <p>{{ subject.description or '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ' + subject.name }}</p>
    <div class="subject-meta">
      <span>üìñ {{ units|length }} ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
      <span>üéÅ {{ units|selectattr('is_free', 'equalto', 1)|list|length }} ‡∏ü‡∏£‡∏µ</span>
    </div>
  </div>
</div>

{% if not is_premium %}
<div class="premium-banner">
  <div>
    <h3>üëë ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô Premium</h3>
    <p>‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!</p>
  </div>
  <a href="{{ url_for('premium_page') }}" class="btn-premium">‡∏î‡∏π‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à ‚Üí</a>
</div>
{% endif %}

<div class="filter-bar">
  <label>‡∏Å‡∏£‡∏≠‡∏á:</label>
  <button class="filter-btn active" onclick="filterUnits('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button class="filter-btn" onclick="filterUnits('free', this)">üéÅ ‡∏ü‡∏£‡∏µ</button>
  <button class="filter-btn" onclick="filterUnits('premium', this)">üëë Premium</button>
  <button class="filter-btn" onclick="filterUnits('cloned', this)">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</button>
</div>

{% if units %}
<div class="units-list" id="unitsList">
  {% for unit in units %}
  <div class="unit-row" data-free="{{ unit.is_free }}" data-cloned="{{ 1 if unit.id in user_clones else 0 }}">
    <div class="unit-number {% if unit.is_free %}free{% elif unit.id in user_clones %}cloned{% endif %}">
      {{ unit.unit_number or loop.index }}
    </div>
    <div class="unit-content">
      <h3>
        {{ unit.name }}
        {% if unit.is_free %}<span class="unit-badge badge-free">üîì ‡∏ü‡∏£‡∏µ</span>
        {% elif not is_premium %}<span class="unit-badge badge-premium">üëë Premium</span>{% endif %}
        {% if unit.id in user_clones %}<span class="unit-badge badge-cloned">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>{% endif %}
      </h3>
      <p>{{ unit.description or '' }}</p>
      <div class="unit-meta">
        <span>‚è±Ô∏è {{ unit.estimated_time }} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
        <span>üì• {{ unit.clone_count }} ‡∏Ñ‡∏£‡∏π</span>
        <span>‚≠ê {{ "%.1f"|format(unit.avg_rating or 0) }}</span>
      </div>
    </div>
    <div class="unit-actions">
      <a href="{{ url_for('library_unit_detail', unit_id=unit.id) }}" class="btn-view">‡∏î‡∏π‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Üí</a>
      {% if unit.id in user_clones %}
      <a href="{{ url_for('topic_detail', topic_id=user_clones[unit.id].topic_id) }}" class="btn-open">üìÇ ‡πÄ‡∏õ‡∏¥‡∏î</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <div class="empty-state-icon">üì≠</div>
  <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</h3>
</div>
{% endif %}

<script>
function filterUnits(type, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  document.querySelectorAll('.unit-row').forEach(row => {
    const isFree = row.dataset.free === '1';
    const isCloned = row.dataset.cloned === '1';
    let show = true;
    if (type === 'free') show = isFree;
    else if (type === 'premium') show = !isFree;
    else if (type === 'cloned') show = isCloned;
    row.style.display = show ? 'flex' : 'none';
  });
}
</script>
{% endblock %}
