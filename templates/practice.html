{% extends "base.html" %}

{% block title %}Practice - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
  .practice-form {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  .question-item {
      margin-bottom: 1.5rem;
      padding: 1.25rem;
      background: #f7fafc;
      border-radius: 6px;
      border-left: 4px solid #667eea;
  }
  .question-title {
      font-weight: 700;
      margin-bottom: 0.75rem;
  }
  .choice {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0.25rem;
  }
  .choice input { width: auto; margin: 0; }
  .results {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  .score-badge {
      font-size: 3rem;
      font-weight: 800;
      text-align: center;
      color: var(--success);
      margin-bottom: 1rem;
  }
  .feedback-item {
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      border-left: 4px solid;
  }
  .feedback-item.correct { background: #c6f6d5; border-color: var(--success); }
  .feedback-item.incorrect { background: #fed7d7; border-color: var(--danger); }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1rem;">üìù {{ topic.name }} - Practice (Multiple Choice)</h2>

<div class="card" style="margin-bottom: 1rem; padding: 14px;">
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
    <div>
      <div style="font-weight:900; margin-bottom:6px;">Practice Tools</div>
      <div style="color:#64748b; font-size:12px;">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥ + ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô PDF</div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('practice_pdf', topic_id=topic.id) }}">üìÑ Download PDF</a>
      <a class="btn" href="{{ url_for('practice_pdf', topic_id=topic.id) }}?answers=1">‚úÖ Answer PDF</a>
      <a class="btn" href="{{ url_for('practice_scores', topic_id=topic.id) }}">üìä View Student Scores</a>
    </div>
  </div>

  <div style="margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button type="button" id="btnCreateLink" style="min-width:200px;">üîó Create Student Link</button>
    <input id="studentLink" type="text" value="{{ student_url or '' }}" readonly style="flex:1; min-width:260px; margin:0;" placeholder="Student link will appear here">
    <button type="button" class="mini-copy" id="btnCopyLink" style="min-width:120px;">üìã Copy</button>
  </div>
  <div style="margin-top:6px; color:#64748b; font-size:12px;">
    ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  </div>
</div>

{% if questions|length == 0 %}
  <div class="card" style="padding:16px;">
    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ</p>
  </div>
{% else %}

<div class="practice-form" id="practice-wrap">
  <form id="practice-form">
    {% for q in questions %}
      <div class="question-item">
        <div class="question-title">{{ loop.index }}. {{ q.prompt }}</div>

        {% if q.choices %}
          {% for c in q.choices %}
            <label class="choice">
              <input type="radio" name="q{{ q.id }}" value="{{ c }}" required>
              <span>{{ c }}</span>
            </label>
          {% endfor %}
        {% else %}
          <input type="text" name="q{{ q.id }}" required placeholder="Type your answer">
        {% endif %}
      </div>
    {% endfor %}

    <button type="submit" style="width:100%; padding: 1rem; font-size: 1.1rem;">Submit & Grade</button>
  </form>
</div>

<script>
  const questions = {{ questions|tojson }};
  const topicId = {{ topic.id }};

  // Create student link
  const btnCreate = document.getElementById('btnCreateLink');
  const linkInput = document.getElementById('studentLink');
  const btnCopy = document.getElementById('btnCopyLink');

  if(btnCreate){
    btnCreate.addEventListener('click', async () => {
      btnCreate.disabled = true;
      btnCreate.textContent = '‚è≥ Creating...';
      try{
        const data = await fetchJSON(`/api/practice/${topicId}/link`, { method: 'POST' });
        if(data.url){
          linkInput.value = data.url;
          alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        }else{
          alert(data.error || '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      }catch(e){
        alert('Error: ' + (e.message || e));
      }finally{
        btnCreate.disabled = false;
        btnCreate.textContent = 'üîó Create Student Link';
      }
    });
  }

  if(btnCopy){
    btnCopy.addEventListener('click', async () => {
      const v = linkInput.value.trim();
      if(!v){
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå');
        return;
      }
      try{
        await navigator.clipboard.writeText(v);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      }catch(e){
        linkInput.select();
        document.execCommand('copy');
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      }
    });
  }

  document.getElementById('practice-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const answers = {};
    for (const q of questions) {
      const name = 'q' + q.id;
      const el = document.querySelector(`[name="${name}"]:checked`) || document.querySelector(`[name="${name}"]`);
      answers[String(q.id)] = el ? el.value : '';
    }

    try {
      const result = await fetchJSON(`/api/practice/${topicId}/submit`, {
        method: 'POST',
        body: JSON.stringify({ answers })
      });
      renderResults(result);
    } catch (err) {
      alert('Error submitting practice: ' + (err.message || err));
    }
  });

  function renderResults(result) {
    let html = `
      <div class="results">
        <div class="score-badge">${result.score}/${result.total} (${Number(result.percentage).toFixed(1)}%)</div>
        <h3 style="text-align:center; margin-bottom:1.5rem;">
          ${result.percentage >= 70 ? 'üéâ Great job!' : 'üí™ Keep practicing!'}
        </h3>
    `;

    let idx = 1;
    for (const q of questions) {
      const fb = result.feedback[String(q.id)];
      html += `
        <div class="feedback-item ${fb.is_correct ? 'correct' : 'incorrect'}">
          <strong>Q${idx}: ${q.prompt}</strong><br>
          Your answer: <strong>${fb.user_answer || '-'}</strong><br>
          Correct answer: <strong>${fb.correct_answer || '-'}</strong>
          ${fb.is_correct ? ' ‚úì' : ' ‚úó'}
        </div>
      `;
      idx++;
    }

    html += `
        <a href="/topic/${topicId}/practice" class="btn" style="display:block; text-align:center; margin-top: 1.5rem;">Try Again</a>
      </div>
    `;

    document.getElementById('practice-wrap').innerHTML = html;
  }
</script>

{% endif %}
{% endblock %}
