{% extends "base.html" %}
{% block title %}Practice - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #667eea;
  --primary-dark: #5a67d8;
  --success: #22c55e;
  --danger: #ef4444;
  --warning: #f59e0b;
  --bg-soft: #f8fafc;
  --text-main: #1e293b;
  --text-muted: #64748b;
}

body { background-color: var(--bg-soft); }

/* Navigation */
.quick-nav {
  display: flex; gap: .75rem; flex-wrap: wrap; align-items: center; margin: .75rem 0 1.5rem;
}
.nav-btn {
  display: inline-flex; align-items: center; gap: .5rem; padding: .6rem 1rem;
  border-radius: 12px; font-weight: 700; text-decoration: none; font-size: 0.95rem;
  border: 1px solid rgba(0,0,0,.08); background: #fff; color: var(--text-main);
  transition: all .15s ease; box-shadow: 0 2px 4px rgba(0,0,0,.03);
}
.nav-btn:hover {
  transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.08); border-color: var(--primary); color: var(--primary);
}
.nav-btn.active { background: #eef2ff; border-color: var(--primary); color: var(--primary); }

/* Page Header */
.page-header {
  text-align: center; margin-bottom: 2rem;
}
.page-header h2 {
  font-size: 2rem; color: var(--text-main); margin-bottom: 0.5rem;
  background: linear-gradient(135deg, var(--primary), #764ba2);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.page-header p { color: var(--text-muted); }

/* Dashboard Panel (Teacher Tools) */
.dashboard-panel {
  background: #fff; border-radius: 16px; padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,.05); margin-bottom: 2rem;
  border: 1px solid rgba(0,0,0,.04); position: relative; overflow: hidden;
}
.dashboard-panel::before {
  content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
  background: var(--primary);
}
.panel-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
.panel-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;
}
.tool-group { display: flex; flex-direction: column; gap: 0.8rem; }
.tool-label { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

/* Inputs & Buttons */
.input-group { display: flex; gap: 8px; }
.input-box {
  flex: 1; padding: 0.7rem 1rem; border-radius: 10px; border: 2px solid #e2e8f0;
  font-size: 0.95rem; color: var(--text-main); background: #f8fafc; transition: all .2s;
}
.input-box:focus { outline: none; border-color: var(--primary); background: #fff; }

.btn {
  padding: 0.7rem 1.2rem; border-radius: 10px; border: none; font-weight: 700; cursor: pointer;
  display: inline-flex; align-items: center; gap: 8px; transition: all .2s; text-decoration: none; font-size: 0.95rem;
}
.btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(102,126,234,.3); }
.btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
.btn-outline { background: #fff; border: 2px solid #e2e8f0; color: var(--text-main); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
.btn-sm { padding: 0.5rem 0.9rem; font-size: 0.85rem; }

/* Questions Form */
.practice-container { max-width: 800px; margin: 0 auto; }
.question-card {
  background: #fff; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.04);
  transition: transform .2s;
}
.question-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.06); }
.q-title { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 1rem; line-height: 1.5; }
.q-num { color: var(--primary); font-weight: 900; margin-right: 8px; }

/* Choices */
.choices-list { display: flex; flex-direction: column; gap: 0.8rem; }
.choice-label {
  display: flex; align-items: center; gap: 12px; padding: 0.8rem 1rem;
  border-radius: 10px; border: 2px solid #e2e8f0; cursor: pointer;
  transition: all .15s; background: #fff;
}
.choice-label:hover { border-color: #cbd5e1; background: #f8fafc; }
.choice-label input[type="radio"] {
  appearance: none; width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 50%;
  display: grid; place-content: center; transition: all .2s;
}
.choice-label input[type="radio"]::before {
  content: ""; width: 10px; height: 10px; border-radius: 50%; transform: scale(0);
  transition: .15s transform ease-in-out; background: var(--primary);
}
.choice-label input[type="radio"]:checked { border-color: var(--primary); }
.choice-label input[type="radio"]:checked::before { transform: scale(1); }
.choice-label:has(input:checked) { border-color: var(--primary); background: #eef2ff; }

.input-text-answer {
  width: 100%; padding: 1rem; border-radius: 10px; border: 2px solid #e2e8f0;
  font-size: 1rem; transition: border-color .2s;
}
.input-text-answer:focus { outline: none; border-color: var(--primary); }

/* Submit Button */
.submit-area { text-align: center; margin-top: 2rem; padding-bottom: 3rem; }
.btn-submit {
  background: linear-gradient(135deg, var(--primary), #764ba2);
  color: #fff; font-size: 1.2rem; padding: 1rem 3rem; border-radius: 50px;
  border: none; font-weight: 800; cursor: pointer;
  box-shadow: 0 10px 25px rgba(102,126,234,.4); transition: all .2s;
}
.btn-submit:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 35px rgba(102,126,234,.5); }

/* Results Styling */
.results-card {
  background: #fff; border-radius: 20px; padding: 2.5rem; text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,.08); max-width: 800px; margin: 0 auto;
}
.score-circle {
  width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 1.5rem;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background: linear-gradient(135deg, #e0e7ff, #eef2ff);
  border: 4px solid var(--primary); color: var(--primary);
}
.score-big { font-size: 2.5rem; font-weight: 900; line-height: 1; }
.score-total { font-size: 1rem; opacity: 0.7; font-weight: 700; }
.feedback-box { margin-top: 2rem; text-align: left; display: flex; flex-direction: column; gap: 1rem; }
.fb-item {
  padding: 1rem; border-radius: 12px; border-left: 5px solid #ccc; background: #f8fafc;
}
.fb-item.correct { border-color: var(--success); background: #f0fdf4; }
.fb-item.wrong { border-color: var(--danger); background: #fef2f2; }
.fb-icon { float: right; font-size: 1.2rem; font-weight: bold; }
.fb-ans { font-weight: 600; color: var(--text-main); margin-top: 4px; }
.fb-correct-ans { color: var(--success); font-weight: 700; font-size: 0.9rem; margin-top: 2px; }

/* Responsive */
@media (max-width: 600px) {
  .dashboard-panel { padding: 1rem; }
  .panel-grid { grid-template-columns: 1fr; }
  .btn-submit { width: 100%; }
}
</style>
{% endblock %}

{% block content %}

<div class="quick-nav">
  <a class="nav-btn" href="{{ url_for('view_slides', topic_id=topic.id) }}">üìΩÔ∏è Slides</a>
  <a class="nav-btn" href="{{ url_for('game', topic_id=topic.id) }}">üéÆ Bamboozle</a>
  <a class="nav-btn" href="{{ url_for('game_memory', topic_id=topic.id) }}">üÉè Memory</a>
  <a class="nav-btn active" href="{{ url_for('practice', topic_id=topic.id) }}">üìù Practice</a>
  <a class="nav-btn" href="{{ url_for('topic_detail', topic_id=topic.id) }}">‚Ü© Back</a>
</div>

<div class="page-header">
  <h2>{{ topic.name }}</h2>
  <p>Practice Mode (Multiple Choice)</p>
</div>

<div class="dashboard-panel">
  <div class="panel-title">üõ†Ô∏è Teacher Tools</div>
  <div class="panel-grid">
    
    <div class="tool-group">
      <div class="tool-label">Downloads & Reports</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-outline btn-sm" href="{{ url_for('practice_pdf', topic_id=topic.id) }}">
          üìÑ Questions PDF
        </a>
        <a class="btn btn-outline btn-sm" href="{{ url_for('practice_pdf', topic_id=topic.id) }}?answers=1">
          ‚úÖ Answer Key PDF
        </a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('practice_scores', topic_id=topic.id) }}">
          üìä Student Scores
        </a>
      </div>
    </div>

    <div class="tool-group">
      <div class="tool-label">Student Access Link</div>
      <div class="input-group">
        <button type="button" id="btnCreateLink" class="btn btn-primary btn-sm">üîó Generate</button>
        <input id="studentLink" class="input-box" type="text" value="{{ student_url or '' }}" readonly placeholder="Click Generate to create link...">
        <button type="button" id="btnCopyLink" class="btn btn-outline btn-sm">üìã</button>
      </div>
      <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">
        *‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Login)
      </div>
    </div>

  </div>
</div>

{% if questions|length == 0 %}
  <div class="dashboard-panel" style="text-align:center; padding:3rem;">
    <div style="font-size:3rem; margin-bottom:1rem;">üì≠</div>
    <h3 style="color:var(--text-muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ</h3>
    <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Generate AI ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
  </div>
{% else %}

<div id="practice-container" class="practice-container">
  <form id="practice-form">
    {% for q in questions %}
      <div class="question-card">
        <div class="q-title"><span class="q-num">{{ loop.index }}.</span> {{ q.prompt }}</div>

        {% if q.choices %}
          <div class="choices-list">
            {% for c in q.choices %}
              <label class="choice-label">
                <input type="radio" name="q{{ q.id }}" value="{{ c }}" required>
                <span>{{ c }}</span>
              </label>
            {% endfor %}
          </div>
        {% else %}
          <input type="text" class="input-text-answer" name="q{{ q.id }}" required placeholder="Type your answer here...">
        {% endif %}
      </div>
    {% endfor %}

    <div class="submit-area">
      <button type="submit" class="btn-submit">üöÄ Submit Answers</button>
    </div>
  </form>
</div>

<script>
  const questions = {{ questions|tojson }};
  const topicId = {{ topic.id }};

  // --- Student Link Logic ---
  const btnCreate = document.getElementById('btnCreateLink');
  const linkInput = document.getElementById('studentLink');
  const btnCopy = document.getElementById('btnCopyLink');

  if(btnCreate){
    btnCreate.addEventListener('click', async () => {
      btnCreate.disabled = true;
      btnCreate.innerHTML = '‚è≥...';
      try{
        const res = await fetch(`/api/practice/${topicId}/link`, { method:'POST' });
        const data = await res.json();
        if(data.url){
          linkInput.value = data.url;
          // Flash effect
          linkInput.style.borderColor = 'var(--success)';
          setTimeout(() => linkInput.style.borderColor = '#e2e8f0', 1000);
        }else{
          alert(data.error || 'Failed to create link');
        }
      }catch(e){
        alert('Error: ' + e);
      }finally{
        btnCreate.disabled = false;
        btnCreate.innerHTML = 'üîó Generate';
      }
    });
  }

  if(btnCopy){
    btnCopy.addEventListener('click', async () => {
      const v = linkInput.value.trim();
      if(!v){ alert('Please generate a link first.'); return; }
      try{
        await navigator.clipboard.writeText(v);
        const originalText = btnCopy.innerHTML;
        btnCopy.innerHTML = '‚úÖ';
        setTimeout(() => btnCopy.innerHTML = originalText, 1500);
      }catch(e){
        linkInput.select();
        document.execCommand('copy');
        alert('Copied!');
      }
    });
  }

  // --- Form Submission Logic ---
  document.getElementById('practice-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.querySelector('.btn-submit');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Checking...';

    const answers = {};
    for (const q of questions) {
      const name = 'q' + q.id;
      const el = document.querySelector(`[name="${name}"]:checked`) || document.querySelector(`[name="${name}"]`);
      answers[String(q.id)] = el ? el.value : '';
    }

    try {
      const res = await fetch(`/api/practice/${topicId}/submit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ answers })
      });
      const result = await res.json();
      renderResults(result);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
      alert('Error submitting practice: ' + err);
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }
  });

  function renderResults(result) {
    const percentage = Number(result.percentage).toFixed(0);
    let message = percentage >= 80 ? 'Excellent Work! üéâ' : 
                  percentage >= 50 ? 'Good Job! üëç' : 'Keep Practicing! üí™';
    
    let html = `
      <div class="results-card">
        <div class="score-circle">
          <div class="score-big">${percentage}%</div>
          <div class="score-total">${result.score} / ${result.total}</div>
        </div>
        <h2 style="color:var(--text-main); margin-bottom:0.5rem;">${message}</h2>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:1.5rem;">
          <a href="/topic/${topicId}/practice" class="btn btn-outline">üîÑ Try Again</a>
          <a href="/topic/${topicId}/practice/scores" class="btn btn-primary">üìä View All Scores</a>
        </div>
      </div>
      
      <div class="feedback-box">
        <h3 style="color:var(--text-main); padding-left:4px;">Detailed Feedback</h3>
    `;

    let idx = 1;
    for (const q of questions) {
      const fb = result.feedback[String(q.id)];
      const isCorrect = fb.is_correct;
      
      html += `
        <div class="fb-item ${isCorrect ? 'correct' : 'wrong'}">
          <span class="fb-icon">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
          <div style="margin-right:30px;">
            <div style="font-weight:700; margin-bottom:4px;">${idx}. ${q.prompt}</div>
            <div class="fb-ans">Your Answer: <span style="color:${isCorrect ? 'var(--success)' : 'var(--danger)'}">${fb.user_answer || '(No answer)'}</span></div>
            ${!isCorrect ? `<div class="fb-correct-ans">Correct Answer: ${fb.correct_answer || '-'}</div>` : ''}
          </div>
        </div>
      `;
      idx++;
    }

    html += `</div>`; // Close feedback-box

    document.getElementById('practice-container').innerHTML = html;
  }
</script>

{% endif %}
{% endblock %}
